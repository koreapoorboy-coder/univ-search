<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 목록</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px}
    h1{margin:0 0 14px}

    .search{width:100%;max-width:980px;padding:12px;border:1px solid #ccc;border-radius:10px;font-size:16px}
    .wrap{max-width:1040px}

    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin:12px 0;background:#fff}
    .name{font-weight:900;font-size:26px;margin-bottom:8px}
    .meta{opacity:.85;line-height:1.7;margin-bottom:12px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .pill{display:inline-block;border:2px solid #111;border-radius:999px;padding:8px 14px;font-weight:900;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;white-space:nowrap}
    .chip a{color:inherit;text-decoration:none}
    .chip:hover{background:#fafafa}

    .badge{font-weight:900;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:3px 8px;background:#f7f7f7}
    .ok{color:#0a7;border-color:#0a7;background:#f1fff9}
    .mid{color:#555}
    .up{color:#b86b00;border-color:#b86b00;background:#fff8ee}
    .bad{color:#b00020;border-color:#b00020;background:#fff1f3}

    .small{font-size:12px;opacity:.75;line-height:1.6}
    .btn{display:inline-block;text-decoration:none;border:2px solid #111;padding:10px 14px;border-radius:14px;font-weight:900;margin-top:8px}
    .btn:hover{background:#111;color:#fff}

    .divider{height:1px;background:#eee;margin:12px 0}
    .kline{font-size:13px;opacity:.9;line-height:1.7}
    .kline b{font-weight:900}

    /* ✅ 카드 내부 좌/우 레이아웃 */
    .cardGrid{display:grid;grid-template-columns:1fr 280px;gap:14px;align-items:start}
    @media (max-width:900px){.cardGrid{grid-template-columns:1fr}}

    .side{border:1px solid #eee;border-radius:14px;padding:12px;background:#fafafa}
    .sideTitle{font-weight:900;margin-bottom:8px}
    .sideBtns{display:flex;gap:8px;flex-wrap:wrap}
    .sideBtn{display:inline-block;text-decoration:none;border:1px solid #111;padding:8px 10px;border-radius:12px;font-weight:900;background:#fff}
    .sideBtn:hover{background:#111;color:#fff}
    .sideBtn[aria-disabled="true"]{opacity:.45;pointer-events:none}
    .sideSmall{font-size:12px;opacity:.75;line-height:1.5;margin-top:8px}

    @media (max-width:520px){
      .name{font-size:22px}
      .chip{padding:7px 10px}
      .btn{width:100%;text-align:center}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>학생 목록</h1>
    <input id="q" class="search" placeholder="검색: 학생명 / 학교 / 진로 / 전형" />
    <div id="list"></div>
  </div>

<script>
  // ---------- util ----------
  const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> { const n = Number(v); return Number.isFinite(n) ? n : null; };
  const norm = (s)=> String(s ?? '').trim().toLowerCase();

  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }

  function getProgressFields(p){
    return {
      subject: p.subject ?? p["과목"] ?? p["과목명"] ?? "-",
      term: p.term ?? p["학년학기"] ?? "",
      topic: p.topic ?? p["진도(단원/주제)"] ?? p["진도"] ?? p["topic"] ?? "-"
    };
  }

  function getNoteFields(n){
    return {
      subject: n["과목"] ?? n.subject ?? "",
      topic: n["진도"] ?? n["진도(단원/주제)"] ?? n.topic ?? "",
      status: n["평가"] ?? n.status ?? "",
      summary: n["문제요약"] ?? n["문제요약(한줄)"] ?? n.summary ?? "",
      cause: n["원인"] ?? n["원인(개념/계산/해석/시간/서술 등)"] ?? n.cause ?? ""
    };
  }

  function statusClass(status){
    const s = String(status||"").trim();
    if (!s) return "mid";
    if (s.includes("잘")) return "ok";
    if (s.includes("보통")) return "mid";
    if (s.includes("보완")) return "bad";
    if (s.includes("위험")) return "bad";
    return "up";
  }

  function subjectsAttempted(scoreRec){
    // 점수키에서 실제 응시 과목만 뽑기(학생별 다를 수 있음)
    const out = [];
    for (const k of Object.keys(scoreRec||{})){
      if (k==="id"||k==="round"||k==="date") continue;
      if (k.endsWith("컷")) continue;
      if (k.endsWith("백분위")) continue;
      if (k==="영어등급") continue;
      const v = num(scoreRec[k]);
      if (v==null) continue;
      out.push(k);
    }
    // 보기 좋게 주요 과목 우선
    const priority = ["국어","수학","영어","사문","생윤"];
    const ordered = [];
    for (const p of priority) if (out.includes(p)) ordered.push(p);
    for (const x of out) if (!ordered.includes(x)) ordered.push(x);
    return ordered;
  }

  function cutPassedCount(scoreRec, subs){
    let pass=0, total=0;
    for (const s of subs){
      const sc = num(scoreRec?.[s]);
      const cut = num(scoreRec?.[s+"컷"]);
      if (sc==null || cut==null) continue;
      total++;
      if (sc >= cut) pass++;
    }
    return {pass,total};
  }

  // ---------- 정시(백분위+영어등급) 계산 ----------
  const UP_MARGIN = 5.0;

  function getEnglishGrade(scoreRec){
    const g = num(scoreRec?.["영어등급"]);
    return g==null ? null : g;
  }

  function getPct(scoreRec, subject){
    const key1 = subject + "백분위";
    const key2 = subject + " 백분위";
    const v = scoreRec?.[key1] ?? scoreRec?.[key2];
    const p = num(v);
    return p;
  }

  function 탐구Candidates(scoreRec){
    // "탐구2"용 후보(백분위가 있는 과목 중 국/수/영 제외)
    const out = [];
    for (const k of Object.keys(scoreRec||{})){
      if (!k.endsWith("백분위") && !k.endsWith(" 백분위")) continue;
      const base = k.replace("백분위","").replace(" 백분위","").trim();
      if (base==="국어"||base==="수학"||base==="영어") continue;
      const v = num(scoreRec[k]);
      if (v!=null) out.push({subject: base, pct: v});
    }
    out.sort((a,b)=>b.pct-a.pct);
    return out;
  }

  function computeStudentAvgPct(scoreRec, ruleSubjects){
    const used = [];
    for (const raw of (ruleSubjects||[])){
      const t = String(raw||"").trim();
      if (!t) continue;

      if (t==="탐구2" || t==="탐구"){
        const cand = 탐구Candidates(scoreRec);
        if (cand.length < 2) return {ok:false};
        used.push(cand[0], cand[1]);
        continue;
      }
      if (t==="영어"){
        // 영어는 등급조건으로만 (평균 제외)
        continue;
      }
      const p = getPct(scoreRec, t);
      if (p==null) return {ok:false};
      used.push({subject:t, pct:p});
    }
    if (!used.length) return {ok:false};
    const avg = used.reduce((a,x)=>a+x.pct,0)/used.length;
    return {ok:true, avg};
  }

  function computeUnivCounts(univs, scoreRec){
    if (!Array.isArray(univs) || !univs.length) return null;

    const eng = getEnglishGrade(scoreRec);
    const hasAnyPct = Object.keys(scoreRec||{}).some(k => String(k).includes("백분위"));
    if (!hasAnyPct) return {fit:null, up:null, reason:"백분위 없음"};
    // 영어등급이 없으면 영어컷 있는 대학은 자동 제외되므로 계산은 가능

    let fit=0, up=0, usable=0;
    for (const u of univs){
      const cut = num(u.cut_pct);
      if (cut==null) continue;

      // 영어컷
      const engMax = num(u.eng_max_grade);
      if (engMax!=null){
        if (eng==null) continue;
        if (eng > engMax) continue;
      }

      const calc = computeStudentAvgPct(scoreRec, u.rule?.subjects || []);
      if (!calc.ok) continue;

      usable++;
      const diff = calc.avg - cut;
      if (diff >= 0) fit++;
      else if (diff >= -UP_MARGIN) up++;
    }
    return {fit, up, usable};
  }

  function renderUnivSide(id, round, scoreRec){
    const sid = encodeURIComponent(id);
    const r = (round!=null) ? encodeURIComponent(String(round)) : "";

    const fitUrl = `./univ_list.html?id=${sid}&bucket=fit${r?`&round=${r}`:""}`;
    const upUrl  = `./univ_list.html?id=${sid}&bucket=up${r?`&round=${r}`:""}`;

    if (!univs || !Array.isArray(univs) || !univs.length){
      return `
        <div class="sideBtns">
          <a class="sideBtn" aria-disabled="true">적정</a>
          <a class="sideBtn" aria-disabled="true">상향</a>
        </div>
        <div class="sideSmall">univ_percentile.json 없음/비어있음</div>
      `;
    }

    if (!scoreRec){
      return `
        <div class="sideBtns">
          <a class="sideBtn" aria-disabled="true">적정</a>
          <a class="sideBtn" aria-disabled="true">상향</a>
        </div>
        <div class="sideSmall">점수 데이터 없음</div>
      `;
    }

    const counts = computeUnivCounts(univs, scoreRec);
    if (!counts || counts.fit===null){
      return `
        <div class="sideBtns">
          <a class="sideBtn" href="${fitUrl}" target="_blank" rel="noopener">적정</a>
          <a class="sideBtn" href="${upUrl}" target="_blank" rel="noopener">상향</a>
        </div>
        <div class="sideSmall">백분위 데이터가 없어서 개수 계산은 불가<br/>버튼 클릭은 가능</div>
      `;
    }

    return `
      <div class="sideBtns">
        <a class="sideBtn" href="${fitUrl}" target="_blank" rel="noopener">적정 (${counts.fit})</a>
        <a class="sideBtn" href="${upUrl}" target="_blank" rel="noopener">상향 (${counts.up})</a>
      </div>
      <div class="sideSmall">
        기준: 백분위 평균 + 영어등급 컷<br/>
        (해당 회차: #${esc(round ?? "-")})
      </div>
    `;
  }

  // ---------- data ----------
  let students=[], scores=[], progress=[], notes=[], univs=null;
  let latestById = new Map(); // id -> latest score record

  async function init(){
    // cache no-store to see updates immediately
    const [st, sc, pr, nt, uv] = await Promise.all([
      fetch("./students.json",{cache:"no-store"}).then(r=>r.json()),
      fetch("./scores.json",{cache:"no-store"}).then(r=>r.json()),
      fetch("./progress.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>[]),
      fetch("./progress_notes.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>[]),
      fetch("./univ_percentile.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>null),
    ]);

    students = Array.isArray(st)? st: [];
    scores = Array.isArray(sc)? sc: [];
    progress = Array.isArray(pr)? pr: [];
    notes = Array.isArray(nt)? nt: [];
    univs = Array.isArray(uv)? uv: null;

    // latest score per id
    const grouped = new Map();
    for (const r of scores){
      const id = r.id;
      if (!id) continue;
      if (!grouped.has(id)) grouped.set(id, []);
      grouped.get(id).push(r);
    }
    for (const [id, arr] of grouped){
      arr.sort((a,b)=>(num(a.round)||0)-(num(b.round)||0));
      latestById.set(id, arr[arr.length-1]);
    }

    render("");
    document.getElementById("q").addEventListener("input", (e)=>render(e.target.value.trim()));
  }

  function findNote(id, round, subject, topic){
    const sKey = norm(subject);
    const tKey = norm(topic);

    const cand = notes.filter(n => String(n.id)===String(id) && String(n.round)===String(round));
    if (!cand.length) return null;

    for (const n of cand){
      const f = getNoteFields(n);
      if (norm(f.subject)===sKey && (norm(f.topic)===tKey || norm(f.topic).includes(tKey) || tKey.includes(norm(f.topic)))) {
        return n;
      }
    }
    for (const n of cand){
      const f = getNoteFields(n);
      if (norm(f.subject)===sKey) return n;
    }
    return null;
  }

  function render(keyword){
    const list = document.getElementById("list");
    const k = norm(keyword);

    const items = students.filter(s => {
      const name = pickName(s);
      const hay = `${s.school||''} ${name||''} ${s.career||''} ${s.admission||''} ${s.id||''}`.toLowerCase();
      return !k || hay.includes(k);
    });

    list.innerHTML = items.map(s => renderCard(s)).join('') || `<div class="small" style="margin-top:12px">검색 결과가 없습니다.</div>`;
  }

  function renderCard(s){
    const id = s.id;
    const name = pickName(s);
    const last = latestById.get(id);

    // 최신 회차/컷 통과/응시 과목
    let lastLine = `<span class="small">점수 데이터 없음</span>`;
    let round = null;

    let subjChips = `<span class="small">응시 과목 없음</span>`;
    if (last){
      round = num(last.round);
      const subs = subjectsAttempted(last);
      const pass = cutPassedCount(last, subs);
      lastLine = `<span class="small">최근 점수: <b>#${esc(round ?? "-")}</b> (${esc(last.date||"-")}) · 컷 통과 <b>${pass.pass}/${pass.total || "-"}</b></span>`;
      subjChips = subs.map(x=>`<span class="chip">${esc(x)}</span>`).join("");
    }

    // 이번 주 진도(= 최신 round 기준)
    let progHTML = `<span class="small">이번 회차 진도 없음</span>`;
    let progHint = `<span class="small">progress.json에 id+round별 진도를 넣으면 표시됩니다.</span>`;
    let noteSummaryLines = "";

    if (round != null){
      const pList = progress.filter(p => String(p.id)===String(id) && String(p.round)===String(round));

      if (pList.length){
        progHint = `<span class="small">진도 칩을 누르면 새 창(progress_detail.html)에서 상세를 봅니다.</span>`;

        // 칩 + 평가 배지 표시
        progHTML = pList.map(p=>{
          const f = getProgressFields(p);
          const n = findNote(id, round, f.subject, f.topic);
          const nf = n ? getNoteFields(n) : null;
          const st = nf?.status || "";
          const cls = statusClass(st);

          const url = `./progress_detail.html?id=${encodeURIComponent(id)}&round=${encodeURIComponent(String(round))}&subject=${encodeURIComponent(f.subject)}&topic=${encodeURIComponent(f.topic)}`;

          return `
            <span class="chip">
              ${st ? `<span class="badge ${cls}">${esc(st)}</span>` : `<span class="badge mid">미평가</span>`}
              <a href="${esc(url)}" target="_blank" rel="noopener">
                ${esc(f.subject)}${f.term?`(${esc(f.term)})`:``}: ${esc(f.topic)}
              </a>
            </span>
          `;
        }).join("");

        // 카드 안에 "어디가 문제인지" 요약(최대 2개)
        const sumLines = [];
        for (const p of pList){
          const f = getProgressFields(p);
          const n = findNote(id, round, f.subject, f.topic);
          if (!n) continue;
          const nf = getNoteFields(n);
          if (!nf.status) continue;

          const cls = statusClass(nf.status);
          const headline = `${nf.status} · ${f.subject}: ${f.topic}`;
          const detail = `${nf.summary ? `문제: ${nf.summary}` : ''}${nf.cause ? (nf.summary? ` / ` : '') + `원인: ${nf.cause}` : ''}`.trim();

          if (detail){
            sumLines.push(`<div class="kline"><b class="${cls}">${esc(headline)}</b><br/>${esc(detail)}</div>`);
          }else{
            sumLines.push(`<div class="kline"><b class="${cls}">${esc(headline)}</b></div>`);
          }
          if (sumLines.length>=2) break;
        }
        if (sumLines.length){
          noteSummaryLines = `<div class="divider"></div>${sumLines.join("")}`;
        }
      }
    }

    // ✅ 우측 대학 패널
    const sideHTML = renderUnivSide(id, round, last);

    return `
      <div class="card">
        <div class="cardGrid">

          <!-- 왼쪽 -->
          <div>
            <div class="name">${esc(name)}</div>
            <div class="meta">
              학교: ${esc(s.school || '-')}<br/>
              진로: ${esc(s.career || '-')}<br/>
              전형: ${esc(s.admission || '-')}<br/>
              ${lastLine}
            </div>

            <div class="row">
              <span class="pill">이번 주 진도</span>
              <div class="row" style="margin:0">${progHTML}</div>
            </div>
            <div>${progHint}</div>
            ${noteSummaryLines}

            <div class="row" style="margin-top:14px">
              <span class="pill">응시 과목</span>
              <div class="row" style="margin:0">${subjChips}</div>
            </div>

            <a class="btn" href="./student.html?id=${encodeURIComponent(id)}">성적/그래프/진도 보기</a>
          </div>

          <!-- 오른쪽 -->
          <div class="side">
            <div class="sideTitle">정시 대학</div>
            ${sideHTML}
          </div>

        </div>
      </div>
    `;
  }

  init().catch(()=>{
    document.getElementById('list').textContent =
      '데이터 로딩 실패 (students.json / scores.json / progress.json / progress_notes.json 확인)';
  });
</script>
</body>
</html>
