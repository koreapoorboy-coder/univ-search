
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>정시 대학 상세</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px}
    .wrap{max-width:920px}
    h1{margin:0 0 8px;font-size:22px}
    .meta{opacity:.85;line-height:1.7}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    .k{font-weight:900}
    .pre{white-space:pre-wrap;line-height:1.7}
    a.btn{display:inline-block;text-decoration:none;border:1px solid #111;padding:8px 10px;border-radius:10px;margin-right:8px}
    .ok{color:#0a7;font-weight:900}
    .warn{color:#b86b00;font-weight:900}
  </style>
</head>
<body>
<div class="wrap">
  <h1 id="h">로딩중…</h1>
  <div class="meta" id="meta"></div>

  <div class="card">
    <div class="k">계산 근거</div>
    <div class="pre" id="calc">로딩중…</div>
  </div>

  <div class="card">
    <div class="k">이동</div>
    <a class="btn" id="toStudent" href="./student.html">학생 상세</a>
    <a class="btn" id="toIndex" href="./index.html">목록</a>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const id = qs.get("id") || "";
  const round = qs.get("round") || "";
  const univ = (qs.get("univ") || "").trim();
  const major = (qs.get("major") || "").trim();

  const UP_MARGIN = 5.0;

  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );
  const num = (v)=> {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };
  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }
  function getPct(rec, subject){
    const key = subject + "백분위";
    const v = rec?.[key];
    const n = num(v);
    return n;
  }
  function getEnglishGrade(rec){
    const n = num(rec?.["영어등급"]);
    return n == null ? null : n;
  }
  function 탐구Candidates(rec){
    const out = [];
    for (const k of Object.keys(rec||{})){
      if (!k.endsWith("백분위")) continue;
      const base = k.replace("백분위","");
      if (base === "국어" || base === "수학") continue;
      if (base === "영어") continue;
      const v = num(rec[k]);
      if (v != null) out.push({subject: base, pct: v});
    }
    out.sort((a,b)=>b.pct - a.pct);
    return out;
  }

  function computeStudentAvgPct(scoreRec, ruleSubjects){
    const used = [];
    const details = [];

    for (const s of ruleSubjects){
      const t = (s||"").trim();
      if (!t) continue;

      if (t === "탐구2" || t === "탐구"){
        const cand = 탐구Candidates(scoreRec);
        if (cand.length < 2) return { ok:false, reason:"탐구 2과목 백분위가 부족" };
        used.push(cand[0], cand[1]);
        details.push(`탐구2 선택: ${cand[0].subject}=${cand[0].pct}, ${cand[1].subject}=${cand[1].pct}`);
        continue;
      }

      if (t === "영어"){
        continue;
      }

      const p = getPct(scoreRec, t);
      if (p == null) return { ok:false, reason:`${t} 백분위 없음` };
      used.push({subject:t, pct:p});
      details.push(`${t}=${p}`);
    }

    if (!used.length) return { ok:false, reason:"평균 계산 과목이 없음" };
    const avg = used.reduce((a,x)=>a+x.pct,0) / used.length;
    return { ok:true, avg, used, details };
  }

  function classify(avg, cut){
    const diff = avg - cut;
    if (diff >= 0) return {bucket:"fit", diff};
    if (diff >= -UP_MARGIN) return {bucket:"up", diff};
    return {bucket:"none", diff};
  }

  async function main(){
    const [students, scores, univs] = await Promise.all([
      fetch("./students.json",{cache:"no-store"}).then(r=>r.json()),
      fetch("./scores.json",{cache:"no-store"}).then(r=>r.json()),
      fetch("./univ_percentile.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>[])
    ]);

    const st = (students||[]).find(x=>x.id===id) || null;
    const myScores = (scores||[]).filter(x=>x.id===id).sort((a,b)=>(num(a.round)||0)-(num(b.round)||0));
    if (!myScores.length) throw new Error("scores.json에 학생 점수 없음");

    const scoreRec = round ? (myScores.find(x=>String(x.round)===String(round)) || myScores[myScores.length-1]) : myScores[myScores.length-1];
    const eng = getEnglishGrade(scoreRec);

    const u = (univs||[]).find(x => String(x.univ||"").trim()===univ && String(x.major||"").trim()===major);
    if (!u) throw new Error("univ_percentile.json에서 해당 대학/학과를 찾을 수 없음");

    const cut = num(u.cut_pct);
    const subs = u.rule?.subjects || [];
    const calc = computeStudentAvgPct(scoreRec, subs);
    if (!calc.ok) throw new Error(calc.reason);

    const engMax = num(u.eng_max_grade);
    let engOk = true;
    if (engMax!=null){
      engOk = (eng!=null && eng <= engMax);
    }

    const cls = classify(calc.avg, cut);
    const bucketLabel = cls.bucket==="fit" ? `<span class="ok">적정</span>` : (cls.bucket==="up" ? `<span class="warn">상향</span>` : `제외`);
    const diffTxt = (cls.diff>=0?"+":"") + cls.diff.toFixed(2);

    document.getElementById("h").innerHTML = `${bucketLabel} ${esc(u.univ)} · ${esc(u.major)}`;
    document.getElementById("meta").innerHTML = `
      학생: <b>${esc(st ? pickName(st) : id)}</b> · 회차: <b>#${esc(scoreRec.round ?? "")}</b> (${esc(scoreRec.date ?? "")})<br/>
      컷(평균 백분위): <b>${esc(u.cut_pct)}</b> / 내 평균: <b>${calc.avg.toFixed(2)}</b> / 차이: <b>${diffTxt}</b><br/>
      영어등급: <b>${eng!=null ? esc(eng) : "-"}</b> / 영어컷: <b>${engMax!=null ? ("≤ "+esc(engMax)) : "없음"}</b>
      ${engMax!=null ? (engOk ? " (통과)" : " (미통과)") : ""}
    `;

    const lines = [];
    lines.push(`반영 과목(백분위 평균): ${subs.join(", ") || "-"}`);
    lines.push(`사용된 값:`);
    for (const d of calc.details || []) lines.push(`- ${d}`);
    lines.push(``);
    lines.push(`평균 백분위 = (사용된 백분위 합) / (개수)`);
    lines.push(`= ${calc.used.map(x=>x.pct).join(" + ")} / ${calc.used.length}`);
    lines.push(`= ${calc.avg.toFixed(2)}`);
    lines.push(``);
    lines.push(`판정 규칙(영어 통과 전제):`);
    lines.push(`- 적정: 평균 ≥ 컷`);
    lines.push(`- 상향: 컷-5 ≤ 평균 < 컷`);
    lines.push(`- 그 외: 제외`);
    if (engMax!=null){
      lines.push(``);
      lines.push(`영어 등급 조건: 영어등급 ≤ ${engMax}`);
      lines.push(`현재 영어등급: ${eng!=null ? eng : "-"}`);
    }

    document.getElementById("calc").textContent = lines.join("\n");
    document.getElementById("toStudent").href = `./student.html?id=${encodeURIComponent(id)}`;
  }

  main().catch(err=>{
    document.getElementById("h").textContent = "로드 실패";
    document.getElementById("meta").textContent = String(err);
    document.getElementById("calc").textContent = "";
  });
</script>
</body>
</html>
