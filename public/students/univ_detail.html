<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>대학 근거 상세</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px}
    .wrap{max-width:980px}
    .card{border:1px solid #ddd;border-radius:16px;padding:16px;background:#fff}
    h1{margin:0 0 10px}
    .small{font-size:12px;opacity:.75;line-height:1.6}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{font-weight:900;background:#fafafa}
    .ok{color:#0a7;font-weight:900}
    .bad{color:#b00020;font-weight:900}
    .btn{display:inline-block;text-decoration:none;border:2px solid #111;padding:10px 14px;border-radius:14px;font-weight:900;background:#fff;margin-top:12px}
    .btn:hover{background:#111;color:#fff}
    .box{border:1px solid #eee;border-radius:14px;padding:12px;background:#fafafa;line-height:1.8;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="h">로딩중…</h1>
    <div class="small" id="sub"></div>

    <table id="tbl"></table>

    <div class="box" id="summary"></div>

    <a class="btn" id="backBtn" href="#">목록으로</a>
    <a class="btn" href="javascript:window.close()">창 닫기</a>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const studentId = qs.get("id")||"";
  const token = qs.get("t")||"";
  const idx = Number(qs.get("idx")||"-1");
  const bucket = (qs.get("bucket")||"").toLowerCase();
  const roundParam = qs.get("round");

  const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> { const n = Number(v); return Number.isFinite(n) ? n : null; };

  async function fetchJSON(path){
    const r = await fetch(path,{cache:"no-store"});
    if(!r.ok) throw new Error("fetch fail "+path);
    return await r.json();
  }

  async function requireAuth(){
    if(!studentId || !token){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2>";
      throw new Error("unauthorized");
    }
    const students = await fetchJSON("./students.json");
    const st = (students||[]).find(x=>x.id===studentId);
    if(!st || String(st.token||"") !== String(token)){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2>";
      throw new Error("unauthorized");
    }
    return st;
  }

  function getStudentMetrics(scoreRec){
    const out = {
      국어: scoreRec?.["국어백분위"] ?? scoreRec?.["국어(백분위)"] ?? null,
      수학: scoreRec?.["수학백분위"] ?? scoreRec?.["수학(백분위)"] ?? null,
      사문: scoreRec?.["사문백분위"] ?? scoreRec?.["사회문화백분위"] ?? null,
      생윤: scoreRec?.["생윤백분위"] ?? scoreRec?.["생활과윤리백분위"] ?? null,
      영어등급: scoreRec?.["영어등급"] ?? scoreRec?.["영어(등급)"] ?? null
    };
    for(const k of ["국어","수학","사문","생윤"]) out[k] = num(out[k]);
    out.영어등급 = num(out.영어등급);
    return out;
  }

  function getCut(item){
    return {
      univ: item.univ ?? item.university ?? item["대학"] ?? item["대학명"] ?? item["학교"] ?? "-",
      major: item.major ?? item.dept ?? item["학과"] ?? item["전공"] ?? "-",
      cut: {
        국어: num(item["국어"] ?? item["국어백분위"] ?? item["국어(백분위)"]),
        수학: num(item["수학"] ?? item["수학백분위"] ?? item["수학(백분위)"]),
        사문: num(item["사문"] ?? item["사문백분위"] ?? item["사회문화"] ?? item["사회문화백분위"]),
        생윤: num(item["생윤"] ?? item["생윤백분위"] ?? item["생활과윤리"] ?? item["생활과윤리백분위"]),
        영어등급: num(item["영어등급"] ?? item["영어(등급)"])
      }
    };
  }

  function rowPct(name, s, c){
    if(c==null) return "";
    if(s==null) return `<tr><th>${esc(name)}(백분위)</th><td>학생 데이터 없음</td><td>${esc(c)}</td><td class="bad">비교 불가</td></tr>`;
    const ok = s>=c;
    const diff = (s-c).toFixed(1);
    return `<tr><th>${esc(name)}(백분위)</th><td>${esc(s)}</td><td>${esc(c)}</td><td class="${ok?'ok':'bad'}">${ok?'통과':'미달'} (${ok?'+':''}${diff})</td></tr>`;
  }
  function rowEng(s, c){
    if(c==null) return "";
    if(s==null) return `<tr><th>영어(등급)</th><td>학생 데이터 없음</td><td>${esc(c)}등급 이하</td><td class="bad">비교 불가</td></tr>`;
    const ok = s<=c;
    const diff = c - s;
    return `<tr><th>영어(등급)</th><td>${esc(s)}등급</td><td>${esc(c)}등급 이하</td><td class="${ok?'ok':'bad'}">${ok?'통과':'미달'} (여유 ${ok?'+':''}${diff})</td></tr>`;
  }

  async function main(){
    const st = await requireAuth();

    const [scores, univs] = await Promise.all([
      fetchJSON("./scores.json"),
      fetchJSON("./univ_percentile.json").catch(()=>[])
    ]);

    const myScores = (scores||[]).filter(x=>x.id===studentId).sort((a,b)=>(num(a.round)||0)-(num(b.round)||0));
    const current = roundParam
      ? (myScores.find(x=>String(x.round)===String(roundParam)) || myScores[myScores.length-1])
      : myScores[myScores.length-1];

    const student = getStudentMetrics(current||{});

    const item = (univs||[])[idx];
    if(!item){
      document.getElementById("h").textContent = "대학 데이터를 찾지 못했습니다.";
      document.getElementById("tbl").innerHTML = "";
      document.getElementById("summary").textContent = "univ_percentile.json의 idx가 유효한지 확인해 주세요.";
      return;
    }

    const c = getCut(item);
    document.getElementById("h").textContent = `${esc(c.univ)} · ${esc(c.major)} (근거 상세)`;
    document.getElementById("sub").innerHTML =
      `학생: <b>${esc(st.studentname||st.studentName||st.name||st.id||"-")}</b> · 회차: <b>#${esc(current?.round ?? "-")}</b><br/>
       기준: 국/수/탐=백분위(↑), 영어=등급(↓)`;

    let html = `<tr><th>과목</th><th>학생</th><th>대학 컷</th><th>판정</th></tr>`;
    html += rowPct("국어", student.국어, c.cut.국어);
    html += rowPct("수학", student.수학, c.cut.수학);
    html += rowPct("사문", student.사문, c.cut.사문);
    html += rowPct("생윤", student.생윤, c.cut.생윤);
    html += rowEng(student.영어등급, c.cut.영어등급);

    document.getElementById("tbl").innerHTML = html;

    // 요약
    const fails=[];
    for(const k of ["국어","수학","사문","생윤"]){
      if(c.cut[k]==null) continue;
      if(student[k]==null) fails.push(`${k}: 학생 백분위 없음`);
      else if(student[k] < c.cut[k]) fails.push(`${k}: ${student[k]} < ${c.cut[k]}`);
    }
    if(c.cut.영어등급!=null){
      if(student.영어등급==null) fails.push(`영어: 학생 등급 없음`);
      else if(student.영어등급 > c.cut.영어등급) fails.push(`영어: ${student.영어등급} > ${c.cut.영어등급}`);
    }

    document.getElementById("summary").innerHTML = fails.length
      ? `<b>미달/주의 포인트</b><br/>${fails.map(x=>`- ${esc(x)}`).join("<br/>")}`
      : `<b>컷 기준 통과</b><br/>전체 기준을 통과했습니다. (여유/근접 여부는 목록에서 확인)`;

    // 목록으로
    const backBucket = (qs.get("fromBucket")||"") || ""; // 있으면 우선
    const guessBucket = backBucket || (bucket ? bucket : "fit");
    document.getElementById("backBtn").href =
      `./univ_list.html?id=${encodeURIComponent(studentId)}&t=${encodeURIComponent(token)}&bucket=${encodeURIComponent(guessBucket)}${roundParam?`&round=${encodeURIComponent(roundParam)}`:""}`;
  }

  main().catch(()=>{});
</script>
</body>
</html>
