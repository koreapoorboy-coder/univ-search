<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>대학 상향/적정</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px;background:#fff;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:14px 0;background:#fff}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .meta{opacity:.85;line-height:1.7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .badge{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:800;background:#fff}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none;color:#111;background:#fff}
    .btn:hover{background:#fafafa}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    .tablebox{border:1px solid #eee;border-radius:14px;padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
    table{border-collapse:collapse;width:100%;min-width:680px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px;white-space:nowrap}
    th{background:#fafafa;font-weight:900;position:sticky;top:0}
    .num{text-align:right}

    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">대학 상향/적정 <span class="badge muted">v2026-02-10</span></div>
    <div class="meta" id="meta"></div>
    <div class="row" id="modeRow"></div>
    <div class="row" id="navRow"></div>
    <div id="debugBox" style="display:none;margin-top:10px;"></div>
  </div>

  <div id="content"></div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const LS_KEY = "__ADMIN_TOKEN__";

  const qs = new URLSearchParams(location.search);
  const debug = qs.get("debug") === "1";

  const norm = (v) => String(v ?? "").trim();

  const adminParam = qs.get("admin");
  const adminSaved = localStorage.getItem(LS_KEY);
  const admin = adminParam || adminSaved;

  const idParam = qs.get("id");
  const tParam = qs.get("t") || qs.get("token");

  const isAdmin = (norm(admin) === norm(ADMIN_TOKEN));
  if (adminParam && isAdmin) localStorage.setItem(LS_KEY, adminParam);

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null; }
  function pickToken(s){ return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null; }

  function showDenied(extra){
    $("#hdr").innerHTML = `접근 권한이 없습니다. <span class="badge muted">v2026-02-10</span>`;
    $("#meta").innerHTML = `
      <div class="warn">학생을 찾을 수 없습니다.</div>
      <div class="muted">관리자: univ_list.html?id=학생ID&admin=관리자토큰 / 학생: univ_list.html?t=개별토큰</div>
      ${extra || ""}
    `;
  }

  function renderDebug(obj){
    if(!debug) return;
    const box = $("#debugBox");
    box.style.display = "block";
    box.innerHTML = `<div class="badge">DEBUG ON</div><pre>${esc(JSON.stringify(obj, null, 2))}</pre>`;
  }

  // ✅ 대학 데이터는 형식이 사람마다 다를 수 있어서 “그냥 표로 보여주는” 안전 모드
  function toArray(x){
    if(Array.isArray(x)) return x;
    if(x && typeof x === "object") return Object.values(x);
    return [];
  }
  function getCols(arr){
    const keys = new Set();
    arr.slice(0, 50).forEach(o=>{
      if(o && typeof o === "object") Object.keys(o).forEach(k=>keys.add(k));
    });
    return [...keys];
  }

  async function main(){
    // 1) students.json 로딩
    let students = [];
    try{
      students = await loadJson("./students.json");
      if(!Array.isArray(students)) throw new Error("students.json is not an array");
    }catch(e){
      renderDebug({ step:"load students.json failed", error:e.message, url:location.href });
      showDenied(`<div class="warn">students.json 로딩 실패: ${esc(e.message)}</div>`);
      return;
    }

    // 2) student 찾기(✅ admin+id 또는 t)
    let student = null;

    if(isAdmin && idParam){
      student = students.find(s => norm(pickId(s)) === norm(idParam));
    }
    if(!student && tParam){
      student = students.find(s => norm(pickToken(s)) === norm(tParam));
    }

    renderDebug({
      url: location.href,
      adminParam,
      adminSaved,
      adminUsed: admin,
      ADMIN_TOKEN,
      isAdmin,
      idParam,
      tParam,
      studentsCount: students.length,
      sampleIds: students.slice(0,5).map(s=>pickId(s)),
      studentFound: !!student,
      studentId: student ? pickId(student) : null
    });

    if(!student){
      showDenied();
      return;
    }

    const sid = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").innerHTML = `대학 상향/적정 · ${esc(name)}${sid ? " ("+esc(sid)+")" : ""} <span class="badge muted">v2026-02-10</span>`;
    $("#meta").innerHTML = `
      학교: ${esc(student.school||"-")}<br>
      진로: ${esc(student.career||"-")}<br>
      전형: ${esc(student.admission||"-")}
    `;

    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    // 3) 네비 버튼
    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;

    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 학생 상세로</a>`);
    if(isAdmin) nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    $("#navRow").innerHTML = nav.join("");

    // 4) univ_percentile.json 로딩(일단 표로 “무조건 표시”)
    let raw = null;
    try{
      raw = await loadJson("./univ_percentile.json");
    }catch(e){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">univ_percentile.json 로딩 실패</div>
          <div class="muted">${esc(e.message)}</div>
        </div>
      `;
      return;
    }

    const arr = toArray(raw);
    if(!arr.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">대학 데이터가 비어있습니다.</div>
          <div class="muted">univ_percentile.json 내용이 배열/객체인지 확인하세요.</div>
        </div>
      `;
      return;
    }

    const cols = getCols(arr);
    const thead = cols.map(c=>`<th>${esc(c)}</th>`).join("");
    const rows = arr.slice(0, 200).map(o=>{
      const tds = cols.map(c=>`<td>${esc(o?.[c])}</td>`).join("");
      return `<tr>${tds}</tr>`;
    }).join("");

    $("#content").innerHTML = `
      <div class="card">
        <div class="row">
          <span class="badge">대학 데이터 로드 OK</span>
          <span class="badge muted">표시: ${Math.min(arr.length,200)} / ${arr.length}</span>
        </div>
        <div class="muted">현재는 “접근/연동 확인용 표”로 보여주고, 다음 단계에서 상향/적정 로직을 붙이면 됩니다.</div>
      </div>
      <div class="card tablebox">
        <table>
          <thead><tr>${thead}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  main().catch(err=>{
    $("#hdr").innerHTML = `오류 <span class="badge muted">v2026-02-10</span>`;
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
    renderDebug({ step:"fatal", error: err.message, url: location.href });
  });
})();
</script>
</body>
</html>
