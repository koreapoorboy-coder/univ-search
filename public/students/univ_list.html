<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>대학 상향/적정</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px;background:#fff;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:14px 0;background:#fff}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .meta{opacity:.85;line-height:1.7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .badge{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:800;background:#fff}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none;color:#111;background:#fff}
    .btn:hover{background:#fafafa}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    input, select{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:700;
      width:min(340px, 100%);
    }
    label.toggle{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:800;
      user-select:none;
    }
    label.toggle input{width:auto}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #111;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:900}
    .tab[aria-selected="true"]{background:#111;color:#fff}

    /* PC 표 */
    .tablebox{border:1px solid #eee;border-radius:14px;padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
    table{border-collapse:collapse;width:100%;min-width:980px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px;white-space:nowrap;vertical-align:top}
    th{background:#fafafa;font-weight:900;position:sticky;top:0}
    .num{text-align:right}

    .status{font-weight:900}
    .st-fit{color:#0b57d0}   /* 적정 */
    .st-up{color:#b26a00}    /* 상향 */
    .st-na{color:#666}

    /* 과목칩 */
    .chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;gap:6px;align-items:center;
      border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;font-weight:900;
      font-size:13px;
    }
    .chip .k{opacity:.7;font-weight:900}
    .chip .v{font-weight:900}
    .chip.ok{border-color:#0b57d0}
    .chip.ng{border-color:#b26a00}
    .chip.na{border-color:#ddd;opacity:.7}
    .chip .d{opacity:.7;font-weight:800}

    /* ✅ 모바일 카드 리스트 */
    .mobile-list{display:none; gap:12px; flex-direction:column;}
    .mobile-card{border:1px solid #eee;border-radius:16px;padding:14px;background:#fff}
    .mobile-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .mobile-title{
      font-weight:900;font-size:16px;line-height:1.3;
      overflow-wrap:anywhere; word-break:break-word;
    }
    .mobile-sub{opacity:.7;margin-top:6px;font-size:13px;line-height:1.4}
    hr.sep{border:0;border-top:1px solid #f0f0f0;margin:10px 0}

    /* ✅ 모바일에서 옆으로 미는 칩 제거(줄바꿈) */
    .chiprow{display:flex;gap:6px;flex-wrap:wrap;overflow-x:visible;padding-bottom:0}

    @media(max-width: 720px){
      body{margin:12px}
      .tablebox{display:none;}
      .mobile-list{display:flex;}
    }

    /* ✅ 모바일: 탭/필터 상단 고정 + 탭 가로 스크롤 */
    @media(max-width: 720px){
      #controls,#tabs{
        position:sticky; top:0; z-index:5;
        background:#fff; padding-top:10px; padding-bottom:10px;
        border-bottom:1px solid #eee;
      }
      #tabs{flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch}
      #tabs::-webkit-scrollbar{display:none}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">대학 상향/적정</div>
    <div class="meta" id="meta"></div>
    <div class="row" id="modeRow"></div>
    <div class="row" id="navRow"></div>

    <div class="controls" id="controls" style="display:none;">
      <input id="q" placeholder="대학/학과 검색 (예: 경희, 컴퓨터)" />

      <select id="groupSel">
        <option value="__all__">전체 계열</option>
      </select>

      <select id="yearSel">
        <option value="__all__">전체 연도</option>
      </select>

      <!-- ✅ 단일 과목 판정 토글 -->
      <select id="basisSel" title="판정 기준">
        <option value="__auto__">판정 기준: 자동(응시과목 평균)</option>
      </select>

      <!-- ✅ 학교별 5학과 제한 토글 -->
      <label class="toggle" title="적정/상향 탭에서 학교별 5학과만 표시">
        <input type="checkbox" id="top5Toggle" checked />
        학교별 5학과만
      </label>
    </div>

    <div class="tabs" id="tabs" style="display:none;"></div>
  </div>

  <div id="content"></div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const LS_KEY = "__ADMIN_TOKEN__";
  const norm = (v) => String(v ?? "").trim();

  const qs = new URLSearchParams(location.search);
  const adminParam = qs.get("admin");
  const adminSaved = localStorage.getItem(LS_KEY);
  const admin = adminParam || adminSaved;

  const idParam = qs.get("id");
  const tParam = qs.get("t") || qs.get("token");

  const isAdmin = (norm(admin) === norm(ADMIN_TOKEN));
  if (adminParam && isAdmin) localStorage.setItem(LS_KEY, adminParam);

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null; }
  function pickToken(s){ return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null; }

  function pickRound(x){ const v = x?.round ?? x?.Round ?? x?.["회차"] ?? x?.["차수"]; return v==null?null:Number(v); }
  function pickDate(x){ return x?.date ?? x?.Date ?? x?.["날짜"] ?? x?.["일자"] ?? null; }

  function toNum(v){
    if(v==null || v==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function showDenied(extra){
    $("#hdr").textContent = "접근 권한이 없습니다.";
    $("#meta").innerHTML = `
      <div class="warn">학생을 찾을 수 없습니다.</div>
      <div class="muted">관리자: univ_list.html?id=학생ID&admin=관리자토큰 / 학생: univ_list.html?t=개별토큰</div>
      ${extra || ""}
    `;
  }

  function roundLabel(row){
    const r = pickRound(row);
    const d = pickDate(row);
    if(r!=null && d) return `#${r} (${d})`;
    if(r!=null) return `#${r}`;
    if(d) return String(d);
    return "-";
  }

  // --- 학생 최신 회차에서 과목별 백분위 맵 만들기 (부분응시 허용) ---
  function buildStudentMap(latestRow){
    const get = (...keys) => {
      for(const k of keys){
        const v = toNum(latestRow?.[k]);
        if(v!=null) return v;
      }
      return null;
    };

    // ✅ 탐구: 당분간 생윤/사문이 들어오는 데이터도 탐1/탐2로 자동 매핑
    let inq1 = get("탐1","탐구1","탐_1","탐구_1");
    let inq2 = get("탐2","탐구2","탐_2","탐구_2");

    const sy = get("생윤","생활과윤리");
    const sc = get("사문","사회문화");

    if(inq1==null && sy!=null) inq1 = sy;
    if(inq2==null && sc!=null) inq2 = sc;

    // 둘 다 비어 있고 탐구가 1개만 있는 경우(예: 사문만) -> 탐1로라도 채움
    if(inq1==null && inq2==null){
      if(sy!=null) inq1 = sy;
      else if(sc!=null) inq1 = sc;
    }

    return {
      "국어": get("국어","국"),
      "수학": get("수학","수"),
      "영어": get("영어","영"),
      "탐1": inq1,
      "탐2": inq2,
      "한국사": get("한국사","한"),
    };
  }

  // --- 대학 row에서 과목별 컷 가져오기 (cuts / rule.cuts / 컬럼 방식 모두 지원) ---
  function getUnivCuts(u){
    const out = {};

    const addCutsObj = (obj) => {
      if(!obj || typeof obj !== "object") return;
      for(const rawKey of Object.keys(obj)){
        const v = toNum(obj[rawKey]);
        if(v==null) continue;

        const k = String(rawKey).trim();
        // ✅ 키 정규화
        if(k==="국어" || k==="kor" || k==="KOR") out["국어"] = v;
        else if(k==="수학" || k==="math" || k==="MATH") out["수학"] = v;
        else if(k==="영어" || k==="eng" || k==="ENG") out["영어"] = v;
        else if(k==="탐1" || k==="탐구1" || k==="탐색1") out["탐1"] = v;
        else if(k==="탐2" || k==="탐구2" || k==="탐색2") out["탐2"] = v;
      }
    };

    // 1) cuts 객체 방식
    addCutsObj(u?.cuts);

    // 2) rule.cuts 방식 (네가 올린 형태)
    addCutsObj(u?.rule?.cuts);

    // 3) 컬럼 방식(엑셀 변환 등)
    // 예: cut_kor / cut_math / cut_eng / cut_inq1 / cut_inq2
    const kor = toNum(u?.cut_kor ?? u?.kor_cut ?? u?.cut_korean);
    const math = toNum(u?.cut_math ?? u?.math_cut);
    const eng = toNum(u?.cut_eng ?? u?.eng_cut);
    const inq1 = toNum(u?.cut_inq1 ?? u?.cut_tam1 ?? u?.inq1_cut);
    const inq2 = toNum(u?.cut_inq2 ?? u?.cut_tam2 ?? u?.inq2_cut);

    if(kor!=null && out["국어"]==null) out["국어"]=kor;
    if(math!=null && out["수학"]==null) out["수학"]=math;
    if(eng!=null && out["영어"]==null) out["영어"]=eng;
    if(inq1!=null && out["탐1"]==null) out["탐1"]=inq1;
    if(inq2!=null && out["탐2"]==null) out["탐2"]=inq2;

    return out;
  }

  // --- 과목별 비교 -> 칩 / 평균차이 / 판정(적정/상향/NA) ---
  function evalRow(u, stuMap, basis){
    const cuts = u._cuts || {};
    const keysAll = ["국어","수학","탐1","탐2","영어"];
    const keys = (basis && basis!=="__auto__") ? [basis] : keysAll;

    let sumDiff = 0;
    let cnt = 0;

    const per = keysAll.map(k=>{
      const s = stuMap[k];
      const c = cuts[k];
      if(s==null || c==null){
        return { k, s, c, diff:null, state:"na" };
      }
      const diff = s - c;
      return { k, s, c, diff, state: diff>=0 ? "ok" : "ng" };
    });

    // 기준에 따라 cnt/diff 계산
    keys.forEach(k=>{
      const s = stuMap[k];
      const c = cuts[k];
      if(s==null || c==null) return;
      const diff = s - c;
      sumDiff += diff;
      cnt += 1;
    });

    const avgDiff = cnt ? (sumDiff / cnt) : null;

    // ✅ 탭: 적정/상향/전체
    // - cnt==0 (비교 불가) -> NA 로 표시(적정/상향 탭에서는 제외)
    let code = "na";
    if(avgDiff!=null){
      code = (avgDiff>=0) ? "fit" : "up";
    }

    return { per, avgDiff, cnt, code };
  }

  function statusLabel(code){
    if(code==="fit") return { t:"적정", cls:"st-fit" };
    if(code==="up") return { t:"상향", cls:"st-up" };
    return { t:"비교불가", cls:"st-na" };
  }

  function chipsHtml(per, mobile=false){
    const wrapCls = mobile ? "chiprow" : "chips";
    const items = per.map(p=>{
      const vText = (p.s==null) ? "미응시" : `${p.s}`;
      const cText = (p.c==null) ? "-" : `${p.c}`;
      const dText = (p.diff==null) ? "" : (p.diff>=0 ? `+${p.diff.toFixed(1)}` : `${p.diff.toFixed(1)}`);
      const cls = p.state==="ok" ? "chip ok" : (p.state==="ng" ? "chip ng" : "chip na");
      return `<span class="${cls}"><span class="k">${esc(p.k)}</span><span class="v">${esc(vText)}</span><span class="d">/ ${esc(cText)} ${esc(dText)}</span></span>`;
    }).join("");
    return `<div class="${wrapCls}">${items}</div>`;
  }

  async function main(){
    // 1) 학생 찾기
    let students = [];
    try{
      students = await loadJson("./students.json");
      if(!Array.isArray(students)) throw new Error("students.json is not an array");
    }catch(e){
      showDenied(`<div class="warn">students.json 로딩 실패: ${esc(e.message)}</div>`);
      return;
    }

    let student = null;
    if(isAdmin && idParam){
      student = students.find(s => norm(pickId(s)) === norm(idParam));
    }
    if(!student && tParam){
      student = students.find(s => norm(pickToken(s)) === norm(tParam));
    }

    if(!student){
      showDenied();
      return;
    }

    const sid = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").innerHTML = `대학 상향/적정 · ${esc(name)} (${esc(sid)})`;
    $("#meta").innerHTML = `
      학교: ${esc(student.school||"-")}<br>
      진로: ${esc(student.career||"-")}<br>
      전형: ${esc(student.admission||"-")}
    `;
    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;
    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 학생 상세로</a>`);
    if(isAdmin) nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    $("#navRow").innerHTML = nav.join("");

    // 2) scores.json 최신 스냅샷
    let scores = [];
    try{
      scores = await loadJson("./scores.json");
      if(!Array.isArray(scores)) throw new Error("scores.json is not an array");
    }catch(e){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">scores.json 로딩 실패</div>
          <div class="muted">${esc(e.message)}</div>
        </div>
      `;
      return;
    }

    const rows = scores
      .filter(r => norm(r.id) === sid)
      .sort((a,b)=>{
        const ra = pickRound(a), rb = pickRound(b);
        if(ra!=null && rb!=null) return ra-rb;
        const da = pickDate(a), db = pickDate(b);
        if(da && db) return String(da).localeCompare(String(db));
        return 0;
      });

    if(!rows.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">성적 데이터 없음</div>
          <div class="muted">scores.json에서 id=${esc(sid)} 데이터를 찾지 못했습니다.</div>
        </div>
      `;
      return;
    }

    const latest = rows[rows.length-1];
    const stuMap = buildStudentMap(latest);

    // 3) univ_percentile.json 로딩
    let univs = [];
    try{
      univs = await loadJson("./univ_percentile.json");
      if(!Array.isArray(univs)) throw new Error("univ_percentile.json is not an array");
    }catch(e){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">univ_percentile.json 로딩 실패</div>
          <div class="muted">${esc(e.message)}</div>
        </div>
      `;
      return;
    }

    // cuts 미리 파싱(성능 + 안정)
    const base = univs.map(u => ({ ...u, _cuts: getUnivCuts(u) }));

    // 필터 옵션
    const groups = [...new Set(base.map(x=>x.group).filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b),"ko"));
    const years = [...new Set(base.map(x=>x.year).filter(Boolean))].sort((a,b)=>a-b);

    const groupSel = $("#groupSel");
    groups.forEach(g=>{
      const o=document.createElement("option");
      o.value=String(g); o.textContent=String(g);
      groupSel.appendChild(o);
    });

    const yearSel = $("#yearSel");
    years.forEach(y=>{
      const o=document.createElement("option");
      o.value=String(y); o.textContent=String(y);
      yearSel.appendChild(o);
    });

    // ✅ 기준 과목 셀렉트(학생이 응시한 과목만 노출)
    const basisSel = $("#basisSel");
    const taken = ["국어","수학","탐1","탐2","영어"].filter(k => stuMap[k]!=null);
    taken.forEach(k=>{
      const o=document.createElement("option");
      o.value = k;
      o.textContent = `판정 기준: ${k}만`;
      basisSel.appendChild(o);
    });

    $("#controls").style.display = "flex";
    $("#tabs").style.display = "flex";

    // 5) 탭 (적정/상향/전체)
    const tabs = $("#tabs");
    const tabDefs = [
      {key:"fit", label:"적정"},
      {key:"up",  label:"상향"},
      {key:"all", label:"전체"},
    ];
    let activeTab = "fit";

    tabs.innerHTML = "";
    tabDefs.forEach((tdef)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tab";
      b.textContent=tdef.label;
      b.setAttribute("aria-selected", tdef.key===activeTab ? "true":"false");
      b.addEventListener("click", ()=>{
        activeTab = tdef.key;
        tabs.querySelectorAll(".tab").forEach(x=>x.setAttribute("aria-selected","false"));
        b.setAttribute("aria-selected","true");
        render();
      });
      tabs.appendChild(b);
    });

    const qInput = $("#q");
    const top5Toggle = $("#top5Toggle");

    function render(){
      const q = norm(qInput.value).toLowerCase();
      const g = groupSel.value;
      const y = yearSel.value;
      const basis = basisSel.value; // "__auto__" or subject
      const top5 = top5Toggle.checked;

      // 평가(기준 과목 반영)
      let arr = base.map(u=>{
        const ev = evalRow(u, stuMap, basis);
        return { ...u, _ev: ev };
      });

      // 탭 필터
      if(activeTab!=="all"){
        arr = arr.filter(x=>x._ev.code===activeTab);
      }else{
        // 전체 탭에서는 비교불가도 보이게(원하면 숨길 수 있음)
      }

      // group/year/q
      if(g!=="__all__") arr = arr.filter(x=>String(x.group)===String(g));
      if(y!=="__all__") arr = arr.filter(x=>String(x.year)===String(y));
      if(q){
        arr = arr.filter(x =>
          String(x.univ||"").toLowerCase().includes(q) ||
          String(x.major||"").toLowerCase().includes(q)
        );
      }

      // ✅ 단일 과목 기준일 때는 그 과목 컷이 있는 대학만(비교불가 제거)
      if(basis!=="__auto__"){
        arr = arr.filter(x => x._ev.cnt>0);
      }

      // 정렬: 평균차이 큰 순(상향도 ‘덜 마이너스’가 위로)
      arr.sort((a,b)=>{
        const av = a._ev.avgDiff ?? -9999;
        const bv = b._ev.avgDiff ?? -9999;
        return bv - av;
      });

      // ✅ 적정/상향 탭에서만: 학교별 5학과 제한
      if(top5 && activeTab!=="all"){
        const limit = 5;
        const seen = new Map();
        const filtered = [];
        for(const item of arr){
          const key = String(item.univ || "");
          const n = seen.get(key) || 0;
          if(n < limit){
            filtered.push(item);
            seen.set(key, n+1);
          }
        }
        arr = filtered;
      }

      // PC 표
      const rowsHtml = arr.map(u=>{
        const ev = u._ev;
        const st = statusLabel(ev.code);
        const avgDiffText = ev.avgDiff==null ? "-" : (ev.avgDiff>=0 ? `+${ev.avgDiff.toFixed(1)}` : `${ev.avgDiff.toFixed(1)}`);
        const covered = (basisSel.value==="__auto__") ? `${ev.cnt}/5` : `${ev.cnt}/1`;

        return `
          <tr>
            <td class="status ${st.cls}">${esc(st.t)}</td>
            <td>${esc(u.year ?? "-")}</td>
            <td>${esc(u.univ||"-")}</td>
            <td>${esc(u.major||"-")}</td>
            <td>${esc(u.group||"-")}</td>
            <td>${chipsHtml(ev.per, false)}</td>
            <td class="num">${esc(covered)}</td>
            <td class="num">${esc(avgDiffText)}</td>
            <td>${esc(u.note||"-")}</td>
          </tr>
        `;
      }).join("");

      // 모바일 카드
      const cardsHtml = arr.map(u=>{
        const ev = u._ev;
        const st = statusLabel(ev.code);
        const avgDiffText = ev.avgDiff==null ? "-" : (ev.avgDiff>=0 ? `+${ev.avgDiff.toFixed(1)}` : `${ev.avgDiff.toFixed(1)}`);
        const covered = (basisSel.value==="__auto__") ? `${ev.cnt}/5` : `${ev.cnt}/1`;

        return `
          <div class="mobile-card">
            <div class="mobile-top">
              <div>
                <div class="mobile-title">${esc(u.univ||"-")} · ${esc(u.major||"-")}</div>
                <div class="mobile-sub">
                  ${esc(u.year ?? "-")} · ${esc(u.group||"-")}
                  · 비교 ${esc(covered)}
                  · 차이 ${esc(avgDiffText)}
                  · 기준 ${esc(basisSel.value==="__auto__" ? "자동" : basisSel.value)}
                </div>
              </div>
              <div class="status ${st.cls}" style="white-space:nowrap">${esc(st.t)}</div>
            </div>
            <hr class="sep"/>
            ${chipsHtml(ev.per, true)}
            ${u.note ? `<div class="muted" style="margin-top:10px;line-height:1.5;overflow-wrap:anywhere;">${esc(u.note)}</div>` : ``}
          </div>
        `;
      }).join("");

      $("#content").innerHTML = `
        <div class="card">
          <div class="row">
            <span class="badge">최신 성적: ${esc(roundLabel(latest))}</span>
            <span class="badge muted">국:${stuMap["국어"] ?? "-"} · 수:${stuMap["수학"] ?? "-"} · 영:${stuMap["영어"] ?? "-"}</span>
            <span class="badge muted">탐1:${stuMap["탐1"] ?? "-"} · 탐2:${stuMap["탐2"] ?? "-"}</span>
          </div>
          <div class="muted" style="line-height:1.6;">
            ※ 대학 컷(백분위)과 비교합니다.<br>
            - <b>판정 기준 = 자동</b>: 응시한 과목들(컷이 있는 과목만)의 평균차이로 적정/상향을 표시합니다.<br>
            - <b>판정 기준 = 과목 1개</b>(예: 수학만): 그 과목 컷이 있는 대학만 모아서 적정/상향을 표시합니다.
          </div>
        </div>

        <div class="mobile-list">
          ${cardsHtml || `<div class="card"><div class="muted">표시할 데이터가 없습니다.</div></div>`}
        </div>

        <div class="card tablebox">
          <table>
            <thead>
              <tr>
                <th>판정</th>
                <th>연도</th>
                <th>대학</th>
                <th>학과</th>
                <th>계열</th>
                <th>과목별 비교 (학생/컷/차이)</th>
                <th class="num">비교</th>
                <th class="num">차이</th>
                <th>비고</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml || `<tr><td colspan="9" class="muted">표시할 데이터가 없습니다.</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
    }

    qInput.addEventListener("input", render);
    groupSel.addEventListener("change", render);
    yearSel.addEventListener("change", render);
    basisSel.addEventListener("change", ()=>{
      // 단일 과목 선택 시, 적정 탭으로 자동 이동(원하면 제거 가능)
      render();
    });
    top5Toggle.addEventListener("change", render);

    render();
  }

  main().catch(err=>{
    $("#hdr").textContent = "오류";
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
