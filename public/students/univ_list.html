<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>대학 상향/적정</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:14px;background:#fff;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:12px 0;background:#fff}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .meta{opacity:.85;line-height:1.7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .badge{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:800;background:#fff}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none;color:#111;background:#fff}
    .btn:hover{background:#fafafa}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}
    .spacer{flex:1}

    /* ✅ controls: 검색만 노출 */
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    input{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:800;
      width:min(520px, 100%);
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #111;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:900}
    .tab[aria-selected="true"]{background:#111;color:#fff}

    /* PC table */
    .tablebox{border:1px solid #eee;border-radius:14px;padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
    table{border-collapse:collapse;width:100%;min-width:980px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px;white-space:nowrap;vertical-align:top}
    th{background:#fafafa;font-weight:900;position:sticky;top:0}
    .num{text-align:right}

    .status{font-weight:900}
    .st-fit{color:#0b57d0}   /* 적정 */
    .st-up{color:#b26a00}    /* 상향 */
    .st-na{color:#666}       /* 비교불가 */

    /* chips (PC) */
    .chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center;white-space:normal}
    .chip{
      display:inline-flex;gap:6px;align-items:center;
      border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;font-weight:900;
      font-size:13px;
    }
    .chip .k{opacity:.7;font-weight:900}
    .chip.ok{border-color:#0b57d0}
    .chip.ng{border-color:#b26a00}
    .chip.na{border-color:#ddd;opacity:.75}

    /* Mobile cards */
    .mobile-list{display:none}
    .mcard{border:1px solid #eee;border-radius:16px;padding:14px;background:#fff;margin:12px 0}
    .mtop{display:flex;gap:10px;justify-content:space-between;align-items:flex-start}
    .mtitle{font-weight:900;font-size:16px;line-height:1.25;white-space:normal}
    .msub{opacity:.75;margin-top:4px;font-size:13px;line-height:1.45}
    .divider{height:1px;background:#f0f0f0;margin:10px 0}

    /* subject grid (mobile) */
    .subgrid{
      display:grid;
      grid-template-columns: 58px 1fr 1fr 1fr;
      gap:6px;
      align-items:center;
      font-size:13px;
    }
    .sg-h{font-weight:900;opacity:.7}
    .sg-k{font-weight:900}
    .sg-v{padding:6px 8px;border:1px solid #eee;border-radius:10px;background:#fff;min-width:0;text-align:center}
    .sg-ok{border-color:#0b57d0}
    .sg-ng{border-color:#b26a00}
    .sg-na{opacity:.6}

    @media(max-width: 860px){
      .tablebox{display:none;}
      .mobile-list{display:block;}
      .tabs{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
      .tabs::-webkit-scrollbar{display:none}
    }

    /* sticky controls on mobile */
    @media(max-width: 860px){
      #stickyBar{
        position:sticky; top:0; z-index:5;
        background:#fff; padding-top:10px; padding-bottom:10px;
        border-bottom:1px solid #eee;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">대학 상향/적정</div>
    <div class="meta" id="meta"></div>
    <div class="row" id="modeRow"></div>
    <div class="row" id="navRow"></div>

    <div id="stickyBar">
      <!-- ✅ 검색만 노출 -->
      <div class="controls" id="controls" style="display:none;">
        <input id="q" placeholder="대학/학과 검색 (예: 경희, 컴퓨터)" />
      </div>
      <div class="tabs" id="tabs" style="display:none;"></div>
    </div>
  </div>

  <div id="content"></div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const LS_KEY = "__ADMIN_TOKEN__";
  const norm = (v) => String(v ?? "").trim();

  const qs = new URLSearchParams(location.search);
  const adminParam = qs.get("admin");
  const adminSaved = localStorage.getItem(LS_KEY);
  const admin = adminParam || adminSaved;

  const idParam = qs.get("id");
  const tParam = qs.get("t") || qs.get("token");

  const isAdmin = (norm(admin) === norm(ADMIN_TOKEN));
  if (adminParam && isAdmin) localStorage.setItem(LS_KEY, adminParam);

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  // =========================
  // ✅ PATCH #2: scores.json이 배열이 아니어도 항상 배열로
  // =========================
  function normalizeToArray(x){
    if(Array.isArray(x)) return x;
    if(!x) return [];
    if(Array.isArray(x.scores)) return x.scores;
    if(Array.isArray(x.rows)) return x.rows;
    if(Array.isArray(x.data)) return x.data;

    if(typeof x === "object"){
      const entries = Object.entries(x);
      const allArrays = entries.length && entries.every(([,v]) => Array.isArray(v));
      if(allArrays){
        const out = [];
        for(const [key, arr] of entries){
          for(const row of arr){
            if(row && typeof row === "object") out.push({ ...row, id: row.id ?? key });
            else out.push({ id: key, value: row });
          }
        }
        return out;
      }
      return [x];
    }
    return [];
  }

  (function patchFetchScores(){
    const _fetch = window.fetch.bind(window);
    window.fetch = async function(input, init){
      const res = await _fetch(input, init);
      try{
        const url = (input instanceof Request) ? input.url : String(input||"");
        if(url.includes("scores.json")){
          const origJson = res.json.bind(res);
          res.json = async () => normalizeToArray(await origJson());
        }
      }catch(e){}
      return res;
    };
  })();

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null; }
  function pickToken(s){ return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null; }
  function pickRound(x){ const v = x?.round ?? x?.Round ?? x?.["회차"] ?? x?.["차수"]; return v==null?null:Number(v); }
  function pickDate(x){ return x?.date ?? x?.Date ?? x?.["날짜"] ?? x?.["일자"] ?? null; }

  function toNum(v){
    if(v==null || v==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function roundLabel(row){
    const r = pickRound(row);
    const d = pickDate(row);
    if(r!=null && d) return `#${r} (${d})`;
    if(r!=null) return `#${r}`;
    if(d) return String(d);
    return "-";
  }

  const SUBS = ["국어","수학","탐1","탐2","영어"];

  function nk(s){
    return String(s||"")
      .toLowerCase()
      .replace(/\s+/g,"")
      .replace(/[()（）\[\]{}._\-:/\\]/g,"");
  }

  function detectSub(normKey){
    const s = normKey;

    if(s.includes("국어") || s==="국") return "국어";
    if(s.includes("수학") || s==="수") return "수학";
    if(s.includes("영어") || s==="영") return "영어";

    if(s.includes("탐1") || s.includes("탐구1") || s.includes("탐_1")) return "탐1";
    if(s.includes("탐2") || s.includes("탐구2") || s.includes("탐_2")) return "탐2";

    // ✅ 당분간 호환(생윤/사문 → 탐1/탐2)
    if(s.includes("생윤")) return "탐1";
    if(s.includes("사문")) return "탐2";

    return null;
  }

  function detectType(normKey){
    const s = normKey;
    if(s.includes("원점수") || s.includes("raw") || s.endsWith("점수") || s.includes("rawscore")) return "raw";
    if(s.includes("백분위") || s.includes("pct") || s.includes("percentile")) return "pct";
    return "unknown";
  }

  // ✅ 학생 점수 파싱: "백분위(pct)"는 판정용, "원점수(raw)"는 표시용
  function parseStudentScores(row){
    const pct = { "국어":null,"수학":null,"탐1":null,"탐2":null,"영어":null };
    const raw = { "국어":null,"수학":null,"탐1":null,"탐2":null,"영어":null };

    function feed(key, val){
      const n = toNum(val);
      if(n==null) return;
      const keyN = nk(key);
      const sub = detectSub(keyN);
      if(!sub) return;

      const ty = detectType(keyN);
      if(ty==="pct"){
        pct[sub] = (pct[sub]==null) ? n : pct[sub];
      }else if(ty==="raw"){
        raw[sub] = (raw[sub]==null) ? n : raw[sub];
      }else{
        // unknown은 "백분위 기본키"로 취급(구버전 호환)
        pct[sub] = (pct[sub]==null) ? n : pct[sub];
      }
    }

    // 1) 일반 키들
    if(row && typeof row === "object"){
      for(const k of Object.keys(row)){
        const v = row[k];
        if(v && typeof v === "object" && !Array.isArray(v)){
          // 2) 흔한 중첩 컨테이너 지원
          const kN = nk(k);
          if(kN.includes("pct") || kN.includes("percentile") || kN.includes("백분위") || kN.includes("raw") || kN.includes("원점수") || kN.includes("score")){
            for(const kk of Object.keys(v)){
              const vv = v[kk];
              // 예: scores: {수학:{pct:95,raw:92}}
              if(vv && typeof vv === "object" && !Array.isArray(vv)){
                for(const kkk of Object.keys(vv)){
                  feed(`${kk}_${kkk}`, vv[kkk]);
                }
              }else{
                feed(`${kk}`, vv);
                feed(`${kk}_${k}`, vv);
                feed(`${kk}_${kk}`, vv);
              }
            }
          }
        }else{
          feed(k, v);
        }
      }
    }

    // 3) {수학_pct:..., 수학_raw:...} 형태 보강
    for(const sub of SUBS){
      const base = sub;
      feed(base+"_pct", row?.[base+"_pct"]);
      feed(base+"_백분위", row?.[base+"_백분위"]);
      feed(base+"백분위", row?.[base+"백분위"]);
      feed(base+"_percentile", row?.[base+"_percentile"]);

      feed(base+"_raw", row?.[base+"_raw"]);
      feed(base+"_원점수", row?.[base+"_원점수"]);
      feed(base+"원점수", row?.[base+"원점수"]);
      feed(base+"_점수", row?.[base+"_점수"]);
    }

    return { pct, raw };
  }

  // --- 대학 row에서 과목별 컷(백분위) 가져오기 ---
  function getUnivCuts(u){
    const out = {};
    const tryPut = (k, v) => {
      const n = toNum(v);
      if(n==null) return;
      const kN = nk(k);
      const sub = detectSub(kN) || (kN==="탐구" ? "탐1" : null);
      if(sub) out[sub] = n;
    };

    if(u?.rule?.cuts){
      for(const k of Object.keys(u.rule.cuts)) tryPut(k, u.rule.cuts[k]);
    }
    if(u?.cuts){
      for(const k of Object.keys(u.cuts)) tryPut(k, u.cuts[k]);
    }

    tryPut("국어", u.cut_kor ?? u.kor_cut);
    tryPut("수학", u.cut_math ?? u.math_cut);
    tryPut("영어", u.cut_eng ?? u.eng_cut);
    tryPut("탐1", u.cut_inq1 ?? u.cut_tam1);
    tryPut("탐2", u.cut_inq2 ?? u.cut_tam2);

    return out;
  }

  // --- 평가(판정은 백분위로만) ---
  function evalRow(u, stu){
    const cuts = getUnivCuts(u);
    const per = SUBS.map(k=>{
      const sPct = stu.pct[k];
      const sRaw = stu.raw[k];
      const c = cuts[k];

      if((sPct==null && sRaw==null) && c==null) return { k, sPct, sRaw, c, diff:null, state:"na" };
      if(sPct==null || c==null) return { k, sPct, sRaw, c, diff:null, state:"na" };

      const diff = sPct - c;
      return { k, sPct, sRaw, c, diff, state: diff>=0 ? "ok" : "ng" };
    });

    let sum = 0, cnt = 0;
    for(const p of per){
      if(p.diff!=null){
        sum += p.diff;
        cnt += 1;
      }
    }
    const mainDiff = cnt ? (sum / cnt) : null;

    let code = "na";
    if(cnt>0) code = (mainDiff>=0) ? "fit" : "up";

    return { cuts, per, mainDiff, cnt, code };
  }

  function statusLabel(code){
    if(code==="fit") return { t:"적정", cls:"st-fit" };
    if(code==="up") return { t:"상향", cls:"st-up" };
    return { t:"비교불가", cls:"st-na" };
  }

  function diffText(v){
    if(v==null) return "-";
    return (v>=0 ? `+${v.toFixed(1)}p` : `${v.toFixed(1)}p`);
  }

  function chipsHtml(per){
    const items = per.map(p=>{
      const sTxt =
        (p.sPct==null && p.sRaw==null)
          ? "미응시"
          : `${p.sRaw!=null?`${p.sRaw}점`:"-"} / ${p.sPct!=null?`${p.sPct}p`:"-"}`;
      const cTxt = (p.c==null) ? "-" : `${p.c}p`;
      const dTxt = (p.diff==null) ? "" : diffText(p.diff);
      const cls = p.state==="ok" ? "chip ok" : (p.state==="ng" ? "chip ng" : "chip na");
      return `<span class="${cls}"><span class="k">${esc(p.k)}</span>${esc(sTxt)} / ${esc(cTxt)} ${esc(dTxt)}</span>`;
    }).join("");
    return `<div class="chips">${items}</div>`;
  }

  function mobileSubgrid(per){
    const header = `
      <div class="sg-h">과목</div>
      <div class="sg-h">학생(점/백)</div>
      <div class="sg-h">컷(백)</div>
      <div class="sg-h">차이</div>
    `;
    const rows = per.map(p=>{
      const sTxt =
        (p.sPct==null && p.sRaw==null)
          ? "-"
          : `${p.sRaw!=null?`${p.sRaw}점`:"-"} / ${p.sPct!=null?`${p.sPct}p`:"-"}`;
      const cTxt = (p.c==null) ? "-" : `${p.c}p`;
      const dTxt = (p.diff==null) ? "-" : diffText(p.diff);
      const cls = (p.diff==null) ? "sg-v sg-na" : (p.diff>=0 ? "sg-v sg-ok" : "sg-v sg-ng");
      return `
        <div class="sg-k">${esc(p.k)}</div>
        <div class="${(p.sPct==null && p.sRaw==null) ? "sg-v sg-na" : "sg-v"}">${esc(sTxt)}</div>
        <div class="${(p.c==null) ? "sg-v sg-na" : "sg-v"}">${esc(cTxt)}</div>
        <div class="${cls}">${esc(dTxt)}</div>
      `;
    }).join("");
    return `<div class="subgrid">${header}${rows}</div>`;
  }

  // 대학별 상위 5개(적정/상향 탭에서만 자동 적용, UI 노출 없음)
  function groupLimitTop5(arr){
    const map = new Map();
    arr.forEach(x=>{
      const key = String(x.univ||"-");
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(x);
    });
    const out = [];
    for(const [, list] of map.entries()){
      list.sort((a,b)=>{
        const av = a._ev.mainDiff ?? -999999;
        const bv = b._ev.mainDiff ?? -999999;
        return bv - av;
      });
      out.push(...list.slice(0,5));
    }
    return out;
  }

  let activeTab = "fit";
  let tabsEl;

  function setActiveTab(key){
    activeTab = key;
    tabsEl.querySelectorAll(".tab").forEach(btn=>{
      btn.setAttribute("aria-selected", btn.dataset.key===key ? "true" : "false");
    });
  }

  async function loadUnivData(){
    const candidates = [
      "./univ_percentile.json",
      "./univ_percentile_v6_subject_cuts.json",
      "./univ_percentile_from_excel.json"
    ];
    let lastErr = null;
    for(const p of candidates){
      try{
        const data = await loadJson(p);
        if(Array.isArray(data) && data.length) return { path:p, data };
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("univ data load failed");
  }

  async function main(){
    // 1) 학생 찾기
    const students = await loadJson("./students.json");
    if(!Array.isArray(students)) throw new Error("students.json is not an array");

    let student = null;
    if(isAdmin && idParam) student = students.find(s => norm(pickId(s)) === norm(idParam));
    if(!student && tParam) student = students.find(s => norm(pickToken(s)) === norm(tParam));

    if(!student){
      $("#hdr").textContent = "접근 권한이 없습니다.";
      $("#meta").innerHTML = `
        <div class="warn">학생을 찾을 수 없습니다.</div>
        <div class="muted">관리자: univ_list.html?id=학생ID&admin=관리자토큰 / 학생: univ_list.html?t=개별토큰</div>
      `;
      return;
    }

    const sid = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").innerHTML = `대학 상향/적정 · ${esc(name)} (${esc(sid)})`;
    $("#meta").innerHTML = `
      학교: ${esc(student.school||"-")}<br>
      진로: ${esc(student.career||"-")}<br>
      전형: ${esc(student.admission||"-")}
    `;
    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;
    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 학생 상세로</a>`);
    if(isAdmin) nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    $("#navRow").innerHTML = nav.join("");

    // 2) scores.json 최신
    const scores = await loadJson("./scores.json"); // PATCH #2로 항상 배열이 됨
    if(!Array.isArray(scores)) throw new Error("scores.json is not an array");

    const rows = scores
      .filter(r => norm(r?.id ?? r?.studentId ?? r?.studentID ?? r?.["학생ID"]) === sid)
      .sort((a,b)=>{
        const ra = pickRound(a), rb = pickRound(b);
        if(ra!=null && rb!=null) return ra-rb;
        const da = pickDate(a), db = pickDate(b);
        if(da && db) return String(da).localeCompare(String(db));
        return 0;
      });

    if(!rows.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">성적 데이터 없음</div>
          <div class="muted">scores.json에서 id=${esc(sid)} 데이터를 찾지 못했습니다.</div>
        </div>
      `;
      return;
    }

    const latest = rows[rows.length-1];
    const stu = parseStudentScores(latest);

    // 3) 대학 데이터 로딩(파일명 자동 탐색)
    const univPack = await loadUnivData();
    const univs = univPack.data;

    // show controls/tabs
    $("#controls").style.display = "flex";
    tabsEl = $("#tabs");
    tabsEl.style.display = "flex";

    // tabs
    const tabDefs = [
      {key:"fit", label:"적정"},
      {key:"up",  label:"상향"},
      {key:"all", label:"전체"},
    ];
    tabsEl.innerHTML = "";
    tabDefs.forEach(tdef=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tab";
      b.dataset.key = tdef.key;
      b.textContent=tdef.label;
      b.setAttribute("aria-selected", tdef.key===activeTab ? "true":"false");
      b.addEventListener("click", ()=>{
        setActiveTab(tdef.key);
        render();
      });
      tabsEl.appendChild(b);
    });

    const qInput = $("#q");
    qInput.addEventListener("input", ()=>{
      if(norm(qInput.value) && activeTab!=="all") setActiveTab("all");
      render();
    });

    function fmtSubLine(sub){
      const rp = stu.raw[sub];
      const pp = stu.pct[sub];
      if(rp==null && pp==null) return `${sub}:-`;
      if(rp!=null && pp!=null) return `${sub}:${rp}점/${pp}p`;
      if(pp!=null) return `${sub}:${pp}p`;
      return `${sub}:${rp}점`;
    }

    function render(){
      const q = norm(qInput.value).toLowerCase();

      // 평가
      const evaluated = univs.map(u=>{
        const ev = evalRow(u, stu);
        return { ...u, _ev: ev };
      });

      // 검색
      let arr = evaluated.slice();
      if(q){
        arr = arr.filter(x =>
          String(x.univ||"").toLowerCase().includes(q) ||
          String(x.major||"").toLowerCase().includes(q)
        );
      }

      // 탭 필터
      if(activeTab!=="all"){
        arr = arr.filter(x=>x._ev.code===activeTab);
      }

      // 적정/상향 탭: 대학별 top5 자동 제한(검색 중엔 해제)
      if(!q && (activeTab==="fit" || activeTab==="up")){
        arr = groupLimitTop5(arr);
      }

      // 정렬
      if(activeTab==="all"){
        const rank = (c)=> (c==="fit"?2 : c==="up"?1 : 0);
        arr.sort((a,b)=>{
          const ra = rank(a._ev.code), rb = rank(b._ev.code);
          if(rb!==ra) return rb-ra;
          const av = a._ev.mainDiff ?? -999999;
          const bv = b._ev.mainDiff ?? -999999;
          return bv - av;
        });
      }else{
        arr.sort((a,b)=>{
          const av = a._ev.mainDiff ?? -999999;
          const bv = b._ev.mainDiff ?? -999999;
          return bv - av;
        });
      }

      // counts
      const cntFit = evaluated.filter(x=>x._ev.code==="fit").length;
      const cntUp  = evaluated.filter(x=>x._ev.code==="up").length;
      const cntNa  = evaluated.filter(x=>x._ev.code==="na").length;

      // summary
      const summaryBadges = `
        <span class="badge">최신 성적: ${esc(roundLabel(latest))}</span>
        <span class="badge muted">${esc(fmtSubLine("국어"))} · ${esc(fmtSubLine("수학"))} · ${esc(fmtSubLine("영어"))}</span>
        <span class="badge muted">${esc(fmtSubLine("탐1"))} · ${esc(fmtSubLine("탐2"))}</span>
        <span class="badge">대학데이터: ${esc(univPack.path)} (${esc(univs.length)}개)</span>
        <span class="badge">적정 ${esc(cntFit)} · 상향 ${esc(cntUp)} · 비교불가 ${esc(cntNa)}</span>
      `;

      const help = `
        <div class="muted" style="margin-top:8px;line-height:1.55">
          - 판정은 <b>백분위(p)</b>로만 계산합니다. (표시는 <b>원점수+백분위</b>)<br>
          - <b>검색</b>하면 자동으로 <b>전체</b> 탭에서 결과가 나옵니다.<br>
          - ✅ scores.json은 배열이 아니어도 자동으로 읽습니다. (객체/레코드/ID별 배열도 OK)
        </div>
      `;

      // rows (✅ 비고 column 제거)
      const rowsHtml = arr.map(u=>{
        const ev = u._ev;
        const st = statusLabel(ev.code);
        const covered = `${ev.cnt}/5`;
        const main = diffText(ev.mainDiff);

        return `
          <tr>
            <td class="status ${st.cls}">${esc(st.t)}</td>
            <td>${esc(u.year ?? "-")}</td>
            <td>${esc(u.univ||"-")}</td>
            <td>${esc(u.major||"-")}</td>
            <td>${esc(u.group||"-")}</td>
            <td>${chipsHtml(ev.per)}</td>
            <td class="num">${esc(covered)}</td>
            <td class="num">${esc(main)}</td>
          </tr>
        `;
      }).join("");

      // mobile
      const cardsHtml = arr.map(u=>{
        const ev = u._ev;
        const st = statusLabel(ev.code);
        const covered = `${ev.cnt}/5`;
        const main = diffText(ev.mainDiff);

        return `
          <div class="mcard">
            <div class="mtop">
              <div style="min-width:0">
                <div class="mtitle">${esc(u.univ||"-")} · ${esc(u.major||"-")}</div>
                <div class="msub">${esc(u.year ?? "-")} · ${esc(u.group||"-")} · 비교 ${esc(covered)} · 차이 ${esc(main)}</div>
              </div>
              <div class="status ${st.cls}" style="white-space:nowrap">${esc(st.t)}</div>
            </div>
            <div class="divider"></div>
            ${mobileSubgrid(ev.per)}
          </div>
        `;
      }).join("");

      $("#content").innerHTML = `
        <div class="card">
          <div class="row">${summaryBadges}</div>
          ${help}
        </div>

        <div class="mobile-list">
          ${cardsHtml || `<div class="card"><div class="muted">표시할 데이터가 없습니다.</div></div>`}
        </div>

        <div class="card tablebox">
          <table>
            <thead>
              <tr>
                <th>판정</th>
                <th>연도</th>
                <th>대학</th>
                <th>학과</th>
                <th>계열</th>
                <th>과목별 비교 (학생:원점수/백분위 · 컷:백분위 · 차이:p)</th>
                <th class="num">비교</th>
                <th class="num">차이</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml || `<tr><td colspan="8" class="muted">표시할 데이터가 없습니다.</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
    }

    render();
  }

  main().catch(err=>{
    $("#hdr").textContent = "오류";
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
