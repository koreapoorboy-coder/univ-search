<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 목록</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      margin:24px;background:#fff;color:#111
    }
    h1{margin:0 0 12px}
    .wrap{max-width:980px}

    /* 상단 컨트롤 */
    .topbar{
      position:sticky;top:0;z-index:10;
      background:#fff;padding:10px 0 12px;border-bottom:1px solid #eee;
      margin-bottom:10px
    }
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      max-width:980px
    }
    .search{
      width:min(520px,100%);padding:12px;border:1px solid #ccc;border-radius:12px;font-size:16px
    }
    select{
      border:1px solid #ddd;border-radius:12px;padding:12px 12px;background:#fff;font-weight:800
    }
    .summary{margin-top:8px;opacity:.75;font-size:13px}

    /* 카드 */
    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin:12px 0;background:#fff}
    .row{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .left{min-width:260px;flex:1}
    .right{min-width:260px;max-width:420px;flex:1}
    .name{font-weight:900;font-size:22px}
    .muted{opacity:.7}
    .meta{opacity:.85;margin-top:6px;line-height:1.7}

    a.btn{
      display:inline-block;margin-top:10px;text-decoration:none;border:1px solid #111;
      padding:9px 12px;border-radius:12px;color:#111;background:#fff
    }
    a.btn + a.btn{margin-left:8px}
    a.btn:hover{background:#fafafa}

    .warn{color:#b00020;font-weight:900;margin-top:10px;line-height:1.6}

    .box{border:1px solid #eee;border-radius:14px;padding:12px;background:#fcfcfc}
    .box h3{margin:0 0 8px;font-size:14px}

    /* 공유(학생 링크) 섹션: 기본 접힘 */
    details.shareDetails{
      margin-top:12px;border:1px solid #eee;border-radius:14px;background:#fcfcfc;overflow:hidden
    }
    details.shareDetails > summary{
      list-style:none;cursor:pointer;
      padding:12px 12px;font-weight:900;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none
    }
    details.shareDetails > summary::-webkit-details-marker{display:none}
    .caret{opacity:.7;font-weight:900}
    details.shareDetails[open] .caret{transform:rotate(180deg)}
    .shareBody{padding:12px;border-top:1px solid #eee;background:#fff}

    .linkRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .actionBtn{
      border:1px solid #111;background:#fff;border-radius:12px;padding:9px 12px;
      cursor:pointer;font-weight:900
    }
    .actionBtn.primary{background:#111;color:#fff}
    .actionBtn:hover{background:#fafafa}
    .actionBtn.primary:hover{filter:brightness(.95)}
    .actionBtn.kakao{
      border-color:#111;
    }

    .urlBox{
      margin-top:10px;border:1px solid #e8e8e8;background:#fff;border-radius:12px;padding:10px
    }
    .urlInput{
      width:100%;border:0;outline:none;font-size:13px;line-height:1.5;
      background:transparent;color:#111;
      white-space:normal;word-break:break-all
    }
    .hint{margin-top:6px;font-size:12px;opacity:.7;line-height:1.4}

    /* 페이지네이션 */
    .pager{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      margin:10px 0 6px
    }
    .pbtn{
      border:1px solid #111;background:#fff;border-radius:12px;padding:8px 10px;
      cursor:pointer;font-weight:900
    }
    .pbtn:disabled{opacity:.35;cursor:not-allowed}
    .pageinfo{font-weight:900}
    .pill{
      display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;
      padding:6px 10px;background:#fafafa;font-weight:900;font-size:12px
    }

    /* 토스트 */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111;color:#fff;border-radius:999px;padding:10px 14px;
      font-weight:900;font-size:13px;opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px);}

    /* 관리자 게이트 메시지 */
    #gate{display:none}

    @media (max-width:720px){
      body{margin:16px}
      .right{display:none} /* 모바일 우측 박스 숨김 */
      a.btn{display:block}
      a.btn + a.btn{margin-left:0}
      .search{width:100%}
      .controls{gap:8px}
      select{width:min(220px,100%)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>학생 목록</h1>
    <div id="gate" class="warn"></div>

    <div class="topbar">
      <div class="controls">
        <input id="q" class="search" placeholder="검색: 학생명 / 학교 / 진로 / 전형 / ID" />
        <select id="sortSel">
          <option value="name_asc">정렬: 이름 ↑</option>
          <option value="name_desc">정렬: 이름 ↓</option>
          <option value="school_asc">정렬: 학교 ↑</option>
          <option value="school_desc">정렬: 학교 ↓</option>
          <option value="id_asc">정렬: ID ↑</option>
          <option value="id_desc">정렬: ID ↓</option>
        </select>
        <select id="pageSizeSel">
          <option value="10">페이지당 10명</option>
          <option value="20" selected>페이지당 20명</option>
          <option value="50">페이지당 50명</option>
        </select>
      </div>

      <div class="pager" id="pager" style="display:none"></div>
      <div class="summary" id="summary"></div>
    </div>

    <div id="list"></div>
  </div>

  <div id="toast" class="toast">복사됨</div>

  <script>
    // ✅ 여기만 바꾸면 됨 (관리자 토큰)
    const ADMIN_TOKEN = "CHANGE_ME_ADMIN";

    let students = [];

    const $ = (s) => document.querySelector(s);

    function qs(name){
      return new URLSearchParams(location.search).get(name);
    }

    function pickName(s){
      return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? s["학생ID"] ?? "-";
    }

    function pickId(s){
      return s.id ?? s.studentId ?? s.studentID ?? s["id"] ?? s["ID"] ?? s["학생ID"] ?? s["학생 아이디"] ?? s["학번"] ?? null;
    }

    function pickToken(s){
      return s.token ?? s.accessToken ?? s.key ?? s.pass ?? s.pw ?? s["token"] ?? s["토큰"] ?? null;
    }

    // ✅ 절대 URL 생성 (학생에게 그대로 보내기 좋게)
    function absUrl(fileName, params){
      const base = new URL(".", location.href); // .../public/students/
      const u = new URL(fileName, base);        // .../public/students/student.html
      for(const [k,v] of Object.entries(params||{})){
        if(v!=null && String(v).length) u.searchParams.set(k, v);
      }
      return u.toString();
    }

    function showToast(text){
      const t = $("#toast");
      t.textContent = text || "완료";
      t.classList.add("show");
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(()=>t.classList.remove("show"), 1300);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast("링크 복사됨");
      }catch(e){
        prompt("복사가 막혀있어요. 아래를 복사하세요:", text);
      }
    }

    // ✅ “카톡 느낌” 공유: 모바일에서는 공유 시트 → 카카오톡 선택 가능
    // (PC/공유 미지원이면 복사로 대체 + 안내 토스트)
    async function kakaoShare(url, studentName){
      const title = `${studentName} 성적 링크`;
      const text = `성적 확인 링크입니다.\n${url}`;
      if(navigator.share){
        try{
          await navigator.share({ title, text, url });
          showToast("공유창 열림");
          return;
        }catch(e){
          // 사용자가 취소해도 조용히
        }
      }
      await copyText(url);
      showToast("복사됨 · 카톡에 붙여넣기");
    }

    function openUrl(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function gateKeep(){
      const admin = qs("admin");
      if(!admin || admin !== ADMIN_TOKEN){
        const g = $("#gate");
        g.style.display = "block";
        g.innerHTML = `
          이 페이지는 <b>관리자 토큰</b>으로만 볼 수 있습니다.<br/>
          ✅ 관리자: <span class="muted">index.html?admin=관리자토큰</span><br/>
          예) <span class="muted">.../public/students/index.html?admin=${ADMIN_TOKEN}</span>
        `;
        $("#q").style.display = "none";
        $("#sortSel").style.display = "none";
        $("#pageSizeSel").style.display = "none";
        $("#pager").style.display = "none";
        $("#list").innerHTML = "";
        return null;
      }
      return admin;
    }

    // ---------- 상태(페이지/정렬) ----------
    let state = {
      keyword: "",
      sort: "name_asc",
      page: 1,
      pageSize: 20,
    };

    function norm(v){ return String(v ?? "").trim().toLowerCase(); }

    function sortItems(arr, sortKey){
      const getName = (x)=>norm(pickName(x));
      const getSchool = (x)=>norm(x.school || "");
      const getId = (x)=>norm(pickId(x) || "");

      const cmp = (a,b)=> (a>b?1:(a<b?-1:0));

      const baseSort = {
        name_asc:  (a,b)=>cmp(getName(a), getName(b)),
        name_desc: (a,b)=>cmp(getName(b), getName(a)),
        school_asc:(a,b)=>cmp(getSchool(a), getSchool(b)) || cmp(getName(a), getName(b)),
        school_desc:(a,b)=>cmp(getSchool(b), getSchool(a)) || cmp(getName(a), getName(b)),
        id_asc:    (a,b)=>cmp(getId(a), getId(b)),
        id_desc:   (a,b)=>cmp(getId(b), getId(a)),
      }[sortKey] || ((a,b)=>0);

      return arr.slice().sort(baseSort);
    }

    function filterItems(arr, keyword){
      const k = norm(keyword);
      if(!k) return arr.slice();
      return arr.filter(s=>{
        const name = pickName(s);
        const id = pickId(s) || "";
        const hay = `${s.school||""} ${name||""} ${s.career||""} ${s.admission||""} ${id}`.toLowerCase();
        return hay.includes(k);
      });
    }

    function renderPager(total, page, pageSize){
      const pager = $("#pager");
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      pager.style.display = "flex";

      const clampPage = Math.min(Math.max(1, page), totalPages);
      state.page = clampPage;

      const prevDisabled = clampPage <= 1;
      const nextDisabled = clampPage >= totalPages;

      pager.innerHTML = `
        <button class="pbtn" type="button" data-page="first" ${prevDisabled?'disabled':''}>처음</button>
        <button class="pbtn" type="button" data-page="prev" ${prevDisabled?'disabled':''}>이전</button>
        <span class="pageinfo">페이지 ${clampPage} / ${totalPages}</span>
        <button class="pbtn" type="button" data-page="next" ${nextDisabled?'disabled':''}>다음</button>
        <button class="pbtn" type="button" data-page="last" ${nextDisabled?'disabled':''}>끝</button>
        <span class="pill">총 ${total}명</span>
      `;
    }

    function slicePage(arr, page, pageSize){
      const start = (page-1)*pageSize;
      return arr.slice(start, start + pageSize);
    }

    async function init(){
      const admin = gateKeep();
      if(!admin) return;

      const url = new URL("./students.json", location.href).toString();
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error("students.json fetch failed: " + res.status);
      students = await res.json();

      // 초기 렌더
      rerender(admin);

      // 입력 이벤트
      $("#q").addEventListener("input", (e)=>{
        state.keyword = e.target.value.trim();
        state.page = 1;
        rerender(admin);
      });
      $("#sortSel").addEventListener("change", (e)=>{
        state.sort = e.target.value;
        state.page = 1;
        rerender(admin);
      });
      $("#pageSizeSel").addEventListener("change", (e)=>{
        state.pageSize = Number(e.target.value) || 20;
        state.page = 1;
        rerender(admin);
      });

      // 페이지 버튼
      $("#pager").addEventListener("click", (e)=>{
        const b = e.target.closest("[data-page]");
        if(!b) return;
        const mode = b.dataset.page;
        const total = state._totalFiltered || 0;
        const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
        if(mode==="first") state.page = 1;
        if(mode==="prev") state.page = Math.max(1, state.page-1);
        if(mode==="next") state.page = Math.min(totalPages, state.page+1);
        if(mode==="last") state.page = totalPages;
        rerender(admin);
      });

      // 카드 내부 버튼들(복사/카톡/열기) 이벤트 위임
      $("#list").addEventListener("click", async (e)=>{
        const btn = e.target.closest("[data-action]");
        if(!btn) return;

        const action = btn.dataset.action;
        const url = btn.dataset.url;
        const studentName = btn.dataset.name || "학생";

        if(!url) return;

        if(action==="copy") return copyText(url);
        if(action==="kakao") return kakaoShare(url, studentName);
        if(action==="open") return openUrl(url);
      });

      // URL 클릭 시 전체 선택
      $("#list").addEventListener("click", (e)=>{
        const inp = e.target.closest(".urlInput");
        if(inp) inp.select?.();
      });

      // details 열림 상태 저장(선택)
      $("#list").addEventListener("toggle", (e)=>{
        const d = e.target.closest("details.shareDetails");
        if(!d) return;
        const sid = d.dataset.sid;
        if(!sid) return;
        try{
          localStorage.setItem("__shareOpen__"+sid, d.open ? "1":"0");
        }catch(_){}
      });
    }

    function rerender(admin){
      const list = $("#list");

      // 1) 필터
      let arr = filterItems(students, state.keyword);

      // 2) 정렬
      arr = sortItems(arr, state.sort);

      // 3) 페이지
      state._totalFiltered = arr.length;
      renderPager(arr.length, state.page, state.pageSize);
      const pageItems = slicePage(arr, state.page, state.pageSize);

      // summary
      $("#summary").textContent = `표시: ${pageItems.length}명 / 검색결과: ${arr.length}명`;

      list.innerHTML = pageItems.map(s=>{
        const name = pickName(s);
        const id = pickId(s);
        const token = pickToken(s);

        if(!id){
          return `
            <div class="card">
              <div class="name">${name} <span class="muted">(ID없음)</span></div>
              <div class="meta">학교: ${s.school||'-'}<br/>진로: ${s.career||'-'}<br/>전형: ${s.admission||'-'}</div>
              <div class="warn">⚠ students.json에 이 학생의 ID가 없습니다. (id/학생ID/ID 중 하나 필요)</div>
            </div>
          `;
        }

        // 관리자 링크(내부 확인용)
        const studentAdminHref = `./student.html?id=${encodeURIComponent(id)}&admin=${encodeURIComponent(admin)}`;
        const univAdminHref    = `./univ_list.html?id=${encodeURIComponent(id)}&admin=${encodeURIComponent(admin)}`;

        // ✅ 학생에게 보낼 링크(성적 링크만, 절대주소)
        const studentPublicAbs = token ? absUrl("student.html", { t: token }) : null;

        // details 기본 닫힘(저장된 상태가 있으면 복원)
        let openAttr = "";
        try{
          const saved = localStorage.getItem("__shareOpen__"+id);
          if(saved==="1") openAttr = " open";
        }catch(_){}

        const shareBlock = token ? `
          <details class="shareDetails"${openAttr} data-sid="${id}">
            <summary>
              <span>학생에게 보낼 성적 링크</span>
              <span class="caret">▼</span>
            </summary>
            <div class="shareBody">
              <div class="linkRow">
                <button class="actionBtn primary" type="button"
                  data-action="copy" data-url="${studentPublicAbs}" data-name="${String(name).replace(/"/g,'&quot;')}">
                  복사
                </button>
                <button class="actionBtn kakao" type="button"
                  data-action="kakao" data-url="${studentPublicAbs}" data-name="${String(name).replace(/"/g,'&quot;')}">
                  카톡으로 보내기
                </button>
                <button class="actionBtn" type="button"
                  data-action="open" data-url="${studentPublicAbs}" data-name="${String(name).replace(/"/g,'&quot;')}">
                  열기
                </button>
              </div>

              <div class="urlBox">
                <input class="urlInput" readonly value="${studentPublicAbs}">
              </div>
              <div class="hint">
                • 모바일: “카톡으로 보내기” → 공유창에서 카카오톡 선택<br/>
                • PC/공유 미지원: 자동으로 복사되며, 카톡에 붙여넣으면 됩니다.
              </div>
            </div>
          </details>
        ` : `
          <details class="shareDetails" data-sid="${id}">
            <summary>
              <span>학생에게 보낼 성적 링크</span>
              <span class="caret">▼</span>
            </summary>
            <div class="shareBody">
              <div class="warn" style="margin:0">⚠ token이 없어 학생 링크 생성 불가</div>
              <div class="hint">students.json에 해당 학생의 "token"을 넣으면 자동 생성됩니다.</div>
            </div>
          </details>
        `;

        return `
          <div class="card">
            <div class="row">
              <div class="left">
                <div class="name">${name} <span class="muted">(${id})</span></div>
                <div class="meta">
                  학교: ${s.school || '-'}<br/>
                  진로: ${s.career || '-'}<br/>
                  전형: ${s.admission || '-'}
                </div>

                <a class="btn" href="${studentAdminHref}">성적/그래프/진도 보기</a>
                <a class="btn" href="${univAdminHref}">대학 상향/적정 보기</a>

                ${shareBlock}
              </div>

              <div class="right">
                <div class="box">
                  <h3>안내</h3>
                  <div class="muted" style="font-size:13px;line-height:1.6">
                    - 학생에게는 <b>성적 링크만</b> 전달 권장<br/>
                    - “카톡으로 보내기”는 기기 공유창을 활용합니다.
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div style="opacity:.7;margin-top:12px">검색 결과가 없습니다.</div>`;
    }

    init().catch((e)=>{
      $("#list").innerHTML = `<div class="warn">students.json 로딩 실패<br/><span class="muted">${String(e)}</span></div>`;
    });
  </script>
</body>
</html>
