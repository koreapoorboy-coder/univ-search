<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 목록</title>

  <!-- ✅ 관리자 전용 잠금: admin 파라미터가 없거나 틀리면 목록을 절대 렌더링하지 않음 -->
  <script>
  (() => {
    const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
    const qs = new URLSearchParams(location.search);
    const admin = (qs.get("admin") || "").trim();
    if (admin !== ADMIN_TOKEN) {
      document.documentElement.innerHTML = `
        <head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>접근 불가</title>
        <style>
          body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:24px}
          .card{border:1px solid #ddd;border-radius:14px;padding:16px;max-width:720px}
          .warn{color:#b00020;font-weight:900}
          .muted{opacity:.7;line-height:1.6}
          code{background:#f6f6f6;border:1px solid #eee;padding:2px 6px;border-radius:8px}
        </style></head>
        <body>
          <div class="card">
            <div class="warn">접근 불가</div>
            <p class="muted">
              이 페이지는 <b>관리자 전용</b>입니다.<br/>
              올바른 주소 예시: <code>index.html?admin=관리자토큰</code>
            </p>
          </div>
        </body>`;
      throw new Error("FORBIDDEN");
    }
  })();
  </script>

  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:24px}
    h1{margin:0 0 14px}
    .search{width:100%;max-width:720px;padding:12px;border:1px solid #ccc;border-radius:10px;font-size:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:10px 0;max-width:720px}
    .name{font-weight:900;font-size:18px}
    .meta{opacity:.85;margin-top:6px;line-height:1.6}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    a.btn{display:inline-block;text-decoration:none;border:1px solid #111;padding:8px 10px;border-radius:10px;color:#111}
    a.btn:hover{background:#fafafa}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <h1>학생 목록 (관리자)</h1>
  <input class="search" id="q" placeholder="검색: 이름 / 학교 / 진로 / 전형 / ID" />
  <div id="list" class="muted" style="margin-top:12px;">로딩 중…</div>

<script>
(async () => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const qs = new URLSearchParams(location.search);
  const admin = (qs.get("admin") || "").trim();

  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  const norm = (v)=>String(v??"").trim().toLowerCase();

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }
  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null; }

  const students = await loadJson("./students.json");
  if(!Array.isArray(students)) throw new Error("students.json is not an array");

  const q = document.getElementById("q");
  const list = document.getElementById("list");

  function render(){
    const keyword = norm(q.value);
    const filtered = !keyword ? students : students.filter(s => {
      const blob = [
        pickName(s), pickId(s),
        s.school, s.career, s.admission
      ].map(v=>norm(v)).join(" ");
      return blob.includes(keyword);
    });

    if(!filtered.length){
      list.innerHTML = '<div class="muted">검색 결과가 없습니다.</div>';
      return;
    }

    list.innerHTML = filtered.map(s=>{
      const name = pickName(s);
      const id = pickId(s);
      const school = s.school || "-";
      const career = s.career || "-";
      const admission = s.admission || "-";
      const sid = encodeURIComponent(id || "");
      const adminQ = encodeURIComponent(admin);

      const hrefStudent = `./student.html?id=${sid}&admin=${adminQ}`;
      const hrefUniv = `./univ_list.html?id=${sid}&admin=${adminQ}`;
      const hrefProg = `./progress_detail.html?id=${sid}&admin=${adminQ}`;

      return `
        <div class="card">
          <div class="name">${esc(name)} ${id?`<span class="muted">(${esc(id)})</span>`:""}</div>
          <div class="meta">
            학교: ${esc(school)}<br/>
            진로: ${esc(career)}<br/>
            전형: ${esc(admission)}
          </div>
          <div class="btns">
            <a class="btn" href="${hrefStudent}">학생 성적</a>
            <a class="btn" href="${hrefUniv}">대학 상향/적정</a>
            <a class="btn" href="${hrefProg}">진도 상세</a>
          </div>
        </div>
      `;
    }).join("\n");
  }

  q.addEventListener("input", render);
  render();
})().catch(err=>{
  const list = document.getElementById('list');
  list.innerHTML = `<div style="color:#b00020;font-weight:900">오류</div><div class="muted">${err.message}</div>`;
});
</script>
</body>
</html>
