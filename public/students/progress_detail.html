<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>진도 상세</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px;background:#fff;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:14px 0;background:#fff}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .meta{opacity:.85;line-height:1.7}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .badge{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:800;background:#fff}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none;color:#111;background:#fff}
    .btn:hover{background:#fafafa}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    /* filters */
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    select{border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:700}
    option{font-weight:700}

    /* list */
    .grid{display:grid;grid-template-columns:1fr;gap:12px;align-items:start}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .grid > *{min-width:0}

    .group{border:1px solid #eee;border-radius:16px;padding:12px}
    .group h3{margin:0 0 10px;font-size:16px;font-weight:900}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px solid #eee;border-radius:14px;padding:10px 12px;margin:8px 0;cursor:pointer}
    .item:hover{background:#fafafa}
    .left{min-width:0}
    .unit{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .status{flex:0 0 auto}
    .s-good{border-color:#1f7a1f}
    .s-mid{border-color:#666}
    .s-bad{border-color:#b00020}

    /* modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;border-radius:18px;border:1px solid #ddd;
      padding:14px;
    }
    .modal-head{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px}
    .modal-title{font-size:16px;font-weight:900;min-width:0}
    .xbtn{border:1px solid #111;border-radius:12px;background:#fff;padding:8px 10px;cursor:pointer;font-weight:900}
    .xbtn:hover{background:#fafafa}
    .kv{margin-top:10px;border-top:1px solid #eee;padding-top:10px;line-height:1.7}
    .kv b{display:block;margin-top:8px}
    .hr{height:1px;background:#eee;margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="title" id="hdr">진도 상세</div>
    <div class="meta" id="meta"></div>

    <div class="row" id="modeRow" style="margin-top:10px;"></div>

    <div class="row" id="navRow" style="margin-top:10px;"></div>

    <div class="filters" id="filters" style="display:none;">
      <select id="subjectFilter">
        <option value="__all__">전체 과목</option>
      </select>
      <select id="statusFilter">
        <option value="__all__">전체 상태</option>
        <option value="잘함">잘함</option>
        <option value="보통">보통</option>
        <option value="부족">부족</option>
      </select>
    </div>
  </div>

  <div id="content"></div>

</div>

<!-- modal -->
<div class="modal-backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div class="modal-title" id="mTitle"></div>
      <button class="xbtn" id="mClose">닫기</button>
    </div>
    <div class="hr"></div>
    <div id="mBody" class="kv"></div>
  </div>
</div>

<script>
(() => {
  // ✅ student.html 과 동일하게 맞춰야 함
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";

  const qs = new URLSearchParams(location.search);
  const admin = qs.get("admin");
  const idParam = qs.get("id");
  const tParam = qs.get("t") || qs.get("token");

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }
  function pickId(s){
    return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null;
  }
  function pickToken(s){
    return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null;
  }

  function statusClass(st){
    if(st==="잘함") return "s-good";
    if(st==="부족") return "s-bad";
    return "s-mid";
  }

  // modal
  const backdrop = $("#backdrop");
  const mTitle = $("#mTitle");
  const mBody = $("#mBody");
  $("#mClose").addEventListener("click", ()=> backdrop.style.display="none");
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) backdrop.style.display="none"; });

  function openModal(title, html){
    mTitle.textContent = title;
    mBody.innerHTML = html;
    backdrop.style.display = "flex";
  }

  async function main(){
    // 1) 학생 식별: admin+id 또는 t(token)
    const students = await loadJson("./students.json");

    const isAdmin = (admin === ADMIN_TOKEN);

    let student = null;
    if(isAdmin && idParam){
      student = students.find(s => String(pickId(s)) === String(idParam));
    }
    if(!student && tParam){
      student = students.find(s => String(pickToken(s)) === String(tParam));
    }

    if(!student){
      $("#hdr").textContent = "접근 권한이 없습니다.";
      $("#meta").innerHTML = `
        <div class="warn">학생을 찾을 수 없습니다.</div>
        <div class="muted">관리자: progress_detail.html?id=학생ID&admin=관리자토큰 / 학생: progress_detail.html?t=개별토큰</div>
      `;
      return;
    }

    const sid = pickId(student);
    const stok = pickToken(student);
    const name = pickName(student);

    // header
    $("#hdr").textContent = `진도 상세 · ${name}${sid ? " ("+sid+")" : ""}`;
    $("#meta").innerHTML = `
      학교: ${esc(student.school||"-")}<br>
      진로: ${esc(student.career||"-")}<br>
      전형: ${esc(student.admission||"-")}
    `;

    // mode pill
    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    // nav buttons
    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;

    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 학생 상세로</a>`);
    if(isAdmin){
      nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    }
    $("#navRow").innerHTML = nav.join("");

    // 2) progress / notes 로딩
    const progressAll = await loadJson("./progress.json");
    const notesAll = await loadJson("./progress_notes.json");

    const rec = (Array.isArray(progressAll) ? progressAll : []).find(x => String(x.id)===String(sid));
    const items = rec?.progress || [];
    const updated = rec?.updated || "-";

    if(!items.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">진도 데이터가 없습니다.</div>
          <div class="muted">progress.json에 id=${esc(sid)} 항목이 있는지 확인하세요.</div>
        </div>
      `;
      return;
    }

    // filters show
    $("#filters").style.display = "flex";

    // subject list
    const subjects = [...new Set(items.map(x=>x.subject).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"ko"));
    const subjSel = $("#subjectFilter");
    subjects.forEach(s=>{
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      subjSel.appendChild(o);
    });

    const statusSel = $("#statusFilter");

    // group rendering
    function render(){
      const subj = subjSel.value;
      const st = statusSel.value;

      const filtered = items.filter(x=>{
        const okSubj = (subj==="__all__" ? true : x.subject===subj);
        const okSt = (st==="__all__" ? true : x.status===st);
        return okSubj && okSt;
      });

      const bySubject = {};
      filtered.forEach(x=>{
        bySubject[x.subject] = bySubject[x.subject] || [];
        bySubject[x.subject].push(x);
      });

      const content = $("#content");
      content.innerHTML = `
        <div class="card">
          <div class="row">
            <span class="badge">업데이트: ${esc(updated)}</span>
            <span class="badge muted">표시 항목: ${filtered.length}개</span>
          </div>
          <div class="muted">단원을 클릭하면 “잘함/부족/문제점/개선” 코멘트를 팝업으로 봅니다.</div>
        </div>
      `;

      const grid = document.createElement("div");
      grid.className = "grid";

      Object.keys(bySubject).sort((a,b)=>a.localeCompare(b,"ko")).forEach(sub=>{
        const group = document.createElement("div");
        group.className = "group";
        group.innerHTML = `<h3>${esc(sub)}</h3>`;

        bySubject[sub].forEach(it=>{
          const unit = it.unit || "-";
          const status = it.status || "보통";

          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="left">
              <div class="unit">${esc(unit)}</div>
              <div class="muted" style="font-size:12px;">상태: ${esc(status)}</div>
            </div>
            <div class="badge status ${statusClass(status)}">${esc(status)}</div>
          `;

          row.addEventListener("click", ()=>{
            const note = (Array.isArray(notesAll)?notesAll:[]).find(n =>
              String(n.id)===String(sid) &&
              String(n.subject)===String(sub) &&
              String(n.unit)===String(unit)
            );

            if(note){
              openModal(`${sub} · ${unit}`, `
                <div><span class="badge ${statusClass(note.level||status)}">${esc(note.level||status)}</span></div>
                <b>잘한 점</b><div>${esc(note.good||"-")}</div>
                <b>부족한 점</b><div>${esc(note.bad||"-")}</div>
                <b>개선 방법</b><div>${esc(note.fix||"-")}</div>
              `);
            }else{
              openModal(`${sub} · ${unit}`, `
                <div><span class="badge ${statusClass(status)}">${esc(status)}</span></div>
                <b>코멘트</b>
                <div class="muted">등록된 코멘트가 없습니다. (progress_notes.json에 추가하면 여기에 표시됩니다.)</div>
              `);
            }
          });

          group.appendChild(row);
        });

        grid.appendChild(group);
      });

      content.appendChild(grid);
    }

    subjSel.addEventListener("change", render);
    statusSel.addEventListener("change", render);

    render();
  }

  main().catch(err=>{
    $("#hdr").textContent = "오류";
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
