<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>진도 상세</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:0;background:#fff;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{border:1px solid #e6e6e6;border-radius:16px;padding:14px;background:#fff}
    .title{font-size:20px;font-weight:1000;line-height:1.25}
    .muted{color:#666;font-size:12px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;text-decoration:none;border:1px solid #111;padding:10px 12px;border-radius:12px;font-weight:900;white-space:nowrap}
    .btn.ghost{border-color:#ddd;color:#111}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .box{border:1px solid #eee;border-radius:14px;padding:12px;background:#fafafa}
    .box h3{margin:0 0 6px;font-size:14px;font-weight:1000}
    .box ul{margin:0;padding-left:18px}
    .box li{margin:4px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title" id="hdr">진도 상세</div>
      <div class="muted" id="sub">진도 데이터가 있으면 여기서 바로 확인할 수 있어요.</div>
      <div class="btns" id="btns"></div>
    </div>

    <div class="grid" id="content"></div>
  </div>

  <script>
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const norm = (v)=>String(v??"").trim();

    const q = new URLSearchParams(location.search);
    const ADMIN_TOKEN = "CHANGE_ME_ADMIN"; // student.html 과 동일하게 맞추세요
    const isAdmin = (q.get('admin') && q.get('admin')===ADMIN_TOKEN);
    const idParam = q.get('id');
    const tokenParam = q.get('t');

    async function loadJson(path){
      const r = await fetch(path, { cache:"no-store" });
      if(!r.ok) return null;
      return r.json();
    }

    function pickId(s){
      return s.id ?? s.studentId ?? s.studentID ?? s["학생ID"] ?? null;
    }
    function pickToken(s){
      return s.token ?? s.accessToken ?? s.key ?? null;
    }
    function pickName(s){
      return s.studentName ?? s.studentname ?? s.name ?? s["이름"] ?? s.id ?? "-";
    }

    (async function(){
      const students = await loadJson('./students.json') || [];
      let student = null;
      if(isAdmin && idParam) student = students.find(s=>norm(pickId(s))===norm(idParam));
      if(!student && tokenParam) student = students.find(s=>norm(pickToken(s))===norm(tokenParam));

      const sid = student ? norm(pickId(student)) : null;
      const stok = student ? norm(pickToken(student)) : null;

      // 헤더
      if(student){
        document.getElementById('hdr').textContent = `진도 상세: ${pickName(student)}${sid?` (${sid})`:''}`;
      } else {
        document.getElementById('hdr').textContent = '접근 권한이 없습니다';
        document.getElementById('sub').textContent = '학생 정보를 찾을 수 없습니다.';
      }

      // 버튼
      const btns = [];
      if(student){
        const backHref = isAdmin
          ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
          : `./student.html?t=${encodeURIComponent(stok)}`;
        const univHref = isAdmin
          ? `./univ_list.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
          : `./univ_list.html?t=${encodeURIComponent(stok)}`;
        btns.push(`<a class="btn ghost" href="${backHref}">성적 화면</a>`);
        btns.push(`<a class="btn" href="${univHref}">대학 상향/적정</a>`);
      }
      document.getElementById('btns').innerHTML = btns.join('');

      // 내용(진도)
      const content = document.getElementById('content');
      if(!student){
        content.innerHTML = `<div class="box"><h3>안내</h3><div class="muted">관리자는 id+admin, 학생/학부모는 t(토큰)으로 접속해야 합니다.</div></div>`;
        return;
      }

      // progress.json(선택) : 없으면 안내만
      // 권장 형식 예시:
      // [{"id":"shstudy01","date":"2026-03-01","title":"수학 미분 단원","status":"완료","note":"오답: 절댓값 케이스"}, ...]
      const progress = await loadJson('./progress.json');
      const items = Array.isArray(progress) ? progress.filter(x=>norm(x.id)===sid) : [];

      if(!items.length){
        content.innerHTML = `
          <div class="box">
            <h3>진도 데이터가 아직 없습니다</h3>
            <div class="muted">progress.json 파일을 추가하면, 여기에서 날짜/단원/상태/메모를 자동으로 보여줍니다.</div>
          </div>
          <div class="box">
            <h3>progress.json 예시</h3>
            <div class="muted">(배열 형태)</div>
            <pre style="white-space:pre-wrap;margin:8px 0 0;font-size:12px;line-height:1.5">[
  {"id":"shstudy01","date":"2026-03-01","title":"수학: 미분(기본)","status":"완료","note":"개념은 OK, 부호 실수 2회"},
  {"id":"shstudy01","date":"2026-03-08","title":"국어: 비문학(근거문장 찾기)","status":"진행중","note":"문단 요약 훈련 필요"}
]</pre>
          </div>
        `;
        return;
      }

      const li = items
        .slice()
        .sort((a,b)=>String(b.date||'').localeCompare(String(a.date||'')))
        .map(x=>`<li><b>${esc(x.date||'-')}</b> · ${esc(x.title||'-')} · <b>${esc(x.status||'-')}</b><div class="muted">${esc(x.note||'')}</div></li>`)
        .join('');

      content.innerHTML = `
        <div class="box">
          <h3>진도/상담 메모</h3>
          <ul>${li}</ul>
        </div>
      `;
    })();
  </script>
</body>
</html>
