<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>진도 · 상담 메모</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      margin:14px;background:#fff;color:#111;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:12px 0;background:#fff}
    .title{font-size:20px;font-weight:900;margin:0 0 8px}
    .meta{opacity:.85;line-height:1.7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .btn{
      display:inline-block;border:1px solid #111;border-radius:12px;
      padding:10px 14px;text-decoration:none;color:#111;background:#fff
    }
    .btn:hover{background:#fafafa}
    .badge{
      display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;
      padding:8px 12px;font-weight:900;background:#fff
    }
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    /* ===== Portfolio-like layout ===== */
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between
    }
    .leftgroup{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .rightgroup{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* round selector */
    select{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:900;
      max-width: 100%;
    }

    /* subject cards grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width: 860px){
      .grid{grid-template-columns: 1fr;}
    }

    .pbox{
      border:1px solid #eee;border-radius:16px;padding:14px;background:#fff;
    }
    .ptop{
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;
    }
    .ptitle{font-weight:900;font-size:16px;line-height:1.25;white-space:normal}
    .psub{opacity:.75;margin-top:4px;font-size:13px;line-height:1.45}

    .tag{
      display:inline-flex;align-items:center;white-space:nowrap;
      border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px;
      background:#fff;
    }
    .t-good{border-color:#0b57d0;color:#0b57d0}
    .t-mid{border-color:#b26a00;color:#b26a00}
    .t-bad{border-color:#b00020;color:#b00020}

    .kv{
      display:grid;
      grid-template-columns: 78px 1fr;
      gap:8px 10px;
      margin-top:12px;
      line-height:1.55;
    }
    .k{opacity:.65;font-weight:900}
    .v{font-weight:800;white-space:pre-line}

    /* hide blocks completely when empty (JS will not render, but keep safe) */
    .kv:empty{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">진도 · 상담 메모</div>
    <div class="meta" id="meta"></div>

    <div class="row" id="modeRow"></div>

    <div class="topbar" style="margin-top:10px">
      <div class="leftgroup" id="navRow"></div>

      <div class="rightgroup">
        <div id="roundWrap" style="display:none; gap:8px; align-items:center;">
          <span class="badge">회차/날짜</span>
          <select id="roundSel"></select>
        </div>
      </div>
    </div>
  </div>

  <div id="content"></div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const LS_KEY = "__ADMIN_TOKEN__";
  const norm = (v) => String(v ?? "").trim();

  const qs = new URLSearchParams(location.search);
  const adminParam = qs.get("admin");
  const adminSaved = localStorage.getItem(LS_KEY);
  const admin = adminParam || adminSaved;

  const idParam = qs.get("id");
  const tParam  = qs.get("t") || qs.get("token");

  const isAdmin = (norm(admin) === norm(ADMIN_TOKEN));
  if (adminParam && isAdmin) localStorage.setItem(LS_KEY, adminParam);

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null; }
  function pickToken(s){ return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null; }

  // 빈값 처리: 공백/undefined/null이면 "" 반환
  const pickText = (...vals) => {
    for(const v of vals){
      const s = String(v ?? "").trim();
      if(s) return s;
    }
    return "";
  };

  // 배열/객체 모두 대응
  function normalizeArrayish(x){
    if(Array.isArray(x)) return x.slice();
    if(!x || typeof x!=="object") return [];
    for(const k of ["records","rows","items","data","notes","progress"]){
      if(Array.isArray(x[k])) return x[k].slice();
    }
    const out = [];
    for(const [k,v] of Object.entries(x)){
      if(Array.isArray(v)) out.push(...v.map(r => ({...r, id:(r?.id ?? k)})));
      else if(v && typeof v==="object") out.push({...v, id:(v?.id ?? k)});
    }
    return out;
  }

  // round/date 키 구성 (없으면 "미지정")
  function roundKeyOf(n){
    const r = pickText(n.round, n.Round, n["회차"], n["차수"]);
    const d = pickText(n.date, n.Date, n["날짜"], n["일자"]);
    if(r && d) return `#${r} (${d})`;
    if(r) return `#${r}`;
    if(d) return `${d}`;
    return "미지정";
  }

  function levelTag(level){
    const s = String(level||"").trim();
    if(!s) return null; // ✅ 레벨이 없으면 태그 자체 숨김
    const low = s.toLowerCase();
    if(low.includes("잘") || low.includes("우수") || low.includes("좋") || low.includes("강점"))
      return { text:s, cls:"tag t-good" };
    if(low.includes("보통") || low.includes("중") || low.includes("가능"))
      return { text:s, cls:"tag t-mid" };
    if(low.includes("부족") || low.includes("약") || low.includes("미흡"))
      return { text:s, cls:"tag t-bad" };
    return { text:s, cls:"tag" };
  }

  // 과목 순서 고정(5과목 우선, 그 외는 뒤로)
  function subjectOrder(subject){
    const s = String(subject||"");
    const map = {"국어":1,"수학":2,"영어":3,"탐1":4,"탐2":5,"탐구1":4,"탐구2":5};
    return map[s] ?? 99;
  }

  function renderRound(key, byRound){
    const list = byRound.get(key) || [];
    if(!list.length){
      $("#content").innerHTML = `<div class="card"><div class="muted">표시할 데이터가 없습니다.</div></div>`;
      return;
    }

    // ✅ 정렬: 과목 우선순위 → 과목명
    list.sort((a,b)=>{
      const sa = pickText(a.subject, a["과목"]);
      const sb = pickText(b.subject, b["과목"]);
      const oa = subjectOrder(sa);
      const ob = subjectOrder(sb);
      if(oa!==ob) return oa-ob;
      return sa.localeCompare(sb,"ko");
    });

    const cards = list.map(n=>{
      const subject = pickText(n.subject, n["과목"]);
      if(!subject) return ""; // ✅ 과목명이 없으면 카드 생성 자체를 안 함

      const unit  = pickText(n.unit, n["단원"], n["파트"]);
      const lvl   = pickText(n.level, n["수준"], n["상태"]);
      const tag   = levelTag(lvl);

      const good = pickText(n.good, n["잘한점"], n["강점"]);
      const bad  = pickText(n.bad,  n["아쉬운점"], n["약점"]);
      const fix  = pickText(n.fix,  n["피드백"], n["보완"]);
      const memo = pickText(n.memo, n["상담메모"], n["메모"]);

      // ✅ 값 있는 항목만 kv로 출력
      const rows = [];
      if(good) rows.push(`<div class="k">강점</div><div class="v">${esc(good)}</div>`);
      if(bad)  rows.push(`<div class="k">약점</div><div class="v">${esc(bad)}</div>`);
      if(fix)  rows.push(`<div class="k">피드백</div><div class="v">${esc(fix)}</div>`);
      if(memo) rows.push(`<div class="k">상담 메모</div><div class="v">${esc(memo)}</div>`);

      const kv = rows.length ? `<div class="kv">${rows.join("")}</div>` : "";

      return `
        <div class="pbox">
          <div class="ptop">
            <div style="min-width:0">
              <div class="ptitle">${esc(subject)}</div>
              ${unit ? `<div class="psub">단원: ${esc(unit)}</div>` : ``}
            </div>
            ${tag ? `<span class="${tag.cls}">${esc(tag.text)}</span>` : ``}
          </div>
          ${kv}
        </div>
      `;
    }).join("");

    $("#content").innerHTML = `
      <div class="card">
        <div class="badge">표시 기준: 입력된 항목만 노출 (빈값 자동 숨김)</div>
      </div>
      <div class="grid">
        ${cards || `<div class="card"><div class="muted">표시할 데이터가 없습니다.</div></div>`}
      </div>
    `;
  }

  async function main(){
    // 1) 학생 찾기
    const students = await loadJson("./students.json");
    if(!Array.isArray(students)) throw new Error("students.json is not an array");

    let student = null;
    if(isAdmin && idParam){
      student = students.find(s => norm(pickId(s)) === norm(idParam));
    }
    if(!student && tParam){
      student = students.find(s => norm(pickToken(s)) === norm(tParam));
    }
    if(!student){
      $("#hdr").textContent = "접근 권한이 없습니다.";
      $("#meta").innerHTML = `
        <div class="warn">학생을 찾을 수 없습니다.</div>
        <div class="muted">관리자: progress_detail.html?id=학생ID&admin=관리자토큰 / 학생: progress_detail.html?t=개별토큰</div>
      `;
      return;
    }

    const sid  = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").textContent = `진도 · 상담 메모 · ${name}${sid?` (${sid})`:``}`;

    // ✅ 학생 메타도 "입력된 것만" 표시
    const metaRows = [];
    const school = pickText(student.school, student["학교"]);
    const career = pickText(student.career, student["진로"]);
    const adm    = pickText(student.admission, student["전형"]);
    if(school) metaRows.push(`학교: ${esc(school)}`);
    if(career) metaRows.push(`진로: ${esc(career)}`);
    if(adm)    metaRows.push(`전형: ${esc(adm)}`);
    $("#meta").innerHTML = metaRows.length ? metaRows.join("<br>") : `<span class="muted">학생 메타 정보 없음</span>`;

    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    // 2) 네비 버튼
    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;

    const univHref = isAdmin
      ? `./univ_list.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./univ_list.html?t=${encodeURIComponent(stok)}`;

    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 성적 보기</a>`);
    nav.push(`<a class="btn" href="${univHref}">대학 상향/적정</a>`);
    if(isAdmin){
      nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    }
    $("#navRow").innerHTML = nav.join("");

    // 3) 진도/메모 데이터 로딩 (notes 우선)
    let rawNotes = null;

    // progress_notes.json 필수(현재 GitHub에 이 파일만 있다 했으니 우선)
    try{
      rawNotes = await loadJson("./progress_notes.json");
    }catch(e){
      // fallback: progress.json (있으면)
      try{
        rawNotes = await loadJson("./progress.json");
      }catch(e2){
        rawNotes = [];
      }
    }

    const notes = normalizeArrayish(rawNotes)
      .filter(n => norm(n?.id) === sid);

    if(!notes.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">진도/상담 메모 데이터 없음</div>
          <div class="muted">progress_notes.json(또는 progress.json)에 id=${esc(sid)} 데이터가 없습니다.</div>
        </div>
      `;
      return;
    }

    // 4) roundKey로 그룹핑
    const byRound = new Map();
    for(const n of notes){
      const key = roundKeyOf(n);
      if(!byRound.has(key)) byRound.set(key, []);
      byRound.get(key).push(n);
    }

    // 5) round 목록 정렬 (미지정은 뒤로)
    const keys = [...byRound.keys()];
    keys.sort((a,b)=>{
      if(a==="미지정" && b!=="미지정") return 1;
      if(b==="미지정" && a!=="미지정") return -1;
      return a.localeCompare(b,"ko");
    });

    // 6) selector: 2개 이상일 때만 노출
    const roundWrap = $("#roundWrap");
    const roundSel = $("#roundSel");
    if(keys.length >= 2){
      roundWrap.style.display = "inline-flex";
      roundSel.innerHTML = keys.map(k => `<option value="${esc(k)}">${esc(k)}</option>`).join("");
      // 최신을 마지막으로 보고 싶으면 아래 한 줄로 변경 가능:
      // roundSel.value = keys[keys.length - 1];
      roundSel.value = keys[0];
      roundSel.addEventListener("change", ()=> renderRound(roundSel.value, byRound));
      renderRound(roundSel.value, byRound);
    }else{
      roundWrap.style.display = "none";
      renderRound(keys[0], byRound);
    }
  }

  main().catch(err=>{
    $("#hdr").textContent = "오류";
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
