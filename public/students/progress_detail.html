<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì§„ë„ Â· ìƒë‹´ ë©”ëª¨</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      margin:14px;background:#fff;color:#111;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:12px 0;background:#fff}
    .title{font-size:20px;font-weight:900;margin:0 0 8px}
    .meta{opacity:.85;line-height:1.7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .btn{
      display:inline-block;border:1px solid #111;border-radius:12px;
      padding:10px 14px;text-decoration:none;color:#111;background:#fff
    }
    .btn:hover{background:#fafafa}
    .badge{
      display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;
      padding:8px 12px;font-weight:900;background:#fff
    }
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    /* ===== Portfolio-like layout ===== */
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between
    }
    .leftgroup{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .rightgroup{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    select{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:900;
      max-width: 100%;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width: 860px){
      .grid{grid-template-columns: 1fr;}
    }

    .pbox{
      border:1px solid #eee;border-radius:16px;padding:14px;background:#fff;
    }
    .ptop{
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;
    }
    .ptitle{font-weight:900;font-size:16px;line-height:1.25;white-space:normal}
    .psub{opacity:.75;margin-top:4px;font-size:13px;line-height:1.45}

    .tag{
      display:inline-flex;align-items:center;white-space:nowrap;
      border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px;
      background:#fff;
    }
    .t-good{border-color:#0b57d0;color:#0b57d0}
    .t-mid{border-color:#b26a00;color:#b26a00}
    .t-bad{border-color:#b00020;color:#b00020}

    .kv{
      display:grid;
      grid-template-columns: 88px 1fr;
      gap:8px 10px;
      margin-top:12px;
      line-height:1.55;
    }
    .k{opacity:.65;font-weight:900}
    .v{font-weight:800;white-space:pre-line}

    .links{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .alink{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid #ddd;border-radius:999px;padding:7px 10px;
      text-decoration:none;color:#111;background:#fff;font-weight:900;font-size:12px;
      max-width:100%;
    }
    .alink:hover{background:#fafafa}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">ì§„ë„ Â· ìƒë‹´ ë©”ëª¨</div>
    <div class="meta" id="meta"></div>

    <div class="row" id="modeRow"></div>

    <div class="topbar" style="margin-top:10px">
      <div class="leftgroup" id="navRow"></div>

      <div class="rightgroup">
        <div id="roundWrap" style="display:none; gap:8px; align-items:center;">
          <span class="badge">íšŒì°¨/ë‚ ì§œ</span>
          <select id="roundSel"></select>
        </div>
      </div>
    </div>
  </div>

  <div id="content"></div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const norm = (v) => String(v ?? "").trim();

  const qs = new URLSearchParams(location.search);
  const adminParam = qs.get("admin");          // âœ… URLì— ìˆì„ ë•Œë§Œ ê´€ë¦¬ì
  const idParam = qs.get("id");
  const tParam  = qs.get("t") || qs.get("token");

  const isAdmin = (norm(adminParam) === norm(ADMIN_TOKEN));

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }

  function pickName(s){ return s.studentName ?? s.studentname ?? s.name ?? s["í•™ìƒëª…"] ?? s["ì´ë¦„"] ?? s["ì„±ëª…"] ?? s.id ?? "-"; }
  function pickId(s){ return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["í•™ìƒID"] ?? s["í•™ë²ˆ"] ?? null; }
  function pickToken(s){ return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["í† í°"] ?? null; }

  const pickText = (...vals) => {
    for(const v of vals){
      const s = String(v ?? "").trim();
      if(s) return s;
    }
    return "";
  };

  function normalizeArrayish(x){
    if(Array.isArray(x)) return x.slice();
    if(!x || typeof x!=="object") return [];
    for(const k of ["records","rows","items","data","notes","progress"]){
      if(Array.isArray(x[k])) return x[k].slice();
    }
    const out = [];
    for(const [k,v] of Object.entries(x)){
      if(Array.isArray(v)) out.push(...v.map(r => ({...r, id:(r?.id ?? k)})));
      else if(v && typeof v==="object") out.push({...v, id:(v?.id ?? k)});
    }
    return out;
  }

  // progress_notes.json(ì§€ê¸ˆ ë„¤ ë°ì´í„°)ì˜ ë‚ ì§œ ê¸°ë°˜ ê·¸ë£¹ í‚¤
  function roundKeyOf(n){
    const r = pickText(n.round, n.Round, n["íšŒì°¨"], n["ì°¨ìˆ˜"]);
    const d = pickText(n.date, n.Date, n["ë‚ ì§œ"], n["ì¼ì"]);
    if(r && d) return `#${r} (${d})`;
    if(r) return `#${r}`;
    if(d) return `${d}`;
    return "ë¯¸ì§€ì •";
  }

  function tagFromStatusOrType(n){
    const status = pickText(n.status, n["ìƒíƒœ"]);
    const type   = pickText(n.type, n["ìœ í˜•"]);
    const text = status || type;
    if(!text) return null;

    const low = text.toLowerCase();
    // ìƒíƒœ ê¸°ë°˜ ì¶”ì²œ ìƒ‰
    if(low.includes("ì™„ë£Œ") || low.includes("ì™„") || low.includes("good") || low.includes("ok"))
      return { text, cls:"tag t-good" };
    if(low.includes("ì§„í–‰") || low.includes("ì¤‘") || low.includes("ëŒ€ê¸°"))
      return { text, cls:"tag t-mid" };
    if(low.includes("ë³´ë¥˜") || low.includes("ë¯¸í¡") || low.includes("ê²½ê³ ") || low.includes("ë¬¸ì œ"))
      return { text, cls:"tag t-bad" };

    // ìœ í˜•ì€ ê¸°ë³¸ tag
    return { text, cls:"tag" };
  }

  function subjectOrder(subject){
    const s = String(subject||"");
    const map = {"êµ­ì–´":1,"ìˆ˜í•™":2,"ì˜ì–´":3,"íƒ1":4,"íƒ2":5,"íƒêµ¬1":4,"íƒêµ¬2":5,"ê³µí†µ":6};
    return map[s] ?? 99;
  }

  function parseDateValue(key){
    // keyê°€ YYYY-MM-DDë©´ ë‚ ì§œë¡œ ë¹„êµ, ì•„ë‹ˆë©´ ë¬¸ìì—´
    const m = String(key).match(/\d{4}-\d{2}-\d{2}/);
    if(!m) return null;
    const t = Date.parse(m[0]);
    return Number.isFinite(t) ? t : null;
  }

  function renderRound(key, byRound){
    const list = (byRound.get(key) || []).slice();
    if(!list.length){
      $("#content").innerHTML = `<div class="card"><div class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
      return;
    }

    list.sort((a,b)=>{
      const sa = pickText(a.subject, a["ê³¼ëª©"]);
      const sb = pickText(b.subject, b["ê³¼ëª©"]);
      const oa = subjectOrder(sa);
      const ob = subjectOrder(sb);
      if(oa!==ob) return oa-ob;
      // ê°™ì€ ê³¼ëª©ì´ë©´ ìœ í˜•/ì œëª©ìœ¼ë¡œ ì •ë ¬
      const ta = pickText(a.type, a["ìœ í˜•"]);
      const tb = pickText(b.type, b["ìœ í˜•"]);
      if(ta !== tb) return ta.localeCompare(tb,"ko");
      const xa = pickText(a.title, a["ì œëª©"]);
      const xb = pickText(b.title, b["ì œëª©"]);
      return xa.localeCompare(xb,"ko");
    });

    const cards = list.map(n=>{
      const subject = pickText(n.subject, n["ê³¼ëª©"]);
      if(!subject) return "";

      const type   = pickText(n.type, n["ìœ í˜•"]);
      const title  = pickText(n.title, n["ì œëª©"]);
      const date   = pickText(n.date, n["ë‚ ì§œ"]);
      const tag    = tagFromStatusOrType(n);

      // ë„¤ ë°ì´í„° í•„ë“œë“¤(ë¹ˆê°’ì€ ìë™ ìˆ¨ê¹€)
      const diagnosis = pickText(n.diagnosis, n["ì§„ë‹¨"]);
      const feedback  = pickText(n.feedback, n["í”¼ë“œë°±"]);
      const note      = pickText(n.note, n["ë©”ëª¨"]);
      const action    = pickText(n.action, n["ì•¡ì…˜"], n["ê³¼ì œ"]);
      const next      = pickText(n.next, n["ë‹¤ìŒ"]);

      const rows = [];
      if(type)      rows.push(`<div class="k">ìœ í˜•</div><div class="v">${esc(type)}</div>`);
      if(title)     rows.push(`<div class="k">ì œëª©</div><div class="v">${esc(title)}</div>`);
      if(diagnosis) rows.push(`<div class="k">ì§„ë‹¨</div><div class="v">${esc(diagnosis)}</div>`);
      if(feedback)  rows.push(`<div class="k">í”¼ë“œë°±</div><div class="v">${esc(feedback)}</div>`);
      if(note)      rows.push(`<div class="k">ë©”ëª¨</div><div class="v">${esc(note)}</div>`);
      if(action)    rows.push(`<div class="k">ì‹¤í–‰</div><div class="v">${esc(action)}</div>`);
      if(next)      rows.push(`<div class="k">ë‹¤ìŒ</div><div class="v">${esc(next)}</div>`);

      const kv = rows.length ? `<div class="kv">${rows.join("")}</div>` : "";

      // evidence ë§í¬
      const ev = Array.isArray(n.evidence) ? n.evidence : [];
      const links = ev
        .filter(x => x && x.url)
        .map(x => {
          const label = pickText(x.label, x.title, "ìë£Œ");
          return `<a class="alink" href="${esc(x.url)}" target="_blank" rel="noopener noreferrer">ğŸ”— ${esc(label)}</a>`;
        })
        .join("");

      const linkBox = links ? `<div class="links">${links}</div>` : "";

      return `
        <div class="pbox">
          <div class="ptop">
            <div style="min-width:0">
              <div class="ptitle">${esc(subject)}</div>
              <div class="psub">${date ? `ë‚ ì§œ: ${esc(date)} Â· ` : ``}${title ? esc(title) : ``}</div>
            </div>
            ${tag ? `<span class="${tag.cls}">${esc(tag.text)}</span>` : ``}
          </div>
          ${kv}
          ${linkBox}
        </div>
      `;
    }).join("");

    $("#content").innerHTML = `
      <div class="card">
        <div class="badge">í‘œì‹œ ê¸°ì¤€: ì…ë ¥ëœ í•­ëª©ë§Œ ë…¸ì¶œ (ë¹ˆê°’ ìë™ ìˆ¨ê¹€)</div>
      </div>
      <div class="grid">
        ${cards || `<div class="card"><div class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`}
      </div>
    `;
  }

  async function main(){
    // 1) í•™ìƒ ì°¾ê¸° (í•™ìƒ ëª¨ë“œëŠ” tokenë§Œ / ê´€ë¦¬ìë§Œ id í—ˆìš©)
    const students = await loadJson("./students.json");
    if(!Array.isArray(students)) throw new Error("students.json is not an array");

    let student = null;
    if(isAdmin && idParam){
      student = students.find(s => norm(pickId(s)) === norm(idParam));
    }
    if(!student && tParam){
      student = students.find(s => norm(pickToken(s)) === norm(tParam));
    }
    if(!student){
      $("#hdr").textContent = "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
      $("#meta").innerHTML = `
        <div class="warn">í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="muted">ê´€ë¦¬ì: progress_detail.html?id=í•™ìƒID&admin=ê´€ë¦¬ìí† í° / í•™ìƒ: progress_detail.html?t=ê°œë³„í† í°</div>
      `;
      return;
    }

    const sid  = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").textContent = `ì§„ë„ Â· ìƒë‹´ ë©”ëª¨ Â· ${name}${sid?` (${sid})`:``}`;

    // í•™ìƒ ë©”íƒ€ë„ "ì…ë ¥ëœ ê²ƒë§Œ" í‘œì‹œ
    const metaRows = [];
    const school = pickText(student.school, student["í•™êµ"]);
    const career = pickText(student.career, student["ì§„ë¡œ"]);
    const adm    = pickText(student.admission, student["ì „í˜•"]);
    if(school) metaRows.push(`í•™êµ: ${esc(school)}`);
    if(career) metaRows.push(`ì§„ë¡œ: ${esc(career)}`);
    if(adm)    metaRows.push(`ì „í˜•: ${esc(adm)}`);
    $("#meta").innerHTML = metaRows.length ? metaRows.join("<br>") : `<span class="muted">í•™ìƒ ë©”íƒ€ ì •ë³´ ì—†ìŒ</span>`;

    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">ê´€ë¦¬ì ëª¨ë“œ</span><span class="muted">idë¡œ ì ‘ê·¼</span>`
      : `<span class="pill">í•™ë¶€ëª¨/í•™ìƒ ëª¨ë“œ</span><span class="muted">í† í° ì ‘ê·¼</span>`;

    // 2) ë„¤ë¹„ ë²„íŠ¼ (ê´€ë¦¬ìëŠ” adminParamì„ ê·¸ëŒ€ë¡œ ìœ ì§€)
    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(adminParam)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;

    const univHref = isAdmin
      ? `./univ_list.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(adminParam)}`
      : `./univ_list.html?t=${encodeURIComponent(stok)}`;

    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">â† ì„±ì  ë³´ê¸°</a>`);
    nav.push(`<a class="btn" href="${univHref}">ëŒ€í•™ ìƒí–¥/ì ì •</a>`);
    if(isAdmin){
      nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(adminParam)}">í•™ìƒ ëª©ë¡</a>`);
    }
    $("#navRow").innerHTML = nav.join("");

    // 3) ì§„ë„/ë©”ëª¨ ë°ì´í„° ë¡œë”©
    let rawNotes = null;
    try{
      rawNotes = await loadJson("./progress_notes.json");
    }catch(e){
      try{
        rawNotes = await loadJson("./progress.json");
      }catch(e2){
        rawNotes = [];
      }
    }

    const notes = normalizeArrayish(rawNotes)
      .filter(n => norm(n?.id) === sid);

    if(!notes.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">ì§„ë„/ìƒë‹´ ë©”ëª¨ ë°ì´í„° ì—†ìŒ</div>
          <div class="muted">progress_notes.json(ë˜ëŠ” progress.json)ì— id=${esc(sid)} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      `;
      return;
    }

    // 4) ê·¸ë£¹í•‘
    const byRound = new Map();
    for(const n of notes){
      const key = roundKeyOf(n);
      if(!byRound.has(key)) byRound.set(key, []);
      byRound.get(key).push(n);
    }

    // 5) í‚¤ ì •ë ¬: ìµœì‹  ë‚ ì§œ ìš°ì„ (ë‚´ë¦¼ì°¨ìˆœ), ë¯¸ì§€ì •ì€ ë§¨ ë’¤
    const keys = [...byRound.keys()];
    keys.sort((a,b)=>{
      if(a==="ë¯¸ì§€ì •" && b!=="ë¯¸ì§€ì •") return 1;
      if(b==="ë¯¸ì§€ì •" && a!=="ë¯¸ì§€ì •") return -1;
      const da = parseDateValue(a);
      const db = parseDateValue(b);
      if(da!=null && db!=null) return db - da; // ìµœì‹  ë¨¼ì €
      return String(b).localeCompare(String(a),"ko"); // fallback: ì—­ìˆœ
    });

    // 6) selector
    const roundWrap = $("#roundWrap");
    const roundSel = $("#roundSel");
    if(keys.length >= 2){
      roundWrap.style.display = "inline-flex";
      roundSel.innerHTML = keys.map(k => `<option value="${esc(k)}">${esc(k)}</option>`).join("");
      roundSel.value = keys[0]; // âœ… ìµœì‹  ê¸°ë³¸
      roundSel.addEventListener("change", ()=> renderRound(roundSel.value, byRound));
      renderRound(roundSel.value, byRound);
    }else{
      roundWrap.style.display = "none";
      renderRound(keys[0], byRound);
    }
  }

  main().catch(err=>{
    $("#hdr").textContent = "ì˜¤ë¥˜";
    $("#meta").innerHTML = `<div class="warn">ë¡œë”© ì˜¤ë¥˜</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
