<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>진도 상세</title>
  <style>
    html,body{width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px;background:#fff;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:16px;margin:14px 0;background:#fff}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .meta{opacity:.85;line-height:1.7}
    .pill{display:inline-flex;align-items:center;border:2px solid #111;border-radius:999px;padding:7px 12px;font-weight:900}
    .badge{display:inline-flex;align-items:center;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-weight:800;background:#fff}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none;color:#111;background:#fff}
    .btn:hover{background:#fafafa}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    select{
      border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;font-weight:700;
      width:min(260px, 100%);
    }
    option{font-weight:700}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;align-items:start}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .grid > *{min-width:0}

    .group{border:1px solid #eee;border-radius:16px;padding:12px}
    .group h3{margin:0 0 10px;font-size:16px;font-weight:900}

    .item{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      border:1px solid #eee;border-radius:14px;padding:10px 12px;margin:8px 0;cursor:pointer
    }
    .item:hover{background:#fafafa}
    .left{min-width:0}
    .unit{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .topic{margin-top:4px;font-size:12px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .when{margin-top:4px;font-size:12px;opacity:.7}
    .status{flex:0 0 auto}
    .s-good{border-color:#1f7a1f}
    .s-mid{border-color:#666}
    .s-bad{border-color:#b00020}

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;border-radius:18px;border:1px solid #ddd;
      padding:14px;
    }
    .modal-head{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px}
    .modal-title{font-size:16px;font-weight:900;min-width:0}
    .xbtn{border:1px solid #111;border-radius:12px;background:#fff;padding:8px 10px;cursor:pointer;font-weight:900}
    .xbtn:hover{background:#fafafa}
    .kv{margin-top:10px;border-top:1px solid #eee;padding-top:10px;line-height:1.7}
    .kv b{display:block;margin-top:8px}
    .hr{height:1px;background:#eee;margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title" id="hdr">진도 상세</div>
    <div class="meta" id="meta"></div>
    <div class="row" id="modeRow" style="margin-top:10px;"></div>
    <div class="row" id="navRow" style="margin-top:10px;"></div>

    <div class="filters" id="filters" style="display:none;">
      <select id="subjectFilter">
        <option value="__all__">전체 과목</option>
      </select>
      <select id="statusFilter">
        <option value="__all__">전체 상태</option>
        <option value="잘함">잘함</option>
        <option value="보통">보통</option>
        <option value="부족">부족</option>
      </select>
    </div>
  </div>

  <div id="content"></div>
</div>

<div class="modal-backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div class="modal-title" id="mTitle"></div>
      <button class="xbtn" id="mClose">닫기</button>
    </div>
    <div class="hr"></div>
    <div id="mBody" class="kv"></div>
  </div>
</div>

<script>
(() => {
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";
  const LS_KEY = "__ADMIN_TOKEN__";
  const norm = (v)=>String(v ?? "").trim();

  const qs = new URLSearchParams(location.search);
  const adminParam = qs.get("admin");
  const adminSaved = localStorage.getItem(LS_KEY);
  const admin = adminParam || adminSaved;

  const idParam = qs.get("id");
  const tParam = qs.get("t") || qs.get("token");

  const isAdmin = (norm(admin) === norm(ADMIN_TOKEN));
  if (adminParam && isAdmin) localStorage.setItem(LS_KEY, adminParam);

  const $ = (s)=>document.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed ("+r.status+")");
    return r.json();
  }
  async function loadJsonOptional(path){
    try{
      const r = await fetch(path, { cache:"no-store" });
      if(!r.ok) return [];
      const j = await r.json();
      return Array.isArray(j) ? j : [];
    }catch(e){
      return [];
    }
  }

  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }
  function pickId(s){
    return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null;
  }
  function pickToken(s){
    return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null;
  }

  function statusClass(st){
    if(st==="잘함") return "s-good";
    if(st==="부족") return "s-bad";
    return "s-mid";
  }

  // modal
  const backdrop = $("#backdrop");
  const mTitle = $("#mTitle");
  const mBody = $("#mBody");
  $("#mClose").addEventListener("click", ()=> backdrop.style.display="none");
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) backdrop.style.display="none"; });

  function openModal(title, html){
    mTitle.textContent = title;
    mBody.innerHTML = html;
    backdrop.style.display = "flex";
  }

  function maxDateStr(arr, key){
    const vals = arr.map(x=>norm(x?.[key])).filter(Boolean);
    if(!vals.length) return "-";
    vals.sort();
    return vals[vals.length-1];
  }

  function getProgressItems(progressAll, sid){
    const all = Array.isArray(progressAll) ? progressAll : [];

    // wrapped schema
    const wrapped = all.find(x => norm(x?.id) === norm(sid) && Array.isArray(x?.progress));
    if(wrapped){
      const items = Array.isArray(wrapped.progress) ? wrapped.progress : [];
      const updated = norm(wrapped.updated) || maxDateStr(items, "last_update") || "-";
      return { items, updated };
    }

    // flat schema
    const flatRows = all.filter(x => norm(x?.id) === norm(sid));
    const items = flatRows.map(x=>({
      subject: x.subject ?? x["과목"] ?? "-",
      unit: x.unit ?? x["단원"] ?? "-",
      topic: x.topic ?? x["주제"] ?? "",
      status: x.status ?? x["상태"] ?? "보통",
      comment: x.comment ?? x["코멘트"] ?? "",
      last_update: x.last_update ?? x["업데이트"] ?? ""
    }));
    const updated = maxDateStr(flatRows, "last_update") || "-";
    return { items, updated };
  }

  // ✅ notes 매칭 강화: note.unit이 item.unit 또는 item.topic 모두 매칭되도록
  function findNote(notesAll, sid, subject, unit, topic){
    const notes = Array.isArray(notesAll) ? notesAll : [];
    const id = norm(sid), sub = norm(subject), u = norm(unit), t = norm(topic);

    const sameBase = (n)=> norm(n.id)===id && norm(n.subject)===sub;

    // 1) topic까지 있는 notes schema를 대비한 exact
    let n = notes.find(n => sameBase(n) && norm(n.unit)===u && (("topic" in n) ? norm(n.topic)===t : true));
    if(n) return n;

    // 2) 일반 케이스: unit 매칭
    n = notes.find(n => sameBase(n) && norm(n.unit)===u);
    if(n) return n;

    // 3) 네 데이터 케이스: notes.unit == item.topic (주제를 unit에 적어둔 경우)
    if(t){
      n = notes.find(n => sameBase(n) && norm(n.unit)===t);
      if(n) return n;
    }

    // 4) 마지막 안전망(너무 과하지 않게): 부분 포함
    n = notes.find(n => sameBase(n) && (u && norm(n.unit) && (u.includes(norm(n.unit)) || norm(n.unit).includes(u) || (t && (t.includes(norm(n.unit)) || norm(n.unit).includes(t))))));
    return n || null;
  }

  async function main(){
    const students = await loadJson("./students.json");
    if(!Array.isArray(students)) throw new Error("students.json is not an array");

    let student = null;
    if(isAdmin && idParam){
      student = students.find(s => norm(pickId(s)) === norm(idParam));
    }
    if(!student && tParam){
      student = students.find(s => norm(pickToken(s)) === norm(tParam));
    }

    if(!student){
      $("#hdr").textContent = "접근 권한이 없습니다.";
      $("#meta").innerHTML = `
        <div class="warn">학생을 찾을 수 없습니다.</div>
        <div class="muted">관리자: progress_detail.html?id=학생ID&admin=관리자토큰 / 학생: progress_detail.html?t=개별토큰</div>
      `;
      return;
    }

    const sid = norm(pickId(student));
    const stok = norm(pickToken(student));
    const name = pickName(student);

    $("#hdr").textContent = `진도 상세 · ${name}${sid ? " ("+sid+")" : ""}`;
    $("#meta").innerHTML = `
      학교: ${esc(student.school||"-")}<br>
      진로: ${esc(student.career||"-")}<br>
      전형: ${esc(student.admission||"-")}
    `;

    $("#modeRow").innerHTML = isAdmin
      ? `<span class="pill">관리자 모드</span><span class="muted">id로 접근</span>`
      : `<span class="pill">학부모/학생 모드</span><span class="muted">토큰 접근</span>`;

    const studentHref = isAdmin
      ? `./student.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./student.html?t=${encodeURIComponent(stok)}`;

    const nav = [];
    nav.push(`<a class="btn" href="${studentHref}">← 학생 상세로</a>`);
    if(isAdmin){
      nav.push(`<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">학생 목록</a>`);
    }
    $("#navRow").innerHTML = nav.join("");

    const progressAll = await loadJson("./progress.json");
    const notesAll = await loadJsonOptional("./progress_notes.json");

    const { items, updated } = getProgressItems(progressAll, sid);

    if(!items.length){
      $("#content").innerHTML = `
        <div class="card">
          <div class="warn">진도 데이터가 없습니다.</div>
          <div class="muted">progress.json에 id=${esc(sid)} 데이터가 있는지 확인하세요.</div>
        </div>
      `;
      return;
    }

    $("#filters").style.display = "flex";

    const subjects = [...new Set(items.map(x=>x.subject).filter(Boolean))]
      .sort((a,b)=>String(a).localeCompare(String(b),"ko"));
    const subjSel = $("#subjectFilter");
    subjects.forEach(s=>{
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      subjSel.appendChild(o);
    });
    const statusSel = $("#statusFilter");

    function render(){
      const subj = subjSel.value;
      const st = statusSel.value;

      const filtered = items.filter(x=>{
        const okSubj = (subj==="__all__" ? true : x.subject===subj);
        const okSt = (st==="__all__" ? true : x.status===st);
        return okSubj && okSt;
      });

      const bySubject = {};
      filtered.forEach(x=>{
        const key = x.subject || "-";
        bySubject[key] = bySubject[key] || [];
        bySubject[key].push(x);
      });

      const content = $("#content");
      content.innerHTML = `
        <div class="card">
          <div class="row">
            <span class="badge">업데이트: ${esc(updated)}</span>
            <span class="badge muted">표시 항목: ${filtered.length}개</span>
          </div>
          <div class="muted">항목을 클릭하면 상세 코멘트를 팝업으로 봅니다.</div>
        </div>
      `;

      const grid = document.createElement("div");
      grid.className = "grid";

      Object.keys(bySubject).sort((a,b)=>a.localeCompare(b,"ko")).forEach(sub=>{
        const group = document.createElement("div");
        group.className = "group";
        group.innerHTML = `<h3>${esc(sub)}</h3>`;

        bySubject[sub].forEach(it=>{
          const unit = it.unit || "-";
          const topic = it.topic || "";
          const status = it.status || "보통";
          const when = it.last_update || "";

          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="left">
              <div class="unit">${esc(unit)}</div>
              ${topic ? `<div class="topic">${esc(topic)}</div>` : ``}
              ${when ? `<div class="when">업데이트: ${esc(when)}</div>` : ``}
            </div>
            <div class="badge status ${statusClass(status)}">${esc(status)}</div>
          `;

          row.addEventListener("click", ()=>{
            const note = findNote(notesAll, sid, sub, unit, topic);

            if(note){
              openModal(`${sub} · ${unit}${topic ? " · "+topic : ""}`, `
                <div><span class="badge ${statusClass(note.level||status)}">${esc(note.level||status)}</span></div>
                <b>잘한 점</b><div>${esc(note.good||"-")}</div>
                <b>부족한 점</b><div>${esc(note.bad||"-")}</div>
                <b>개선 방법</b><div>${esc(note.fix||"-")}</div>
              `);
            }else{
              const comment = it.comment || "";
              openModal(`${sub} · ${unit}${topic ? " · "+topic : ""}`, `
                <div><span class="badge ${statusClass(status)}">${esc(status)}</span></div>
                ${comment ? `<b>코멘트</b><div>${esc(comment)}</div>` : `
                  <b>코멘트</b>
                  <div class="muted">등록된 코멘트가 없습니다. (progress_notes.json 또는 progress.json의 comment에 추가하면 표시됩니다.)</div>
                `}
              `);
            }
          });

          group.appendChild(row);
        });

        grid.appendChild(group);
      });

      content.appendChild(grid);
    }

    subjSel.addEventListener("change", render);
    statusSel.addEventListener("change", render);
    render();
  }

  main().catch(err=>{
    $("#hdr").textContent = "오류";
    $("#meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${esc(err.message)}</div>`;
  });
})();
</script>
</body>
</html>
