<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>진도 상세</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px}
    .wrap{max-width:920px}
    .card{border:1px solid #ddd;border-radius:16px;padding:16px;background:#fff}
    h1{margin:0 0 10px}
    .meta{color:#555;line-height:1.8}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .pill{display:inline-block;border:2px solid #111;border-radius:999px;padding:8px 14px;font-weight:900;background:#fff}
    .badge{font-weight:900;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:3px 8px;background:#f7f7f7}
    .ok{color:#0a7;border-color:#0a7;background:#f1fff9}
    .mid{color:#555}
    .up{color:#b86b00;border-color:#b86b00;background:#fff8ee}
    .bad{color:#b00020;border-color:#b00020;background:#fff1f3}
    .btn{display:inline-block;text-decoration:none;border:2px solid #111;padding:10px 14px;border-radius:14px;font-weight:900;background:#fff}
    .btn:hover{background:#111;color:#fff}
    .box{border:1px solid #eee;border-radius:14px;padding:12px;background:#fafafa;margin-top:10px;line-height:1.8}
    .small{font-size:12px;opacity:.75;line-height:1.6}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">로딩중…</h1>
    <div class="meta" id="meta"></div>

    <div class="row" style="margin-top:14px">
      <span class="pill">평가</span>
      <span id="statusBadge" class="badge mid">미평가</span>
    </div>

    <div class="box" id="detailBox"></div>

    <div class="row" style="margin-top:14px">
      <a class="btn" id="backBtn" href="#">학생 화면으로</a>
      <a class="btn" href="javascript:window.close()">창 닫기</a>
    </div>
    <div class="small">※ 이 페이지는 선생님이 입력한 “문제/원인”을 바탕으로 상담용으로 쓰기 좋게 구성되어 있습니다.</div>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const studentId = qs.get("id")||"";
  const token = qs.get("t")||"";
  const round = qs.get("round")||"";
  const subjectQ = qs.get("subject")||"";
  const topicQ = qs.get("topic")||"";

  const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const norm = (s)=> String(s ?? "").trim().toLowerCase();

  async function fetchJSON(path){
    const r = await fetch(path,{cache:"no-store"});
    if(!r.ok) throw new Error("fetch fail "+path);
    return await r.json();
  }

  function statusClass(status){
    const s = String(status||"").trim();
    if (!s) return "mid";
    if (s.includes("잘")) return "ok";
    if (s.includes("보통")) return "mid";
    if (s.includes("보완") || s.includes("위험")) return "bad";
    return "up";
  }

  function getNoteFields(n){
    return {
      subject: n.subject ?? n["과목"] ?? "",
      topic: n.topic ?? n["진도"] ?? n["진도(단원/주제)"] ?? "",
      status: n.status ?? n["평가"] ?? "",
      summary: n.summary ?? n["문제요약"] ?? n["문제요약(한줄)"] ?? "",
      cause: n.cause ?? n["원인"] ?? "",
      action: n.action ?? n["보완전략"] ?? n["개선방향"] ?? ""
    };
  }

  async function requireAuth(){
    if(!studentId || !token){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2>";
      throw new Error("unauthorized");
    }
    const students = await fetchJSON("./students.json");
    const st = (students||[]).find(x=>x.id===studentId);
    if(!st || String(st.token||"") !== String(token)){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2>";
      throw new Error("unauthorized");
    }
    return st;
  }

  async function main(){
    const st = await requireAuth();
    document.getElementById("backBtn").href = `./student.html?id=${encodeURIComponent(studentId)}&t=${encodeURIComponent(token)}&round=${encodeURIComponent(round)}`;

    const notes = await fetchJSON("./progress_notes.json").catch(()=>[]);
    const cand = (notes||[]).filter(n => String(n.id)===String(studentId) && String(n.round)===String(round));

    // subject+topic 최대한 매칭
    const sKey = norm(subjectQ), tKey = norm(topicQ);
    let pick = null;

    for(const n of cand){
      const f = getNoteFields(n);
      if(norm(f.subject)===sKey && (norm(f.topic)===tKey || norm(f.topic).includes(tKey) || tKey.includes(norm(f.topic)))) { pick=n; break; }
    }
    if(!pick){
      for(const n of cand){
        const f = getNoteFields(n);
        if(norm(f.subject)===sKey) { pick=n; break; }
      }
    }

    const title = `${subjectQ || "진도"} · #${round}`;
    document.getElementById("title").textContent = title;
    document.getElementById("meta").innerHTML =
      `학생: <b>${esc(st.studentname||st.studentName||st.name||st.id||"-")}</b><br/>학교: <b>${esc(st.school||"-")}</b><br/>진도: <b>${esc(topicQ||"-")}</b>`;

    const badge = document.getElementById("statusBadge");
    const box = document.getElementById("detailBox");

    if(!pick){
      badge.textContent = "미평가";
      badge.className = "badge mid";
      box.innerHTML = `
        <b>아직 평가/메모가 없습니다.</b><br/>
        - progress_notes.json에 (id, round, 과목, 진도) 기준으로 평가/문제요약/원인을 입력하면 이 화면에 표시됩니다.
      `;
      return;
    }

    const f = getNoteFields(pick);
    const cls = statusClass(f.status);
    badge.textContent = f.status || "미평가";
    badge.className = `badge ${cls}`;

    box.innerHTML = `
      <b>문제 요약</b><br/>
      ${esc(f.summary || "—")}<br/><br/>
      <b>원인(왜 막혔나)</b><br/>
      ${esc(f.cause || "—")}<br/><br/>
      <b>보완/다음 액션</b><br/>
      ${esc(f.action || "—")}
    `;
  }

  main().catch(()=>{});
</script>
</body>
</html>
