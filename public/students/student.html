<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 성적</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:24px}
    a{color:#111;text-decoration:none}
    .wrap{max-width:980px}
    .title{font-size:22px;font-weight:900;margin:10px 0}
    .sub{opacity:.75;margin-bottom:10px;line-height:1.6}
    .box{border:1px solid #ddd;border-radius:12px;padding:14px;margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:center;white-space:nowrap}
    th{background:#fafafa}

    /* ✅ 모바일에서 그래프가 뭉치지 않게: 높이 고정 + 가로 스크롤 */
    .chartWrap{position:relative;width:100%;height:340px}
    .chipRow{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .chip{
      border:1px solid #111;border-radius:999px;padding:8px 12px;
      font-weight:800;background:#fff;cursor:pointer;
      user-select:none;
    }
    .chip.on{background:#111;color:#fff}
    .hint{opacity:.75;font-size:13px;line-height:1.5}
    .metaLine{margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .badge{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px;opacity:.85}

    @media (max-width:600px){
      body{margin:14px}
      .chartWrap{height:260px}
      th,td{font-size:13px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <a href="./">← 학생 목록으로</a>

    <div id="header" class="box">로딩 중...</div>

    <div class="box">
      <div class="chipRow" id="chips"></div>

      <div class="hint">
        • 생윤/사문은 50점 만점, 나머지는 100점 만점 기준<br/>
        • “1등급 컷”은 <b>scores.json에 과목별 컷 점수(예: 국어컷)</b>로 같이 업로드하면 자동 표시됩니다.
      </div>

      <div class="metaLine" id="metaLine"></div>

      <div class="chartWrap">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="box">
      <div style="font-weight:900;margin-bottom:8px">회차별 점수</div>
      <div id="table"></div>
    </div>
  </div>

<script>
  // ✅ 과목/만점(축) 설정
  const SUBJECTS = ["국어","수학","영어","생윤","사문"];
  const MAX_SCORE = { "국어":100, "수학":100, "영어":100, "생윤":50, "사문":50 };

  let chartInstance = null;
  let currentSubject = "국어";
  let cachedScores = [];

  function getId(){
    const u = new URL(location.href);
    return u.searchParams.get("id");
  }

  function clean(s){
    return String(s ?? "").replace(/\s+/g,"").replace(/[()]/g,"");
  }
  function toNum(v){
    if (v === null || v === undefined || v === "") return null;
    const n = Number(String(v).replace(/[^\d.-]/g,""));
    return Number.isFinite(n) ? n : null;
  }

  async function loadStudentMeta(id){
    const res = await fetch("./students.json", { cache:"no-store" });
    const list = await res.json();
    return list.find(x => x.id === id);
  }

  async function loadScores(id){
    const res = await fetch("./scores.json", { cache:"no-store" });
    const all = await res.json();
    const rows = Array.isArray(all) ? all : (all.scores || []);

    // id 키 폭넓게
    const getRowId = (r) => r.id ?? r.studentId ?? r["학생ID"] ?? r["학생id"] ?? r["학생Id"] ?? r["학생ID "] ?? null;

    // 과목 alias (혹시 키가 다를 때)
    const SUBJECT_ALIASES = {
      "국어": ["국어","국","KOR","korean","국어점수","국어 점수"],
      "수학": ["수학","수","MATH","math","수학점수","수학 점수"],
      "영어": ["영어","영","ENG","english","영어점수","영어 점수"],
      "생윤": ["생윤","생명윤리","ETHICS","ethics","생명윤리점수","생윤점수"],
      "사문": ["사문","사회문화","SOC","society","사회문화점수","사문점수"]
    };

    // 컷 alias (업로드 시 추천: 국어컷/수학컷...)
    const CUT_ALIASES = {
      "국어": ["국어컷","국어 컷","국어1컷","국어1등급컷","국어_컷","국어cut"],
      "수학": ["수학컷","수학 컷","수학1컷","수학1등급컷","수학_컷","수학cut"],
      "영어": ["영어컷","영어 컷","영어1컷","영어1등급컷","영어_컷","영어cut"],
      "생윤": ["생윤컷","생윤 컷","생윤1컷","생윤1등급컷","생윤_컷","생윤cut","생명윤리컷"],
      "사문": ["사문컷","사문 컷","사문1컷","사문1등급컷","사문_컷","사문cut","사회문화컷"]
    };

    function pickValue(bag, candidates){
      for (const a of candidates){
        if (bag[a] !== undefined) return bag[a];
        const kk = Object.keys(bag).find(k => clean(k) === clean(a));
        if (kk && bag[kk] !== undefined) return bag[kk];
      }
      return undefined;
    }

    // 내 학생만 필터
    const mine = rows.filter(r => getRowId(r) === id);
    if (!mine.length) return [];

    // 가로형만 지원(현재 구조 기준)
    return mine.map(r => {
      const round = Number(r.round ?? r["회차"] ?? r["차수"] ?? r["주차"] ?? 0);
      const date  = r.date ?? r["날짜"] ?? r["시험일"] ?? "";

      const out = { round, date, cut:{} };

      // 점수
      for (const std of SUBJECTS){
        const v = pickValue(r, SUBJECT_ALIASES[std]);
        out[std] = toNum(v);
      }

      // 1등급 컷
      for (const std of SUBJECTS){
        const cv = pickValue(r, CUT_ALIASES[std]);
        out.cut[std] = toNum(cv);
      }

      return out;
    });
  }

  function renderHeader(meta, id){
    const el = document.getElementById("header");
    const name = meta?.studentName ?? meta?.name ?? meta?.["학생명"] ?? meta?.["이름"] ?? id;

    el.innerHTML = `
      <div class="title">${name} <span style="opacity:.6;font-weight:800">(${id})</span></div>
      <div class="sub">
        학교: ${meta?.school || "-"} · 진로: ${meta?.career || "-"} · 전형: ${meta?.admission || "-"}
      </div>
      <div class="hint">데이터 파일: <b>students/scores.json</b> (id=${id})</div>
    `;
  }

  function renderChips(){
    const wrap = document.getElementById("chips");
    wrap.innerHTML = SUBJECTS.map(s => `
      <button type="button" class="chip ${s===currentSubject?'on':''}" data-sub="${s}">${s}</button>
    `).join("");

    // ✅ 클릭 즉시 반영 (추가 화면 클릭 필요 없음)
    wrap.querySelectorAll(".chip").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        currentSubject = btn.dataset.sub;
        renderChips();
        renderMetaLine(cachedScores);
        renderChart(cachedScores);
      });
    });
  }

  function renderMetaLine(scores){
    const line = document.getElementById("metaLine");
    const max = MAX_SCORE[currentSubject] ?? 100;

    const latest = scores.length ? scores[scores.length-1] : null;
    const latestScore = latest ? latest[currentSubject] : null;
    const latestCut   = latest?.cut ? latest.cut[currentSubject] : null;

    line.innerHTML = `
      <span class="badge">선택 과목: <b>${currentSubject}</b></span>
      <span class="badge">만점: <b>${max}</b>점</span>
      <span class="badge">최근 점수: <b>${latestScore ?? "-"}</b></span>
      <span class="badge">1등급 컷: <b>${latestCut ?? "-"}</b></span>
    `;
  }

  function renderTable(scores){
    const rows = scores.map(r => `
      <tr>
        <td>${r.round ?? "-"}</td>
        <td>${r.date || "-"}</td>
        ${SUBJECTS.map(s => `<td>${(r[s] ?? "-")}</td>`).join("")}
      </tr>
    `).join("");

    document.getElementById("table").innerHTML = `
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>회차</th><th>날짜</th>
              ${SUBJECTS.map(s=>`<th>${s}</th>`).join("")}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderChart(scores){
    const labels = scores.map(r => `${r.round}회`);
    const max = MAX_SCORE[currentSubject] ?? 100;

    const scoreSeries = scores.map(r => r[currentSubject] ?? null);
    const cutSeries   = scores.map(r => (r.cut ? r.cut[currentSubject] : null));

    const ctx = document.getElementById("chart");
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: `${currentSubject} 점수`,
            data: scoreSeries,
            tension: 0.25,
            pointRadius: 4,
            pointHitRadius: 18
          },
          {
            label: "1등급 컷",
            data: cutSeries,
            tension: 0,
            pointRadius: 0,
            borderDash: [6,4]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // ✅ 모바일 뭉침 방지 핵심
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed.y;
                return `${ctx.dataset.label}: ${v ?? "-"}`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, suggestedMax: max, max: max }
        }
      }
    });
  }

  async function init(){
    const id = getId();
    if(!id){
      document.getElementById("header").textContent = "id가 없습니다. 목록에서 다시 들어오세요.";
      return;
    }

    const meta = await loadStudentMeta(id);
    renderHeader(meta, id);

    const raw = await loadScores(id);
    const scores = (raw || []).slice().sort((a,b)=>(a.round||0)-(b.round||0));

    if(!scores.length){
      document.getElementById("table").innerHTML =
        `<div style="opacity:.7">점수 데이터가 없습니다. <b>scores.json</b>에서 id="${id}"가 있는지 확인하세요.</div>`;
      return;
    }

    cachedScores = scores;

    renderChips();
    renderMetaLine(scores);
    renderTable(scores);
    renderChart(scores);
  }

  init().catch(err=>{
    document.getElementById("header").textContent =
      "로딩 실패: students.json 또는 scores.json 파일 확인 필요";
    console.error(err);
  });
</script>
</body>
</html>
