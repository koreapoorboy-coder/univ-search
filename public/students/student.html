<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>학생 성적</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 16px; }
    .top { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    h1 { margin:0; font-size:22px; }
    .meta { color:#555; font-size:13px; }

    .tabs {
      display:flex; gap:8px;
      overflow-x:auto; padding:8px 0;
      -webkit-overflow-scrolling: touch;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
    }
    .tab {
      flex:0 0 auto;
      padding:8px 12px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fff;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab.active { border-color:#111; font-weight:700; }

    .chartWrap { max-width: 900px; }
    canvas { width: 100% !important; height: 320px !important; }

    .summary {
      margin-top: 14px;
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      max-width: 900px;
    }
    .summary h2 { margin:0 0 8px; font-size:16px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px; border-bottom:1px solid #f0f0f0; text-align:left; }
    .ok { color:#0a7; font-weight:700; }
    .bad { color:#d33; font-weight:700; }
    .small { color:#666; font-size:12px; }

    @media (max-width: 480px) {
      canvas { height: 280px !important; }
      h1 { font-size:20px; }
    }
  </style>
</head>

<body>
  <div class="top">
    <h1 id="title">로딩중…</h1>
    <div id="meta" class="meta"></div>
  </div>

  <div class="tabs" id="tabs"></div>

  <div class="chartWrap">
    <canvas id="chart"></canvas>
  </div>

  <div class="summary">
    <h2 id="sumTitle">회차별 요약</h2>
    <div class="small" id="sumHint"></div>
    <table id="sumTable"></table>
  </div>

<script>
  // ✅ 기본 만점 규칙: 국/수/영 100, 탐구(생윤/사문 등) 50
  function getMaxScore(subjectKey) {
    const 탐구50 = ["생윤","사문","윤리","정치","경제","사회문화","세계지리","한국지리","생활과윤리"];
    return 탐구50.includes(subjectKey) ? 50 : 100;
  }

  // ✅ 점수 데이터에서 과목 자동 탐지
  // - id, round, date 제외
  // - '컷'으로 끝나는 키는 컷키이므로 제외
  function detectSubjects(records) {
    const set = new Set();
    for (const r of records) {
      for (const k of Object.keys(r)) {
        if (k === "id" || k === "round" || k === "date") continue;
        if (k.endsWith("컷")) continue;
        const v = r[k];
        if (v === undefined || v === null || v === "") continue;
        if (Number.isFinite(Number(v))) set.add(k);
      }
    }
    // 정렬: 국어/수학/영어 우선, 나머지 가나다
    const priority = ["국어","수학","영어"];
    return Array.from(set).sort((a,b) => {
      const ia = priority.indexOf(a);
      const ib = priority.indexOf(b);
      if (ia !== -1 || ib !== -1) return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
      return a.localeCompare(b, "ko");
    });
  }

  function safeNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function byRound(a, b) {
    const ra = safeNum(a.round) ?? 0;
    const rb = safeNum(b.round) ?? 0;
    return ra - rb;
  }

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  const titleEl = document.getElementById("title");
  const metaEl  = document.getElementById("meta");
  const tabsEl  = document.getElementById("tabs");
  const sumTitleEl = document.getElementById("sumTitle");
  const sumHintEl  = document.getElementById("sumHint");
  const sumTableEl = document.getElementById("sumTable");

  let chart;
  let myScores = [];
  let studentMeta = null;

  let subjects = [];
  let activeSubject = null;

  function renderHeader() {
    if (!id) {
      titleEl.textContent = "id가 없습니다.";
      metaEl.textContent = "student.html?id=shstudy01 형태로 접근하세요.";
      return false;
    }

    if (studentMeta) {
      titleEl.textContent = studentMeta.studentname;
      metaEl.textContent = `${studentMeta.school} · ${studentMeta.career} · ${studentMeta.admission}  (id: ${studentMeta.id})`;
    } else {
      titleEl.textContent = "(학생명 미등록)";
      metaEl.textContent = `students.json에 id=${id}가 없습니다. (id: ${id})`;
    }
    return true;
  }

  function makeTabs() {
    tabsEl.innerHTML = "";

    if (!subjects.length) {
      const msg = document.createElement("div");
      msg.className = "small";
      msg.textContent = "표시할 과목이 없습니다.";
      tabsEl.appendChild(msg);
      return;
    }

    subjects.forEach(subKey => {
      const btn = document.createElement("button");
      btn.className = "tab" + (subKey === activeSubject ? " active" : "");
      btn.textContent = subKey;

      btn.addEventListener("click", () => {
        activeSubject = subKey;
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        btn.classList.add("active");
        renderChart();
        renderSummaryTable();
      });

      tabsEl.appendChild(btn);
    });
  }

  function renderChart() {
    if (!activeSubject) return;

    const maxScore = getMaxScore(activeSubject);
    const cutKey = activeSubject + "컷";

    // ✅ 이 과목 점수가 있는 회차만 사용(섞임 방지)
    const rows = myScores.filter(r => r[activeSubject] !== undefined && r[activeSubject] !== null && r[activeSubject] !== "");

    const labels = rows.map(r => `#${r.round} (${r.date})`);
    const scoreData = rows.map(r => safeNum(r[activeSubject]));
    const cutData   = rows.map(r => safeNum(r[cutKey]));

    const datasets = [{
      label: `${activeSubject} 점수`,
      data: scoreData,
      borderWidth: 2,
      tension: 0.25,
      pointRadius: 3
    }];

    // ✅ 컷이 있는 경우에만 컷선 표시
    const hasCut = cutData.some(v => v != null);
    if (hasCut) {
      datasets.push({
        label: `${activeSubject} 컷`,
        data: cutData,
        borderWidth: 2,
        borderDash: [6, 6],
        tension: 0.1,
        pointRadius: 0
      });
    }

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById("chart"), {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: maxScore,
            ticks: { stepSize: (maxScore === 50 ? 5 : 10) }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              afterBody: (items) => {
                const idx = items?.[0]?.dataIndex ?? 0;
                const s = scoreData[idx];
                const c = cutData[idx];
                if (s == null || c == null) return "";
                const diff = s - c;
                return `컷 대비: ${diff >= 0 ? "+" : ""}${diff}`;
              }
            }
          }
        }
      }
    });
  }

  function renderSummaryTable() {
    if (!activeSubject) return;

    const cutKey = activeSubject + "컷";
    sumTitleEl.textContent = `회차별 요약 (${activeSubject})`;
    sumHintEl.textContent = `점수 / 컷 / 컷 대비(±)`;

    const rows = myScores
      .filter(r => r[activeSubject] !== undefined && r[activeSubject] !== null && r[activeSubject] !== "")
      .map(r => {
        const score = safeNum(r[activeSubject]);
        const cut   = safeNum(r[cutKey]);
        const diff  = (score != null && cut != null) ? (score - cut) : null;
        const cls   = (diff != null && diff >= 0) ? "ok" : "bad";

        return `
          <tr>
            <td>#${r.round}<div class="small">${r.date}</div></td>
            <td>${score ?? "-"}</td>
            <td>${cut ?? "-"}</td>
            <td class="${diff == null ? "" : cls}">
              ${diff == null ? "-" : (diff >= 0 ? "+" : "") + diff}
            </td>
          </tr>`;
      }).join("");

    sumTableEl.innerHTML = `
      <thead>
        <tr>
          <th>회차</th>
          <th>점수</th>
          <th>컷</th>
          <th>컷 대비</th>
        </tr>
      </thead>
      <tbody>${rows || `<tr><td colspan="4">해당 과목 데이터가 없습니다.</td></tr>`}</tbody>
    `;
  }

  Promise.all([
    fetch("./students.json").then(r => r.json()),
    fetch("./scores.json").then(r => r.json())
  ]).then(([students, scores]) => {
    studentMeta = (students || []).find(s => s.id === id) || null;

    myScores = (scores || [])
      .filter(x => x.id === id)
      .sort(byRound);

    if (!renderHeader()) return;

    if (!myScores.length) {
      subjects = [];
      activeSubject = null;
      makeTabs();
      sumTitleEl.textContent = "데이터 없음";
      sumHintEl.textContent = "";
      sumTableEl.innerHTML = `<tbody><tr><td>scores.json에 id=${id} 기록이 없습니다.</td></tr></tbody>`;
      return;
    }

    // ✅ 학생별 과목 자동탐지
    subjects = detectSubjects(myScores);
    activeSubject = subjects[0] || null;

    makeTabs();
    renderChart();
    renderSummaryTable();
  }).catch(err => {
    titleEl.textContent = "로드 실패";
    metaEl.textContent = String(err);
  });
</script>

</body>
</html>
