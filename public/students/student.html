<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 성적</title>
  <style>
    body{
      font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      margin:16px;background:#fff
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:18px;margin:14px 0;background:#fff}

    /* ✅ 상단 카드 재배치 */
    .top{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      align-items:start;
    }
    @media(min-width: 860px){
      .top{grid-template-columns: 1.2fr .8fr;}
    }

    .title{font-size:34px;font-weight:900;margin:0 0 10px;line-height:1.15}
    .meta{opacity:.9}
    .kv{
      display:grid;
      grid-template-columns: 72px 1fr;
      column-gap:10px;
      row-gap:8px;
      line-height:1.5;
      margin-top:6px;
    }
    .k{opacity:.65;font-weight:800}
    .v{font-weight:700}

    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:flex-start;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:2px solid #111;border-radius:999px;
      padding:7px 12px;font-weight:900;background:#fff
    }
    .subpill{
      display:inline-flex;align-items:center;
      border:1px solid #ddd;border-radius:999px;
      padding:7px 10px;font-weight:800;background:#fff;opacity:.85
    }

    .btn{
      display:inline-block;border:1px solid #111;border-radius:12px;
      padding:10px 14px;text-decoration:none;color:#111;background:#fff
    }
    .btn:hover{background:#fafafa}

    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}

    /* ✅ "학부모/학생용 링크" 박스가 혹시라도 생성되면 무조건 숨김 */
    #shareCard,#shareBox,#shareLinks,#shareArea,
    .share-card,.shareBox,.share-area,.share-links,
    .parent-links,.parentLinks,.student-links,.studentLinks{
      display:none !important;
      visibility:hidden !important;
      height:0 !important;
      margin:0 !important;
      padding:0 !important;
      border:0 !important;
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- ✅ 상단 카드(재배치) -->
  <div class="card">
    <div class="top">
      <!-- 왼쪽: 학생 정보 -->
      <div>
        <div id="hdr" class="title">학생</div>
        <div id="meta" class="meta"></div>
      </div>

      <!-- 오른쪽: 모드 + 버튼 -->
      <div class="right">
        <div id="msg" class="row"></div>
        <div id="links" class="row"></div>
      </div>
    </div>
  </div>

  <!-- student.js가 여기에 성적/그래프를 렌더링 -->
  <div id="detail"></div>
</div>

<script>
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";

  const qs = new URLSearchParams(location.search);
  const admin = qs.get("admin");
  const idParam = qs.get("id");
  const tParam = qs.get("t");
  const tokenParam = qs.get("token");

  const isAdmin = (admin === ADMIN_TOKEN);
  const isStudentMode = (!!tParam || !!tokenParam);

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }
  function pickId(s){
    return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null;
  }
  function pickToken(s){
    return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null;
  }

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path + " load failed (" + r.status + ")");
    return r.json();
  }

  function setError(title, html){
    document.getElementById("hdr").textContent = title;
    document.getElementById("meta").innerHTML = html;
  }

  async function main(){
    const students = await loadJson("./students.json");

    let student = null;
    if(idParam){
      student = students.find(s => String(pickId(s)) === String(idParam));
    }
    if(!student && tParam){
      student = students.find(s => String(pickToken(s)) === String(tParam));
    }
    if(!student && tokenParam){
      student = students.find(s => String(pickToken(s)) === String(tokenParam));
    }

    if(!student){
      setError(
        "접근 불가",
        `<div class="warn">학생 정보를 찾을 수 없습니다.</div>
         <div class="muted">접속 방법: student.html?id=학생ID 또는 student.html?t=개별토큰</div>`
      );
      return;
    }

    const name = pickName(student);
    const sid = pickId(student);
    const stok = pickToken(student);

    document.getElementById("hdr").textContent = sid ? `${name} (${sid})` : `${name}`;

    // ✅ 왼쪽 메타: 키/값 형태로 정렬
    document.getElementById("meta").innerHTML = `
      <div class="kv">
        <div class="k">학교</div><div class="v">${escapeHtml(student.school || "-")}</div>
        <div class="k">진로</div><div class="v">${escapeHtml(student.career || "-")}</div>
        <div class="k">전형</div><div class="v">${escapeHtml(student.admission || "-")}</div>
      </div>
    `;

    // ✅ 오른쪽: 모드 표시
    const msg = document.getElementById("msg");
    if(isAdmin){
      msg.innerHTML = `<span class="pill">관리자 모드</span><span class="subpill">id로 접근</span>`;
    }else if(isStudentMode){
      msg.innerHTML = `<span class="pill">학부모/학생</span><span class="subpill">토큰 접근</span>`;
    }else{
      msg.innerHTML = `<span class="warn">토큰/관리자 파라미터가 없습니다.</span>`;
    }

    // ✅ 버튼: 관리자 토큰 노출 방지
    const links = document.getElementById("links");

    const univHref = isAdmin
      ? `./univ_list.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./univ_list.html?t=${encodeURIComponent(stok)}`;

    const progHref = isAdmin
      ? `./progress_detail.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
      : `./progress_detail.html?t=${encodeURIComponent(stok)}`;

    const backBtn = isAdmin
      ? `<a class="btn" href="./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}">← 학생 목록</a>`
      : ``;

    links.innerHTML = `
      ${backBtn}
      <a class="btn" href="${univHref}">대학 상향/적정 보기</a>
      <a class="btn" href="${progHref}">진도 상세 보기</a>
    `;

    // ✅ student.js가 id로 scores.json을 읽으므로, 내부적으로 id를 통일
    const url = new URL(location.href);
    if(!url.searchParams.get("id") && sid){
      url.searchParams.set("id", sid);
      history.replaceState(null, "", url.toString());
    }

    // ✅ student.js 로드 (캐시 깨기)
    const s = document.createElement("script");
    s.src = new URL("./student.js?v=20260210_2", location.href).toString();
    s.defer = true;
    document.body.appendChild(s);
  }

  main().catch(err=>{
    setError(
      "오류",
      `<div class="warn">로딩 오류</div>
       <div class="muted">${escapeHtml(err.message)}</div>`
    );
  });
</script>
</body>
</html>
