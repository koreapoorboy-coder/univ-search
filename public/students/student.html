<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 상세</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px;color:#111}
    .wrap{max-width:1100px}
    .top{border:1px solid #ddd;border-radius:16px;padding:16px;background:#fff}
    h1{margin:0 0 10px;font-size:30px}
    .meta{color:#555;line-height:1.8}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .pill{display:inline-block;border:2px solid #111;border-radius:999px;padding:8px 14px;font-weight:900;background:#fff}
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;white-space:nowrap}
    .chip a{color:inherit;text-decoration:none}
    .chip:hover{background:#fafafa}
    .btn{display:inline-block;text-decoration:none;border:2px solid #111;padding:10px 14px;border-radius:14px;font-weight:900;background:#fff}
    .btn:hover{background:#111;color:#fff}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .small{font-size:12px;opacity:.75;line-height:1.6}
    .section{margin-top:16px}
    .card{border:1px solid #ddd;border-radius:16px;padding:14px;background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;overflow:auto;-webkit-overflow-scrolling:touch}
    .tab{border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:900}
    .tab[aria-selected="true"]{background:#111;color:#fff}
    .canvasWrap{border:1px solid #ddd;border-radius:16px;padding:12px}
    .badge{font-weight:900;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:3px 8px;background:#f7f7f7}
    .ok{color:#0a7;border-color:#0a7;background:#f1fff9}
    .mid{color:#555}
    .up{color:#b86b00;border-color:#b86b00;background:#fff8ee}
    .bad{color:#b00020;border-color:#b00020;background:#fff1f3}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1 id="name">로딩중…</h1>
    <div class="meta" id="meta"></div>

    <div class="row" id="latest"></div>

    <div class="section">
      <div class="pill">이번 회차 진도</div>
      <div class="row" id="progressChips" style="margin-top:10px"></div>
      <div class="small" id="progressHint" style="margin-top:8px"></div>
    </div>

    <div class="section">
      <div class="pill">응시 과목</div>
      <div class="row" id="subjectChips" style="margin-top:10px"></div>
    </div>

    <div class="section">
      <div class="pill">정시 대학</div>
      <div class="btnRow" id="univBtns" style="margin-top:10px"></div>
      <div class="small" id="univHint" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="section">
    <h2 style="margin:0 0 10px">성적 그래프</h2>
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div class="canvasWrap">
        <canvas id="chart" height="120"></canvas>
      </div>
      <div class="small" id="chartHint" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="section">
    <div class="btnRow">
      <a class="btn" href="./index.html">처음으로</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const qs = new URLSearchParams(location.search);
  const studentId = qs.get("id") || "";
  const token = qs.get("t") || "";
  const roundParam = qs.get("round");

  const esc = (s)=> String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> { const n = Number(v); return Number.isFinite(n) ? n : null; };
  const norm = (s)=> String(s ?? "").trim().toLowerCase();

  async function fetchJSON(path){
    const r = await fetch(path, {cache:"no-store"});
    if(!r.ok) throw new Error("fetch fail: "+path);
    return await r.json();
  }

  function pickName(s){ return s?.studentName ?? s?.studentname ?? s?.name ?? s?.["학생명"] ?? s?.["이름"] ?? s?.["성명"] ?? s?.id ?? "-"; }

  // 상태 뱃지(진도 평가)
  function statusClass(status){
    const s = String(status||"").trim();
    if (!s) return "mid";
    if (s.includes("잘")) return "ok";
    if (s.includes("보통")) return "mid";
    if (s.includes("보완") || s.includes("위험")) return "bad";
    return "up";
  }

  // progress.json / progress_notes.json 필드 호환
  function getProgressFields(p){
    return {
      subject: p.subject ?? p["과목"] ?? p["과목명"] ?? "-",
      term: p.term ?? p["학년학기"] ?? "",
      topic: p.topic ?? p["진도(단원/주제)"] ?? p["진도"] ?? p["topic"] ?? "-"
    };
  }
  function getNoteFields(n){
    return {
      subject: n.subject ?? n["과목"] ?? "",
      topic: n.topic ?? n["진도"] ?? n["진도(단원/주제)"] ?? "",
      status: n.status ?? n["평가"] ?? "",
      summary: n.summary ?? n["문제요약"] ?? n["문제요약(한줄)"] ?? "",
      cause: n.cause ?? n["원인"] ?? ""
    };
  }
  function findNote(notes, id, round, subject, topic){
    const cand = (notes||[]).filter(n => String(n.id)===String(id) && String(n.round)===String(round));
    const sKey = norm(subject), tKey = norm(topic);
    for (const n of cand){
      const f = getNoteFields(n);
      if (norm(f.subject)===sKey && (norm(f.topic)===tKey || norm(f.topic).includes(tKey) || tKey.includes(norm(f.topic)))) return n;
    }
    for (const n of cand){
      const f = getNoteFields(n);
      if (norm(f.subject)===sKey) return n;
    }
    return null;
  }

  // 응시 과목(데이터에 있는 것만)
  function subjectsAttempted(scoreRec){
    const out = [];
    for (const k of Object.keys(scoreRec||{})){
      if (k==="id"||k==="round"||k==="date") continue;
      if (k.endsWith("컷") || k.endsWith("백분위") || k==="영어등급") continue;
      const v = num(scoreRec[k]); if (v==null) continue;
      out.push(k);
    }
    const priority = ["국어","수학","영어","사문","생윤"];
    const ordered = [];
    for (const p of priority) if (out.includes(p)) ordered.push(p);
    for (const x of out) if (!ordered.includes(x)) ordered.push(x);
    return ordered;
  }
  function cutPassedCount(scoreRec, subs){
    let pass=0,total=0;
    for (const s of subs){
      const sc=num(scoreRec?.[s]), cut=num(scoreRec?.[s+"컷"]);
      if (sc==null || cut==null) continue;
      total++; if (sc>=cut) pass++;
    }
    return {pass,total};
  }

  // ✅ 토큰 검증
  async function requireAuth(){
    if(!studentId || !token){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2><p>선생님이 준 개별 링크로 접속해 주세요.</p>";
      throw new Error("unauthorized");
    }
    const students = await fetchJSON("./students.json");
    const st = (students||[]).find(x=>x.id===studentId);
    if(!st || String(st.token||"") !== String(token)){
      document.body.innerHTML = "<h2>접근 권한이 없습니다.</h2><p>링크가 올바르지 않거나 변경되었습니다.</p>";
      throw new Error("unauthorized");
    }
    return st;
  }

  let chartInstance=null;
  function drawChart(myScores, subject){
    const labels = myScores.map(r=>`#${r.round}`);
    const scores = myScores.map(r=>num(r?.[subject]));
    const cuts   = myScores.map(r=>num(r?.[subject+"컷"]));
    const ctx = document.getElementById("chart");
    if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
    chartInstance = new Chart(ctx,{
      type:"line",
      data:{ labels, datasets:[
        {label:subject, data:scores, tension:.25, spanGaps:true},
        {label:subject+"컷", data:cuts, tension:.25, spanGaps:true, borderDash:[6,6]}
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}} }
    });
  }

  async function main(){
    const st = await requireAuth();

    const [scores, progress, notes] = await Promise.all([
      fetchJSON("./scores.json"),
      fetchJSON("./progress.json").catch(()=>[]),
      fetchJSON("./progress_notes.json").catch(()=>[])
    ]);

    const myScores = (scores||[]).filter(x=>x.id===studentId).sort((a,b)=>(num(a.round)||0)-(num(b.round)||0));
    const current = roundParam
      ? (myScores.find(x=>String(x.round)===String(roundParam)) || myScores[myScores.length-1])
      : myScores[myScores.length-1];

    const currentRound = num(current?.round);
    const subs = subjectsAttempted(current||{});
    const pass = cutPassedCount(current||{}, subs);

    document.getElementById("name").textContent = pickName(st);
    document.getElementById("meta").innerHTML =
      `학교: <b>${esc(st.school||"-")}</b><br/>진로: <b>${esc(st.career||"-")}</b><br/>전형: <b>${esc(st.admission||"-")}</b>`;

    document.getElementById("latest").innerHTML = current
      ? `<span class="chip">최근 점수: <b>#${esc(currentRound ?? "-")}</b> · ${esc(current?.date||"-")}</span>
         <span class="chip">컷 통과: <b>${pass.pass}/${pass.total || "-"}</b></span>`
      : `<span class="chip">점수 데이터 없음</span>`;

    // 진도 칩(상태 뱃지 포함) → progress_detail.html 새 창
    const pList = (progress||[]).filter(x=>String(x.id)===String(studentId) && String(x.round)===String(currentRound ?? ""));
    const pc = document.getElementById("progressChips");

    if(!pList.length){
      pc.innerHTML = `<span class="small">이번 회차 진도 데이터가 없습니다.</span>`;
      document.getElementById("progressHint").textContent = "";
    }else{
      pc.innerHTML = pList.map(p=>{
        const f = getProgressFields(p);
        const n = findNote(notes, studentId, currentRound, f.subject, f.topic);
        const nf = n ? getNoteFields(n) : null;
        const stt = nf?.status || "";
        const cls = statusClass(stt);
        const url = `./progress_detail.html?id=${encodeURIComponent(studentId)}&t=${encodeURIComponent(token)}&round=${encodeURIComponent(String(currentRound))}&subject=${encodeURIComponent(f.subject)}&topic=${encodeURIComponent(f.topic)}`;
        return `<span class="chip">
          ${stt ? `<span class="badge ${cls}">${esc(stt)}</span>` : `<span class="badge mid">미평가</span>`}
          <a href="${esc(url)}" target="_blank" rel="noopener">${esc(f.subject)}${f.term?`(${esc(f.term)})`:``}: ${esc(f.topic)}</a>
        </span>`;
      }).join("");
      document.getElementById("progressHint").textContent = "진도 칩 클릭 → 새 창에서 상세(문제/원인/보완)";
    }

    // 응시 과목
    document.getElementById("subjectChips").innerHTML =
      subs.length ? subs.map(s=>`<span class="chip">${esc(s)}</span>`).join("") : `<span class="small">응시 과목 없음</span>`;

    // 정시 대학 버튼(적정/상향만)
    document.getElementById("univBtns").innerHTML = `
      <a class="btn" target="_blank" rel="noopener"
         href="./univ_list.html?id=${encodeURIComponent(studentId)}&t=${encodeURIComponent(token)}&bucket=fit${currentRound!=null?`&round=${encodeURIComponent(String(currentRound))}`:""}">적정</a>
      <a class="btn" target="_blank" rel="noopener"
         href="./univ_list.html?id=${encodeURIComponent(studentId)}&t=${encodeURIComponent(token)}&bucket=up${currentRound!=null?`&round=${encodeURIComponent(String(currentRound))}`:""}">상향</a>
    `;
    document.getElementById("univHint").textContent = "버튼 클릭 → 새 창 목록, 대학 클릭 → 근거 상세";

    // 그래프 탭
    const tabs = document.getElementById("tabs");
    if(!subs.length){
      tabs.innerHTML = `<span class="small">표시할 과목이 없습니다.</span>`;
      document.getElementById("chartHint").textContent = "";
      return;
    }
    let selected = subs.includes("국어") ? "국어" : subs[0];
    tabs.innerHTML = subs.map(s=>`<button class="tab" data-sub="${esc(s)}" aria-selected="${s===selected}">${esc(s)}</button>`).join("");
    tabs.addEventListener("click",(e)=>{
      const btn=e.target.closest(".tab"); if(!btn) return;
      selected=btn.dataset.sub;
      for(const b of tabs.querySelectorAll(".tab")) b.setAttribute("aria-selected", String(b.dataset.sub===selected));
      drawChart(myScores, selected);
      document.getElementById("chartHint").textContent = `${selected} 점수(실선) / 컷(점선)`;
    });
    drawChart(myScores, selected);
    document.getElementById("chartHint").textContent = `${selected} 점수(실선) / 컷(점선)`;
  }

  main().catch(()=>{});
</script>
</body>
</html>
