<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 성적</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:24px}
    a{color:#111}
    .wrap{max-width:900px}
    .title{font-size:22px;font-weight:900;margin:10px 0}
    .sub{opacity:.75;margin-bottom:14px}
    .box{border:1px solid #ddd;border-radius:12px;padding:14px;margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:center}
    th{background:#fafafa}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="./">← 학생 목록으로</a>
    <div id="header" class="box">
      로딩 중...
    </div>

    <div class="box">
      <canvas id="chart" height="120"></canvas>
    </div>

    <div class="box">
      <div style="font-weight:800;margin-bottom:8px">회차별 점수</div>
      <div id="table"></div>
    </div>
  </div>

  <script>
    const SUBJECTS = ["국어","수학","영어","생윤","사문"];

    function getId(){
      const u = new URL(location.href);
      return u.searchParams.get("id");
    }

    async function loadStudentMeta(id){
      const res = await fetch("./students.json", { cache:"no-store" });
      const list = await res.json();
      return list.find(x => x.id === id);
    }

   async function loadScores(id){
  const res = await fetch("./scores.json", { cache:"no-store" });
  const all = await res.json();

  // scores.json이 배열이거나 {scores:[...]} 둘 다 대응
  const rows = Array.isArray(all) ? all : (all.scores || []);

  // id 또는 studentId 둘 다 대응
  return rows.filter(r => (r.id || r.studentId) === id);
}


    }

    function renderHeader(meta, id){
      const el = document.getElementById("header");
      el.innerHTML = `
        <div class="title">${meta?.studentName || id}</div>
        <div class="sub">
          학교: ${meta?.school || "-"} · 진로: ${meta?.career || "-"} · 전형: ${meta?.admission || "-"}
        </div>
        <div style="opacity:.8">데이터 파일: <b>students/data/${id}.json</b></div>
      `;
    }

    function renderTable(scores){
      const rows = scores.map(r => `
        <tr>
          <td>${r.round}</td>
          <td>${r.date || "-"}</td>
          ${SUBJECTS.map(s => `<td>${(r[s] ?? "-")}</td>`).join("")}
        </tr>
      `).join("");

      document.getElementById("table").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>회차</th><th>날짜</th>
              ${SUBJECTS.map(s=>`<th>${s}</th>`).join("")}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderChart(scores){
      const labels = scores.map(r => `${r.round}회`);
      const datasets = SUBJECTS.map(s => ({
        label: s,
        data: scores.map(r => r[s] ?? null),
        tension: 0.25
      }));

      const ctx = document.getElementById("chart");
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true, suggestedMax: 100 } }
        }
      });
    }

    async function init(){
      const id = getId();
      if(!id){
        document.getElementById("header").textContent = "id가 없습니다. 목록에서 다시 들어오세요.";
        return;
      }
      const meta = await loadStudentMeta(id);
      renderHeader(meta, id);

      const scores = (await loadScores(id)).slice().sort((a,b)=>a.round-b.round);

      renderTable(scores);
      renderChart(scores);
    }

    init().catch(err=>{
      document.getElementById("header").textContent =
        "로딩 실패: students.json 또는 data/{id}.json 파일 확인 필요";
      console.error(err);
    });
  </script>
</body>
</html>
