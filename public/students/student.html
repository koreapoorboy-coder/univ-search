<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>학생 성적/진도</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 16px; }
    .top { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; max-width: 920px; }
    h1 { margin:0; font-size:22px; }
    .meta { color:#555; font-size:13px; }

    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 10px 0 8px; max-width: 920px; }
    .toggle { border:1px solid #ddd; background:#fff; border-radius:999px; padding:8px 12px; font-size:13px; cursor:pointer; }
    .toggle.active { border-color:#111; font-weight:800; }
    .small { color:#666; font-size:12px; }

    .tabs {
      display:flex; gap:8px;
      overflow-x:auto; padding:8px 0;
      -webkit-overflow-scrolling: touch;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
      max-width: 920px;
    }
    .tab {
      flex:0 0 auto; padding:8px 12px; border:1px solid #ddd; border-radius:999px;
      background:#fff; font-size:13px; cursor:pointer; white-space:nowrap;
    }
    .tab.active { border-color:#111; font-weight:800; }

    .chartWrap { max-width: 920px; }
    canvas { width: 100% !important; height: 320px !important; }

    .grid { max-width: 920px; display:grid; grid-template-columns: 1fr; gap:12px; }
    .panel { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
    .panel h3 { margin:0 0 8px; font-size:14px; }

    .box { margin-top: 12px; border:1px solid #eee; border-radius:12px; padding:12px; max-width: 920px; background:#fff; }
    .box h2 { margin:0 0 8px; font-size:16px; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px; border-bottom:1px solid #f0f0f0; text-align:left; vertical-align:top; }
    .ok { color:#0a7; font-weight:800; }
    .bad { color:#d33; font-weight:800; }

    .timelineItem{ margin:10px 0; padding:10px; border:1px solid #eee; border-radius:10px; }
    .timelineHead{ font-weight:900; }
    .timelineBody{ margin-top:6px; line-height:1.65; }

    @media (max-width: 480px) {
      canvas { height: 280px !important; }
      h1 { font-size:20px; }
    }
  </style>
</head>

<body>
  <div class="top">
    <h1 id="title">로딩중…</h1>
    <div id="meta" class="meta"></div>
  </div>

  <div class="bar">
    <button id="btnSingle" class="toggle">단일 과목</button>
    <button id="btnAll" class="toggle">전체 보기</button>
    <span class="small" id="hint"></span>
  </div>

  <div class="tabs" id="tabs"></div>

  <div class="chartWrap" id="singleWrap">
    <canvas id="chartSingle"></canvas>
  </div>

  <div class="grid" id="allWrap" style="display:none;"></div>

  <div class="box">
    <h2 id="sumTitle">요약</h2>
    <div class="small" id="sumHint"></div>
    <table id="sumTable"></table>
  </div>

  <div class="box">
    <h2>진도 타임라인</h2>
    <div class="small" id="progressHint"></div>
    <div id="progressBox" class="small">로딩중…</div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  const titleEl = document.getElementById("title");
  const metaEl  = document.getElementById("meta");
  const tabsEl  = document.getElementById("tabs");

  const btnSingle = document.getElementById("btnSingle");
  const btnAll = document.getElementById("btnAll");
  const hintEl = document.getElementById("hint");

  const singleWrap = document.getElementById("singleWrap");
  const allWrap = document.getElementById("allWrap");

  const sumTitleEl = document.getElementById("sumTitle");
  const sumHintEl  = document.getElementById("sumHint");
  const sumTableEl = document.getElementById("sumTable");

  const progressHintEl = document.getElementById("progressHint");
  const progressBoxEl = document.getElementById("progressBox");

  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  function safeNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function getMaxScore(subjectKey) {
    const 탐구50 = ["생윤","사문"];
    return 탐구50.includes(subjectKey) ? 50 : 100;
  }

  function detectSubjects(records){
    const set = new Set();
    for (const r of records){
      for (const k of Object.keys(r)){
        if (k === "id" || k === "round" || k === "date") continue;
        if (k.endsWith("컷")) continue;
        const v = r[k];
        if (v === undefined || v === null || v === "") continue;
        if (Number.isFinite(Number(v))) set.add(k);
      }
    }
    const priority = ["국어","수학","영어"];
    return Array.from(set).sort((a,b)=>{
      const ia = priority.indexOf(a);
      const ib = priority.indexOf(b);
      if (ia !== -1 || ib !== -1) return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
      return a.localeCompare(b, "ko");
    });
  }

  function byRound(a,b){
    return (safeNum(a.round) ?? 0) - (safeNum(b.round) ?? 0);
  }

  function latestForSubject(records, sub){
    for (let i = records.length - 1; i >= 0; i--){
      const r = records[i];
      if (r[sub] !== undefined && r[sub] !== null && r[sub] !== "") return r;
    }
    return null;
  }

  function normalizeProgressItem(p){
    const subj = (p["과목"] ?? p.subject ?? "").toString().trim();
    const term = (p["학년학기"] ?? p.term ?? "").toString().trim();
    const topic = (p["진도"] ?? p["진도(단원/주제)"] ?? p.topic ?? "").toString().trim();
    const memo = (p["메모"] ?? p.memo ?? "").toString().trim();
    return { subj, term, topic, memo };
  }

  let studentMeta = null;
  let myScores = [];
  let subjects = [];
  let activeSubject = null;

  let myProgress = [];

  let mode = "single";
  let singleChart = null;
  const allCharts = new Map();

  function setMode(next){
    mode = next;
    btnSingle.classList.toggle("active", mode === "single");
    btnAll.classList.toggle("active", mode === "all");

    tabsEl.style.display = (mode === "single") ? "flex" : "none";
    singleWrap.style.display = (mode === "single") ? "block" : "none";
    allWrap.style.display = (mode === "all") ? "grid" : "none";

    hintEl.textContent = (mode === "single")
      ? "모바일 추천: 한 과목씩 보기"
      : "PC 추천: 전체 과목 한 번에 보기";

    if (mode === "single") {
      renderTabs();
      renderSingleChart();
      renderSummary();
    } else {
      renderAllCharts();
      renderSummary();
    }
  }

  function renderHeader(){
    if (!id){
      titleEl.textContent = "id가 없습니다.";
      metaEl.textContent = "student.html?id=shstudy01 형태로 접근하세요.";
      return false;
    }
    if (studentMeta){
      titleEl.textContent = studentMeta.studentname || "(학생명 없음)";
      metaEl.textContent = `${studentMeta.school || "-"} · ${studentMeta.career || "-"} · ${studentMeta.admission || "-"}  (id: ${studentMeta.id})`;
    } else {
      titleEl.textContent = "(학생명 미등록)";
      metaEl.textContent = `students.json에 id=${id}가 없습니다. (id: ${id})`;
    }
    return true;
  }

  function renderTabs(){
    tabsEl.innerHTML = "";
    subjects.forEach(subKey => {
      const btn = document.createElement("button");
      btn.className = "tab" + (subKey === activeSubject ? " active" : "");
      btn.textContent = subKey;
      btn.addEventListener("click", ()=>{
        activeSubject = subKey;
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        renderSingleChart();
        renderSummary();
      });
      tabsEl.appendChild(btn);
    });
  }

  function buildDataset(rows, sub){
    const maxScore = getMaxScore(sub);
    const cutKey = sub + "컷";

    const labels = rows.map(r => `#${r.round} (${r.date})`);
    const scoreData = rows.map(r => safeNum(r[sub]));
    const cutData   = rows.map(r => safeNum(r[cutKey]));

    const datasets = [{
      label: `${sub} 점수`,
      data: scoreData,
      borderWidth: 2,
      tension: 0.25,
      pointRadius: 3
    }];

    const hasCut = cutData.some(v => v != null);
    if (hasCut) {
      datasets.push({
        label: `${sub} 컷`,
        data: cutData,
        borderWidth: 2,
        borderDash: [6,6],
        tension: 0.1,
        pointRadius: 0
      });
    }

    return { labels, datasets, maxScore };
  }

  function renderSingleChart(){
    if (!activeSubject) return;
    const rows = myScores.filter(r => r[activeSubject] !== undefined && r[activeSubject] !== null && r[activeSubject] !== "");
    const built = buildDataset(rows, activeSubject);

    if (singleChart) singleChart.destroy();
    singleChart = new Chart(document.getElementById("chartSingle"), {
      type: "line",
      data: { labels: built.labels, datasets: built.datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { min: 0, max: built.maxScore, ticks: { stepSize: (built.maxScore === 50 ? 5 : 10) } }
        }
      }
    });
  }

  function renderAllCharts(){
    for (const ch of allCharts.values()) ch.destroy();
    allCharts.clear();
    allWrap.innerHTML = "";

    subjects.forEach(sub => {
      const rows = myScores.filter(r => r[sub] !== undefined && r[sub] !== null && r[sub] !== "");
      const panel = document.createElement("div");
      panel.className = "panel";
      panel.innerHTML = `<h3>${esc(sub)}</h3><canvas></canvas>`;
      allWrap.appendChild(panel);

      const canvas = panel.querySelector("canvas");
      const built = buildDataset(rows, sub);

      const ch = new Chart(canvas, {
        type: "line",
        data: { labels: built.labels, datasets: built.datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { min: 0, max: built.maxScore, ticks: { stepSize: (built.maxScore === 50 ? 5 : 10) } }
          }
        }
      });

      allCharts.set(sub, ch);
    });
  }

  function renderSummary(){
    if (!subjects.length) {
      sumTitleEl.textContent = "요약";
      sumHintEl.textContent = "";
      sumTableEl.innerHTML = `<tbody><tr><td>표시할 과목이 없습니다.</td></tr></tbody>`;
      return;
    }

    if (mode === "single") {
      const sub = activeSubject;
      const cutKey = sub + "컷";
      sumTitleEl.textContent = `회차별 요약 (${sub})`;
      sumHintEl.textContent = "점수 / 컷 / 컷 대비(±)";

      const body = myScores
        .filter(r => r[sub] !== undefined && r[sub] !== null && r[sub] !== "")
        .map(r => {
          const score = safeNum(r[sub]);
          const cut = safeNum(r[cutKey]);
          const diff = (score != null && cut != null) ? (score - cut) : null;
          const cls = (diff != null && diff >= 0) ? "ok" : "bad";
          return `
            <tr>
              <td>#${esc(r.round)}<div class="small">${esc(r.date)}</div></td>
              <td>${score ?? "-"}</td>
              <td>${cut ?? "-"}</td>
              <td class="${diff == null ? "" : cls}">
                ${diff == null ? "-" : (diff >= 0 ? "+" : "") + diff}
              </td>
            </tr>
          `;
        }).join("");

      sumTableEl.innerHTML = `
        <thead><tr><th>회차</th><th>점수</th><th>컷</th><th>컷 대비</th></tr></thead>
        <tbody>${body || `<tr><td colspan="4">데이터 없음</td></tr>`}</tbody>
      `;
      return;
    }

    sumTitleEl.textContent = "최근 회차 요약 (과목별)";
    sumHintEl.textContent = "과목 / 최근 점수 / 컷 / 컷 대비(±)";

    const rows = subjects.map(sub => {
      const rec = latestForSubject(myScores, sub);
      if (!rec) return null;

      const score = safeNum(rec[sub]);
      const cut = safeNum(rec[sub + "컷"]);
      const diff = (score != null && cut != null) ? (score - cut) : null;
      const cls = (diff != null && diff >= 0) ? "ok" : "bad";

      return `
        <tr>
          <td>${esc(sub)}<div class="small">#${esc(rec.round)} · ${esc(rec.date)}</div></td>
          <td>${score ?? "-"}</td>
          <td>${cut ?? "-"}</td>
          <td class="${diff == null ? "" : cls}">
            ${diff == null ? "-" : (diff >= 0 ? "+" : "") + diff}
          </td>
        </tr>
      `;
    }).filter(Boolean).join("");

    sumTableEl.innerHTML = `
      <thead><tr><th>과목</th><th>최근 점수</th><th>컷</th><th>컷 대비</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="4">데이터 없음</td></tr>`}</tbody>
    `;
  }

  function renderProgress(){
    if (!myProgress.length){
      progressHintEl.textContent = "";
      progressBoxEl.textContent = "진도 기록이 없습니다.";
      return;
    }

    const by = new Map();
    for (const p of myProgress){
      const r = safeNum(p.round) ?? 0;
      if (!by.has(r)) by.set(r, []);
      by.get(r).push(p);
    }
    const rounds = Array.from(by.keys()).sort((a,b)=>a-b);

    const latestR = rounds[rounds.length - 1];
    const latestItems = by.get(latestR) || [];
    const latestDate = latestItems[0]?.date || "";
    progressHintEl.textContent = `최근 진도: #${latestR}${latestDate ? " · " + latestDate : ""} (입력된 만큼 전부 표시)`;

    progressBoxEl.innerHTML = rounds.map(r=>{
      const items = by.get(r) || [];
      const d = items[0]?.date || "";
      const lines = items.map(x=>{
        const n = normalizeProgressItem(x);
        const head = `${n.subj}${n.term ? `(${n.term})` : ""}`.trim();
        const topic = n.topic ? `: ${n.topic}` : "";
        const memo = n.memo ? ` — <span style="opacity:.75">${esc(n.memo)}</span>` : "";
        return `<div>• <b>${esc(head)}</b>${esc(topic)}${memo}</div>`;
      }).join("");

      return `
        <div class="timelineItem">
          <div class="timelineHead">#${esc(r)} ${d ? `· ${esc(d)}` : ""}</div>
          <div class="timelineBody">${lines || "내용 없음"}</div>
        </div>
      `;
    }).join("");
  }

  btnSingle.addEventListener("click", ()=>setMode("single"));
  btnAll.addEventListener("click", ()=>setMode("all"));

  Promise.all([
    fetch("./students.json", { cache:"no-store" }).then(r => r.json()),
    fetch("./scores.json",   { cache:"no-store" }).then(r => r.json()),
    fetch("./progress.json", { cache:"no-store" }).then(r => r.json()).catch(()=>[])
  ]).then(([students, scores, progress]) => {
    studentMeta = (students || []).find(s => s.id === id) || null;
    myScores = (scores || []).filter(x => x.id === id).sort(byRound);
    myProgress = (progress || []).filter(p => p.id === id).sort((a,b)=>(safeNum(a.round)??0)-(safeNum(b.round)??0));

    if (!renderHeader()) return;

    if (!myScores.length) {
      subjects = [];
      activeSubject = null;
      tabsEl.innerHTML = "";
      sumTitleEl.textContent = "점수 데이터 없음";
      sumHintEl.textContent = "";
      sumTableEl.innerHTML = `<tbody><tr><td>scores.json에 id=${esc(id)} 기록이 없습니다.</td></tr></tbody>`;
    } else {
      subjects = detectSubjects(myScores);
      activeSubject = subjects[0] || null;
      const isMobile = window.matchMedia("(max-width: 520px)").matches;
      setMode(isMobile ? "single" : "all");
    }

    renderProgress();
  }).catch(err => {
    titleEl.textContent = "로드 실패";
    metaEl.textContent = String(err);
    progressBoxEl.textContent = "진도 로드 실패";
  });
</script>

</body>
</html>
