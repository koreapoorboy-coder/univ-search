<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 성적</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:16px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{border:1px solid #ddd;border-radius:18px;padding:18px;margin:14px 0;background:#fff}
    .title{font-size:34px;font-weight:900;margin:0 0 10px}
    .meta{opacity:.85;line-height:1.8}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .pill{display:inline-block;border:2px solid #111;border-radius:999px;padding:8px 14px;font-weight:900;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;white-space:nowrap}
    .chip:hover{background:#fafafa}
    .btn{display:inline-block;border:1px solid #111;border-radius:12px;padding:10px 14px;text-decoration:none}
    .warn{color:#b00020;font-weight:900}
    .muted{opacity:.7}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div id="hdr" class="title">학생</div>
    <div id="meta" class="meta"></div>
    <div id="msg" class="row"></div>
    <div id="links" class="row"></div>
  </div>

  <!-- 실제 그래프/상세는 기존 student.js가 있다면 그대로 이용 -->
  <div id="detail"></div>
</div>

<script>
  // ✅ 여기 토큰은 현재 네가 쓰는 값 그대로
  const ADMIN_TOKEN = "CHANGE_ME_ADMIN";

  const qs = new URLSearchParams(location.search);
  const admin = qs.get("admin");
  const idParam = qs.get("id");
  const tParam = qs.get("t");        // 학부모/학생용 토큰
  const tokenParam = qs.get("token");// (혹시 쓰는 경우 대비)

  function escapeHtml(s){
    return String(s??'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function pickName(s){
    return s.studentName ?? s.studentname ?? s.name ?? s["학생명"] ?? s["이름"] ?? s["성명"] ?? s.id ?? "-";
  }
  function pickId(s){
    return s.id ?? s.studentId ?? s.studentID ?? s["ID"] ?? s["학생ID"] ?? s["학번"] ?? null;
  }
  function pickToken(s){
    return s.token ?? s.accessToken ?? s.key ?? s["token"] ?? s["토큰"] ?? null;
  }

  async function loadJson(path){
    const r = await fetch(path, { cache:"no-store" });
    if(!r.ok) throw new Error(path+" load failed");
    return r.json();
  }

  async function main(){
    const students = await loadJson("./students.json");

    // ✅ 1) id로 들어온 경우: id로 찾기
    let student = null;
    if(idParam){
      student = students.find(s => String(pickId(s)) === String(idParam));
    }

    // ✅ 2) t(토큰)로 들어온 경우: 토큰으로 찾기
    if(!student && tParam){
      student = students.find(s => String(pickToken(s)) === String(tParam));
    }

    // ✅ 3) token 파라미터로 들어온 경우(백업)
    if(!student && tokenParam){
      student = students.find(s => String(pickToken(s)) === String(tokenParam));
    }

    if(!student){
      document.getElementById("hdr").textContent = "접근 불가";
      document.getElementById("meta").innerHTML =
        `<div class="warn">학생 정보를 찾을 수 없습니다.</div>
         <div class="muted">접속 방법: student.html?id=학생ID 또는 student.html?t=개별토큰</div>`;
      return;
    }

    const name = pickName(student);
    const sid = pickId(student);
    const stok = pickToken(student);

    document.getElementById("hdr").textContent = name;
    document.getElementById("meta").innerHTML = `
      학교: ${escapeHtml(student.school || "-")}<br/>
      진로: ${escapeHtml(student.career || "-")}<br/>
      전형: ${escapeHtml(student.admission || "-")}<br/>
      <span class="muted">학생ID: ${escapeHtml(sid || "-")}</span>
    `;

    const msg = document.getElementById("msg");

    // ✅ 관리자면 안내
    if(admin === ADMIN_TOKEN){
      msg.innerHTML = `<span class="pill">관리자 모드</span><span class="muted">id로 접근 가능</span>`;
    }else if(tParam || tokenParam){
      msg.innerHTML = `<span class="pill">학부모/학생 모드</span><span class="muted">개별 토큰 접근</span>`;
    }else{
      msg.innerHTML = `<span class="warn">토큰/관리자 파라미터가 없습니다.</span>`;
    }

    // ✅ 링크 버튼(기존 파일들과 연결)
    const links = document.getElementById("links");

    // 관리자면 index로 돌아가기
    const backHref = `./index.html?admin=${encodeURIComponent(ADMIN_TOKEN)}`;

    // 대학 리스트
    const univHref =
      (admin === ADMIN_TOKEN)
        ? `./univ_list.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
        : `./univ_list.html?t=${encodeURIComponent(stok)}`;

    // 진도 상세
    const progHref =
      (admin === ADMIN_TOKEN)
        ? `./progress_detail.html?id=${encodeURIComponent(sid)}&admin=${encodeURIComponent(ADMIN_TOKEN)}`
        : `./progress_detail.html?t=${encodeURIComponent(stok)}`;

    links.innerHTML = `
      <a class="btn" href="${backHref}">← 학생 목록</a>
      <a class="btn" href="${univHref}">대학 상향/적정</a>
      <a class="btn" href="${progHref}">진도 상세</a>
    `;

    // ✅ 여기서부터 아래는 "기존 그래프/성적 로직"을 네 student.js가 처리한다면 연결만 해주면 됨
    //    (student.js가 id를 읽어서 scores.json을 렌더링하는 구조라면,
    //     아래처럼 querystring을 id로 통일해 유지해도 됨)
    //
    // 관리자면 id로, 학부모면 id를 내부적으로 붙여서 student.js가 작동하게 만들기
    const effectiveId = sid;
    const url = new URL(location.href);

    if(!url.searchParams.get("id") && effectiveId){
      url.searchParams.set("id", effectiveId);
      history.replaceState(null, "", url.toString());
    }

    // student.js가 있으면 실행(없으면 무시)
    const s = document.createElement("script");
    s.src = "./student.js";
    s.defer = true;
    s.onload = ()=>{};
    s.onerror = ()=>{};
    document.body.appendChild(s);
  }

  main().catch(err=>{
    document.getElementById("hdr").textContent = "오류";
    document.getElementById("meta").innerHTML = `<div class="warn">로딩 오류</div><div class="muted">${escapeHtml(err.message)}</div>`;
  });
</script>
</body>
</html>
