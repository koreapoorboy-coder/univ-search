<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>학생 성적</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:18px}
    a{color:#111;text-decoration:none}
    .wrap{max-width:920px;margin:0 auto}
    .title{font-size:22px;font-weight:900;margin:10px 0}
    .sub{opacity:.75;margin-bottom:8px;line-height:1.5}
    .box{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
    .tabs button{
      appearance:none;border:1px solid #111;background:#fff;border-radius:999px;
      padding:8px 12px;font-weight:800;cursor:pointer;
      touch-action:manipulation;
    }
    .tabs button.active{background:#111;color:#fff}
    .hint{opacity:.8;font-size:13px;margin:6px 0 0}
    .chartBox{position:relative;width:100%;height:280px}
    @media (max-width:520px){
      body{margin:14px}
      .chartBox{height:240px}
    }
    table{width:100%;border-collapse:collapse;min-width:640px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:center}
    th{background:#fafafa}
    .tableWrap{overflow:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="./">← 학생 목록으로</a>

    <div id="header" class="box">로딩 중...</div>

    <div class="box">
      <div class="tabs" id="tabs"></div>
      <div class="hint" id="hint"></div>
      <div class="chartBox">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="box">
      <div style="font-weight:900;margin-bottom:8px">회차별 점수</div>
      <div class="tableWrap"><div id="table"></div></div>
    </div>
  </div>

  <script>
    const SUBJECTS = ["국어","수학","영어","생윤","사문"];
    const MAX_SCORE = (s) => (s === "생윤" || s === "사문") ? 50 : 100;

    let chartInstance = null;
    let currentView = "수학";
    let allScores = [];
    let meta = null;

    function getId(){
      const u = new URL(location.href);
      return u.searchParams.get("id");
    }

    function pickName(m, id){
      return m?.studentName ?? m?.studentname ?? m?.name ?? m?.["학생명"] ?? m?.["이름"] ?? m?.["성명"] ?? id;
    }

    function toNum(v){
      if (v === null || v === undefined || v === "") return null;
      const n = Number(String(v).replace(/[^\d.-]/g,""));
      return Number.isFinite(n) ? n : null;
    }

    async function loadStudentMeta(id){
      const res = await fetch("./students.json", { cache:"no-store" });
      const list = await res.json();
      return list.find(x => String(x.id) === String(id));
    }

    async function loadScores(id){
      const res = await fetch("./scores.json", { cache:"no-store" });
      const all = await res.json();

      // ✅ scores.json이 배열 / {scores:[...]} / 단일객체 {...} 모두 대응
      const rows =
        Array.isArray(all) ? all :
        (Array.isArray(all?.scores) ? all.scores :
        (all && all.id ? [all] : []));

      const mine = rows.filter(r => String(r.id ?? r.studentId ?? r["학생ID"] ?? "") === String(id));

      // 표준화(숫자 변환 + 컷 포함)
      return mine.map(r => {
        const out = {
          id: r.id ?? r.studentId ?? r["학생ID"] ?? id,
          round: Number(r.round ?? r["회차"] ?? r["차수"] ?? r["주차"] ?? 0),
          date: r.date ?? r["날짜"] ?? r["시험일"] ?? ""
        };
        SUBJECTS.forEach(s => {
          out[s] = toNum(r[s]);
          out[`${s}컷`] = toNum(r[`${s}컷`] ?? r[`${s} 컷`]);
        });
        return out;
      }).filter(r => r.round); // round 없는 줄 제거
    }

    function renderHeader(m, id){
      const el = document.getElementById("header");
      const name = pickName(m, id);

      el.innerHTML = `
        <div class="title">${name} <span style="opacity:.6;font-weight:800">(${id})</span></div>
        <div class="sub">
          학교: ${m?.school || "-"} · 진로: ${m?.career || "-"} · 전형: ${m?.admission || "-"}
        </div>
        <div style="opacity:.8">데이터 파일: <b>students/scores.json</b> (id=${id})</div>
      `;
    }

    function renderTabs(){
      const el = document.getElementById("tabs");
      const views = [...SUBJECTS, "전체(정규화)"];

      el.innerHTML = views.map(v => `
        <button type="button" data-view="${v}" class="${v===currentView ? "active":""}">
          ${v}
        </button>
      `).join("");

      el.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          currentView = btn.dataset.view;
          renderTabs();
          renderChart();
          renderHint();
        });
      });
    }

    function buildSeries(view){
      const labels = allScores.map(r => `${r.round}회`);

      if (view === "전체(정규화)"){
        // 50점 과목은 x2 해서 100점 스케일로 맞춘 뒤 평균
        const series = allScores.map(r => {
          const vals = SUBJECTS.map(s => {
            const v = r[s];
            if (v == null) return null;
            return (s==="생윤" || s==="사문") ? v*2 : v;
          }).filter(v => v != null);
          return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        });

        const cutSeries = allScores.map(r => {
          const vals = SUBJECTS.map(s => {
            const v = r[`${s}컷`];
            if (v == null) return null;
            return (s==="생윤" || s==="사문") ? v*2 : v;
          }).filter(v => v != null);
          return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        });

        return { labels, series, cutSeries, max: 100, label:"전체(정규화)" };
      }

      const max = MAX_SCORE(view);
      const series = allScores.map(r => r[view] ?? null);
      const cutSeries = allScores.map(r => r[`${view}컷`] ?? null);
      return { labels, series, cutSeries, max, label:view };
    }

    function renderHint(){
      const el = document.getElementById("hint");
      const v = currentView;

      if (v === "전체(정규화)"){
        el.textContent = "※ 전체(정규화): 생윤/사문(50점)을 100점 스케일로 환산(x2)하여 평균. 점선은 1등급 컷(있을 때만 표시).";
        return;
      }

      const max = MAX_SCORE(v);
      // 마지막 회차 컷을 보여주되, 없으면 안내만
      const last = allScores[allScores.length - 1];
      const cut = last?.[`${v}컷`];

      el.textContent = (cut != null)
        ? `만점 ${max}점 · 1등급 컷(점선): ${cut}`
        : `만점 ${max}점 · 1등급 컷 데이터가 없으면 점선이 표시되지 않습니다.`;
    }

    function renderChart(){
      const { labels, series, cutSeries, max, label } = buildSeries(currentView);
      const ctx = document.getElementById("chart");

      if (chartInstance) chartInstance.destroy();

      const hasCut = cutSeries.some(v => v != null);

      const datasets = [
        {
          label: label,
          data: series,
          tension: 0.25
        }
      ];

      if (hasCut){
        datasets.push({
          label: "1등급 컷",
          data: cutSeries,
          tension: 0,
          pointRadius: 0,
          borderDash: [6,6]
        });
      }

      const isMobile = window.matchMedia("(max-width:520px)").matches;

      chartInstance = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode:"index", intersect:false },
          plugins: {
            legend: { position: "bottom" },
            tooltip: { enabled:true }
          },
          scales: {
            y: { beginAtZero:true, suggestedMax: max },
            x: {
              ticks: { autoSkip:true, maxTicksLimit: isMobile ? 5 : 10 }
            }
          }
        }
      });
    }

    function renderTable(){
      const rows = allScores.map(r => `
        <tr>
          <td>${r.round}</td>
          <td>${r.date || "-"}</td>
          ${SUBJECTS.map(s => `<td>${(r[s] ?? "-")}</td>`).join("")}
        </tr>
      `).join("");

      document.getElementById("table").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>회차</th><th>날짜</th>
              <th>국어(100)</th><th>수학(100)</th><th>영어(100)</th><th>생윤(50)</th><th>사문(50)</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function init(){
      const id = getId();
      if(!id){
        document.getElementById("header").textContent = "id가 없습니다. 목록에서 다시 들어오세요.";
        return;
      }

      meta = await loadStudentMeta(id);
      renderHeader(meta, id);

      allScores = (await loadScores(id)).slice().sort((a,b)=>(a.round||0)-(b.round||0));

      if(!allScores.length){
        document.getElementById("table").innerHTML =
          `<div style="opacity:.7">점수 데이터가 없습니다. <b>scores.json</b>에서 id="${id}"가 있는지 확인하세요.</div>`;
        return;
      }

      renderTabs();
      renderHint();
      renderTable();
      renderChart();
    }

    init().catch(err=>{
      document.getElementById("header").textContent =
        "로딩 실패: students.json 또는 scores.json 파일 확인 필요";
      console.error(err);
    });
  </script>
</body>
</html>
